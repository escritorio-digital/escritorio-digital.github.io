import{c as de,u as he,r,j as o,_ as ge,aB as fe,aD as pe,aE as we,R as be,T as me,aF as xe}from"./index-CmQIKd-y.js";import{H as ye,E as ve,S as _e,A as Ce}from"./square-l02uU3D1.js";import{C as je}from"./circle-C8YpJYIF.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Re=[["path",{d:"M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8",key:"1p45f6"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}]],Pe=de("rotate-cw",Re),b="#ff2d2d",m=6,$=()=>({pen:{color:b,size:m,opacity:1},highlighter:{color:"#facc15",size:14,opacity:.2},eraser:{color:b,size:18,opacity:1},line:{color:b,size:m,opacity:1},rectangle:{color:b,size:m,opacity:1},ellipse:{color:b,size:m,opacity:1},arrow:{color:b,size:m,opacity:1}}),J="pen",Se=12,Me=({instanceId:H})=>{const{t:a}=he(),W=r.useRef(H??`screen-annotator-${Date.now()}-${Math.random().toString(16).slice(2)}`),C=H??W.current,j=r.useMemo(()=>`screen-annotator-draft:${C}`,[C]),S=r.useRef(null),d=r.useRef(null),l=r.useRef(null),z=r.useRef(null),T=r.useRef(null),k=r.useRef([]),X=r.useRef(null),g=r.useRef([]),N=r.useRef([]),I=r.useRef(!1),R=r.useRef(1),p=r.useRef(null);if(!p.current)try{const e=window.localStorage.getItem(j);if(e){const t=JSON.parse(e);t&&typeof t=="object"&&(p.current={imageDataUrl:typeof t.imageDataUrl=="string"?t.imageDataUrl:null,tool:t.tool||J,toolSettings:t.toolSettings&&typeof t.toolSettings=="object"?{...$(),...t.toolSettings}:$(),fillShapes:!!t.fillShapes,toolbarPos:t.toolbarPos&&typeof t.toolbarPos.x=="number"&&typeof t.toolbarPos.y=="number"?t.toolbarPos:{x:24,y:24}})}}catch{p.current=null}const[s,G]=r.useState(p.current?.tool??J),[x,E]=r.useState(p.current?.toolSettings??$()),[f,K]=r.useState(p.current?.fillShapes??!1),[y,Q]=r.useState(p.current?.toolbarPos??{x:24,y:24}),[Y,V]=r.useState(!1),L=x[s]??{color:b,size:m,opacity:1},Z=r.useMemo(()=>[{id:"pen",icon:o.jsx(ge,{size:16}),label:a("widgets.screen_annotator.tool_pen")},{id:"highlighter",icon:o.jsx(ye,{size:16}),label:a("widgets.screen_annotator.tool_highlighter")},{id:"eraser",icon:o.jsx(ve,{size:16}),label:a("widgets.screen_annotator.tool_eraser")},{id:"line",icon:o.jsx(fe,{size:16}),label:a("widgets.screen_annotator.tool_line")},{id:"rectangle",icon:o.jsx(_e,{size:16}),label:a("widgets.screen_annotator.tool_rectangle")},{id:"ellipse",icon:o.jsx(je,{size:16}),label:a("widgets.screen_annotator.tool_ellipse")},{id:"arrow",icon:o.jsx(Ce,{size:16}),label:a("widgets.screen_annotator.tool_arrow")}],[a]),v=r.useCallback((e,t)=>{const n=x[t]??{color:b,size:m,opacity:1};e.lineWidth=n.size,e.lineCap="round",e.lineJoin="round",e.strokeStyle=n.color,e.fillStyle=n.color,e.globalAlpha=Math.min(1,Math.max(.05,n.opacity)),t==="eraser"?e.globalCompositeOperation="destination-out":e.globalCompositeOperation="source-over"},[x]),U=r.useCallback(()=>{const e=S.current,t=d.current;if(!e||!t)return;const n=e.getBoundingClientRect(),i=window.devicePixelRatio||1;R.current=i;const u=t.width>0&&t.height>0?t.toDataURL("image/png"):null;t.width=Math.max(1,Math.floor(n.width*i)),t.height=Math.max(1,Math.floor(n.height*i)),t.style.width=`${n.width}px`,t.style.height=`${n.height}px`;const c=t.getContext("2d");if(c&&(c.setTransform(i,0,0,i,0,0),l.current=c,u)){const A=new Image;A.onload=()=>{c.clearRect(0,0,n.width,n.height),c.drawImage(A,0,0,n.width,n.height)},A.src=u}},[]),w=r.useCallback(()=>{const e=d.current,t=l.current;if(!e||!t)return;const n=t.getImageData(0,0,e.width,e.height);g.current.push(n),g.current.length>Se&&g.current.shift(),N.current=[]},[]),h=r.useCallback(()=>{const e=d.current;if(e)try{const n={imageDataUrl:e.toDataURL("image/png"),tool:s,toolSettings:x,fillShapes:f,toolbarPos:y};window.localStorage.setItem(j,JSON.stringify(n))}catch{}},[f,j,y,s,x]),ee=r.useCallback(()=>{const e=d.current,t=l.current;if(!e||!t)return;const n=e.width/R.current,i=e.height/R.current;t.clearRect(0,0,n,i),w(),h()},[h,w]),te=r.useCallback(()=>{const e=d.current,t=l.current;if(!e||!t||g.current.length<=1)return;const n=g.current.pop();n&&N.current.push(n);const i=g.current[g.current.length-1];i&&(t.putImageData(i,0,0),h())},[h]),ne=r.useCallback(()=>{const e=d.current,t=l.current;if(!e||!t)return;const n=N.current.pop();n&&(g.current.push(n),t.putImageData(n,0,0),h())},[h]),B=r.useCallback((e,t,n)=>{const i=Math.atan2(n.y-t.y,n.x-t.x),u=x.arrow??{size:m},c=Math.max(10,u.size*2.5);e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(n.x,n.y),e.moveTo(n.x,n.y),e.lineTo(n.x-c*Math.cos(i-Math.PI/6),n.y-c*Math.sin(i-Math.PI/6)),e.moveTo(n.x,n.y),e.lineTo(n.x-c*Math.cos(i+Math.PI/6),n.y-c*Math.sin(i+Math.PI/6)),e.stroke()},[x]),F=r.useCallback(e=>{const t=l.current,n=X.current,i=z.current;if(!t||!n||!i)return;t.putImageData(i,0,0),t.save(),v(t,s);const u=e.x-n.x,c=e.y-n.y;s==="line"?(t.beginPath(),t.moveTo(n.x,n.y),t.lineTo(e.x,e.y),t.stroke()):s==="rectangle"?(t.beginPath(),t.rect(n.x,n.y,u,c),f&&t.fill(),t.stroke()):s==="ellipse"?(t.beginPath(),t.ellipse(n.x+u/2,n.y+c/2,Math.abs(u/2),Math.abs(c/2),0,0,Math.PI*2),f&&t.fill(),t.stroke()):s==="arrow"&&B(t,n,e),t.restore()},[v,B,f,s]),_=r.useCallback(()=>{const e=l.current,t=T.current,n=k.current;if(!(!e||!t||n.length===0)){e.putImageData(t,0,0),e.save(),v(e,"highlighter"),e.beginPath(),e.moveTo(n[0].x,n[0].y);for(let i=1;i<n.length;i+=1)e.lineTo(n[i].x,n[i].y);e.stroke(),e.restore()}},[v]),D=r.useCallback(e=>{const t=d.current;if(!t)return{x:0,y:0};const n=t.getBoundingClientRect();return{x:e.clientX-n.left,y:e.clientY-n.top}},[]),oe=r.useCallback(e=>{if(e.button!==0)return;const t=d.current,n=l.current;if(!t||!n)return;e.currentTarget.setPointerCapture(e.pointerId);const i=D(e);I.current=!0,X.current=i,s==="pen"||s==="eraser"?(n.save(),v(n,s),n.beginPath(),n.moveTo(i.x,i.y)):s==="highlighter"?(T.current=n.getImageData(0,0,t.width,t.height),k.current=[i],_()):z.current=n.getImageData(0,0,t.width,t.height)},[v,_,D,s]),re=r.useCallback(e=>{if(!I.current)return;const t=l.current;if(!t)return;const n=D(e);s==="pen"||s==="eraser"?(t.lineTo(n.x,n.y),t.stroke()):s==="highlighter"?(k.current.push(n),_()):F(n)},[_,F,D,s]),M=r.useCallback(()=>{if(!I.current)return;const e=l.current;e&&((s==="pen"||s==="eraser")&&(e.closePath(),e.restore()),s==="highlighter"&&(_(),T.current=null,k.current=[]),z.current=null,I.current=!1,w(),h())},[_,h,w,s]),q=r.useCallback(e=>{e.pointerId&&e.currentTarget.hasPointerCapture(e.pointerId)&&e.currentTarget.releasePointerCapture(e.pointerId),M()},[M]),ae=r.useCallback(()=>{M()},[M]);r.useEffect(()=>{U(),g.current.length===0&&w();const e=new ResizeObserver(()=>U());return S.current&&e.observe(S.current),()=>e.disconnect()},[w,U]),r.useEffect(()=>{const e=p.current,t=d.current,n=l.current;if(!e||!e.imageDataUrl||!t||!n)return;const i=new Image;i.onload=()=>{const u=t.width/R.current,c=t.height/R.current;n.clearRect(0,0,u,c),n.drawImage(i,0,0,u,c),w()},i.src=e.imageDataUrl},[w]),r.useEffect(()=>{const e=t=>{const n=t;n.detail?.instanceId===C&&(n.detail?.widgetId&&n.detail.widgetId!=="screen-annotator"||window.localStorage.removeItem(j))};return window.addEventListener("widget-close",e),()=>window.removeEventListener("widget-close",e)},[C,j]);const P=r.useRef(null),O=r.useRef(null),se=e=>{e.preventDefault(),O.current=e.pointerId,P.current={offsetX:e.clientX-y.x,offsetY:e.clientY-y.y},e.currentTarget.setPointerCapture(e.pointerId)};r.useEffect(()=>{const e=n=>{P.current&&Q({x:Math.max(12,n.clientX-P.current.offsetX),y:Math.max(12,n.clientY-P.current.offsetY)})},t=n=>{O.current===n.pointerId&&(O.current=null,P.current=null,h())};return window.addEventListener("pointermove",e),window.addEventListener("pointerup",t),window.addEventListener("pointercancel",t),()=>{window.removeEventListener("pointermove",e),window.removeEventListener("pointerup",t),window.removeEventListener("pointercancel",t)}},[h]);const ie=()=>{window.dispatchEvent(new CustomEvent("widget-close-request",{detail:{instanceId:C}}))},ce=()=>{window.confirm(a("widgets.screen_annotator.clear_confirm"))&&ee()},le=s==="eraser"?"cell":"crosshair",ue=s==="line"||s==="rectangle"||s==="ellipse"||s==="arrow";return o.jsxs("div",{ref:S,className:"screen-annotator-root",children:[o.jsx("canvas",{ref:d,className:"screen-annotator-canvas",style:{cursor:le},onPointerDown:oe,onPointerMove:re,onPointerUp:q,onPointerCancel:q,onPointerLeave:ae}),o.jsxs("div",{className:"screen-annotator-toolbar",style:{left:y.x,top:y.y},children:[o.jsxs("div",{className:"screen-annotator-toolbar-section",children:[o.jsxs("div",{className:"screen-annotator-toolbar-header",children:[o.jsxs("div",{className:"screen-annotator-toolbar-title",children:[o.jsx("button",{type:"button",className:"screen-annotator-handle",title:a("widgets.screen_annotator.toolbar_drag"),"aria-label":a("widgets.screen_annotator.toolbar_drag"),onPointerDown:se,children:o.jsx(pe,{size:16})}),o.jsx("span",{children:a("widgets.screen_annotator.title")})]}),o.jsx("button",{type:"button",className:`screen-annotator-help${Y?" is-active":""}`,onClick:()=>V(e=>!e),title:a("desktop.window_help"),"aria-label":a("desktop.window_help"),children:o.jsx(we,{size:14})})]}),Y&&o.jsx("div",{className:"screen-annotator-help-text",children:a("widgets_help.screen-annotator")}),o.jsx("div",{className:"screen-annotator-toolbar-row tools",children:Z.map(e=>o.jsx("button",{type:"button",className:`screen-annotator-tool ${s===e.id?"is-active":""}`,title:e.label,"aria-label":e.label,onClick:()=>G(e.id),children:e.icon},e.id))})]}),o.jsx("div",{className:"screen-annotator-divider"}),o.jsx("div",{className:"screen-annotator-toolbar-section",children:o.jsxs("div",{className:"screen-annotator-toolbar-row settings",children:[o.jsxs("label",{className:"screen-annotator-field",children:[o.jsx("span",{children:a("widgets.screen_annotator.color_label")}),o.jsx("input",{type:"color",value:L.color,onChange:e=>{const t=e.target.value;E(n=>({...n,[s]:{...n[s],color:t}}))},"aria-label":a("widgets.screen_annotator.color_label")})]}),o.jsxs("label",{className:"screen-annotator-field",children:[o.jsx("span",{children:a("widgets.screen_annotator.size_label")}),o.jsx("input",{type:"range",min:2,max:36,value:L.size,onChange:e=>{const t=Number(e.target.value);E(n=>({...n,[s]:{...n[s],size:t}}))},"aria-label":a("widgets.screen_annotator.size_label")})]}),o.jsxs("label",{className:"screen-annotator-field",children:[o.jsx("span",{children:a("widgets.screen_annotator.opacity_label")}),o.jsx("input",{type:"range",min:5,max:100,step:5,value:Math.round(L.opacity*100),onChange:e=>{const t=Number(e.target.value)/100;E(n=>({...n,[s]:{...n[s],opacity:t}}))},"aria-label":a("widgets.screen_annotator.opacity_label")})]}),o.jsx("button",{type:"button",className:`screen-annotator-toggle ${f?"is-active":""}`,onClick:()=>K(e=>!e),disabled:!ue,title:a(f?"widgets.screen_annotator.fill_on":"widgets.screen_annotator.fill_off"),"aria-label":a(f?"widgets.screen_annotator.fill_on":"widgets.screen_annotator.fill_off"),children:a(f?"widgets.screen_annotator.fill_on":"widgets.screen_annotator.fill_off")})]})}),o.jsx("div",{className:"screen-annotator-divider"}),o.jsx("div",{className:"screen-annotator-toolbar-section",children:o.jsxs("div",{className:"screen-annotator-toolbar-row actions",children:[o.jsx("button",{type:"button",className:"screen-annotator-action",onClick:te,title:a("widgets.screen_annotator.undo"),"aria-label":a("widgets.screen_annotator.undo"),children:o.jsx(be,{size:16})}),o.jsx("button",{type:"button",className:"screen-annotator-action",onClick:ne,title:a("widgets.screen_annotator.redo"),"aria-label":a("widgets.screen_annotator.redo"),children:o.jsx(Pe,{size:16})}),o.jsx("button",{type:"button",className:"screen-annotator-action",onClick:ce,title:a("widgets.screen_annotator.clear"),"aria-label":a("widgets.screen_annotator.clear"),children:o.jsx(me,{size:16})}),o.jsx("button",{type:"button",className:"screen-annotator-action screen-annotator-close",onClick:ie,title:a("widgets.screen_annotator.close"),"aria-label":a("widgets.screen_annotator.close"),children:o.jsx(xe,{size:16})})]})})]})]})};export{Me as ScreenAnnotatorWidget};
