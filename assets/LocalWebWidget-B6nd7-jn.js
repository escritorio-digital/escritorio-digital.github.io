import{u as xe,r as w,j as n,R as ve,T as je,a1 as Ee,g as _e,a2 as Se}from"./index-DoY3sTps.js";import{a3 as He}from"./index-DoY3sTps.js";import{r as Ne}from"./openDialog-H-OCpcqq.js";import{a as We,C as ke}from"./chevron-right-BQyN_PM6.js";import{C as Ce}from"./cloud-upload-DORJTNZ8.js";import{E as Ae}from"./eye-BlHo_EnW.js";const Le="escritorio-digital-sites",Re=1,R="sites",L="files",oe="active-profile-name",te="active-profile-change",ae="Escritorio Principal";let H=null;const T=()=>(H||(H=new Promise((e,s)=>{const a=window.indexedDB.open(Le,Re);a.onupgradeneeded=()=>{const o=a.result;o.objectStoreNames.contains(R)||o.createObjectStore(R,{keyPath:"id"}),o.objectStoreNames.contains(L)||o.createObjectStore(L,{keyPath:"key"}).createIndex("siteId","siteId",{unique:!1})},a.onsuccess=()=>e(a.result),a.onerror=()=>s(a.error)})),H),se=()=>{const e=window.localStorage.getItem(oe);if(!e)return ae;try{const s=JSON.parse(e);return typeof s=="string"&&s.trim()?s:e}catch{return e}},J=async(e,s,a)=>{const o=await T();return new Promise((u,c)=>{const m=o.transaction(e,s).objectStore(e),_=a(m);_.onsuccess=()=>u(_.result),_.onerror=()=>c(_.error)})},Ie=async(e,s)=>{const a=s.filter(o=>!o.profileName);a.length!==0&&await J(R,"readwrite",o=>(a.forEach(u=>{o.put({...u,profileName:e})}),o.getAll()))},Pe=async e=>{const a=await J(R,"readonly",o=>o.getAll())??[];return a.some(o=>!o.profileName)?(await Ie(e,a),a.map(o=>({...o,profileName:o.profileName??e})).filter(o=>o.profileName===e)):a.filter(o=>o.profileName===e)},Y=async e=>{await J(R,"readwrite",s=>s.put(e))},Be=async e=>{const s=await T();await new Promise((a,o)=>{const u=s.transaction([R,L],"readwrite");u.objectStore(R).delete(e);const c=u.objectStore(L),m=c.index("siteId").getAllKeys(IDBKeyRange.only(e));m.onsuccess=()=>{m.result.forEach(I=>c.delete(I))},u.oncomplete=()=>a(),u.onerror=()=>o(u.error)})},Oe=async e=>{const s=await T();return new Promise((a,o)=>{const m=s.transaction(L,"readonly").objectStore(L).index("siteId").getAll(IDBKeyRange.only(e));m.onsuccess=()=>a(m.result??[]),m.onerror=()=>o(m.error)})},ne=async e=>{if(e.length===0)return;const s=await T();await new Promise((a,o)=>{const u=s.transaction(L,"readwrite"),c=u.objectStore(L);e.forEach(d=>c.put(d)),u.oncomplete=()=>a(),u.onerror=()=>o(u.error)})},re=e=>{const s=e.toLowerCase();return s.endsWith(".html")||s.endsWith(".htm")?"text/html":s.endsWith(".css")?"text/css":s.endsWith(".js")?"text/javascript":s.endsWith(".json")?"application/json":s.endsWith(".svg")?"image/svg+xml":s.endsWith(".png")?"image/png":s.endsWith(".jpg")||s.endsWith(".jpeg")?"image/jpeg":s.endsWith(".webp")?"image/webp":s.endsWith(".gif")?"image/gif":s.endsWith(".woff")?"font/woff":s.endsWith(".woff2")?"font/woff2":s.endsWith(".ttf")?"font/ttf":s.endsWith(".otf")?"font/otf":s.endsWith(".ico")?"image/x-icon":"application/octet-stream"},A=e=>e.replace(/\\/g,"/").replace(/^\.?\//,""),G=(e,s)=>{if(s.startsWith("/"))return A(s.slice(1));const a=A(e).split("/");a.pop();const o=s.split("/"),u=[...a,...o],c=[];return u.forEach(d=>{!d||d==="."||(d===".."?c.pop():c.push(d))}),c.join("/")},ie=(e,s,a)=>e.replace(/url\(([^)]+)\)/g,(o,u)=>{const c=String(u).trim().replace(/^['"]|['"]$/g,"");if(c.startsWith("data:")||c.startsWith("http:")||c.startsWith("https:")||c.startsWith("blob:")||c.startsWith("#"))return o;const d=G(s,c),m=a.get(d);return m?`url("${m}")`:o}),Ue=(e,s,a,o)=>{const c=new DOMParser().parseFromString(e,"text/html"),d=(y,S)=>{Array.from(c.querySelectorAll(y)).forEach(E=>{const h=E.getAttribute(S);if(!h||h.startsWith("http:")||h.startsWith("https:")||h.startsWith("data:")||h.startsWith("blob:")||h.startsWith("#")||h.startsWith("mailto:"))return;const v=G(s,h),x=(S==="href"?o.get(v):null)||a.get(v);x&&E.setAttribute(S,x)})},m=y=>y.split(",").map(E=>E.trim()).filter(Boolean).map(E=>{const h=E.split(/\s+/),v=h[0];if(v.startsWith("http:")||v.startsWith("https:")||v.startsWith("data:")||v.startsWith("blob:")||v.startsWith("#")||v.startsWith("mailto:"))return E;const x=G(s,v),N=a.get(x);return N?(h[0]=N,h.join(" ")):E}).join(", ");return d("img[src]","src"),d("script[src]","src"),d("link[href]","href"),d("source[src]","src"),d("video[src]","src"),d("audio[src]","src"),d("iframe[src]","src"),d("a[href]","href"),d("form[action]","action"),Array.from(c.querySelectorAll("img[srcset], source[srcset]")).forEach(y=>{const S=y.getAttribute("srcset");S&&y.setAttribute("srcset",m(S))}),Array.from(c.querySelectorAll("style")).forEach(y=>{y.textContent&&(y.textContent=ie(y.textContent,s,a))}),`<!DOCTYPE html>${c.documentElement.outerHTML}`},M=e=>{if(!Number.isFinite(e))return"0 B";if(e<1024)return`${e} B`;const s=e/1024;if(s<1024)return`${s.toFixed(1)} KB`;const a=s/1024;return a<1024?`${a.toFixed(1)} MB`:`${(a/1024).toFixed(2)} GB`},$e=async()=>{if(!navigator.storage||!navigator.storage.estimate)return{usage:null,quota:null};const e=await navigator.storage.estimate();return{usage:typeof e.usage=="number"?e.usage:null,quota:typeof e.quota=="number"?e.quota:null}},De=()=>{const{t:e}=xe(),[s,a]=w.useState([]),[o,u]=w.useState(null),[c,d]=w.useState(()=>se()),[m,_]=w.useState(null),[I,y]=w.useState(""),[S,U]=w.useState(null),[E,h]=w.useState(""),[v,x]=w.useState(""),[N,ce]=w.useState({usage:null,quota:null}),[$,le]=w.useState(!1),q=w.useRef(null),W=w.useRef([]),z=w.useRef(!1),B=async t=>{const r=await Pe(t);r.sort((i,l)=>l.updatedAt-i.updatedAt),a(r)},O=async()=>{const t=await $e();ce(t)},D=()=>{window.dispatchEvent(new Event("storage-usage-changed"))};w.useEffect(()=>{const t=q.current;t&&(t.webkitdirectory=!0,t.setAttribute("webkitdirectory",""),t.setAttribute("directory",""))},[]),w.useEffect(()=>{const t=i=>{const l=i.detail;d(l?.name||se())},r=i=>{if(i.key===oe){if(!i.newValue){d(ae);return}try{const l=JSON.parse(i.newValue);d(typeof l=="string"&&l.trim()?l:i.newValue)}catch{d(i.newValue)}}};return window.addEventListener(te,t),window.addEventListener("storage",r),()=>{window.removeEventListener(te,t),window.removeEventListener("storage",r)}},[]),w.useEffect(()=>{B(c),O(),V()},[c]),w.useEffect(()=>{const t=()=>{B(c),O()};return window.addEventListener("local-web-data-changed",t),()=>{window.removeEventListener("local-web-data-changed",t)}},[c]),w.useEffect(()=>()=>{W.current.forEach(t=>URL.revokeObjectURL(t)),W.current=[]},[]);const de=w.useMemo(()=>{const{usage:t,quota:r}=N;if(t!=null&&r!=null){const i=Math.min(100,Math.round(t/r*100));return e("widgets.local_web.storage_usage",{used:M(t),total:M(r),percent:i})}return t!=null?e("widgets.local_web.storage_used",{used:M(t)}):e("widgets.local_web.storage_unknown")},[N,e]),ue=w.useMemo(()=>{const{usage:t,quota:r}=N;if(t==null||r==null)return"local-web-storage-neutral";const i=t/r;return i<.7?"local-web-storage-ok":i<.85?"local-web-storage-warn":"local-web-storage-danger"},[N]),Z=w.useMemo(()=>{const{usage:t,quota:r}=N;return t==null||r==null?null:Math.min(100,Math.max(0,Math.round(t/r*100)))},[N]),V=()=>{u(null),_(null),y(""),W.current.forEach(t=>URL.revokeObjectURL(t)),W.current=[]},we=()=>{if(!m)return;const t=window.screen.width,r=window.screen.height,i=window.open("","_blank",`popup=1,width=${t},height=${r},left=0,top=0`);if(!i)return;const l=I.replace(/</g,"&lt;").replace(/>/g,"&gt;");i.document.write(`<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>${l}</title>
    <style>
      html, body { margin: 0; padding: 0; height: 100%; }
      body { display: flex; flex-direction: column; font-family: sans-serif; }
      header { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: #f5f5f5; border-bottom: 1px solid #e0e0e0; transition: opacity 0.3s; }
      header.hidden { display: none; }
      button { border: 1px solid #ccc; background: #fff; padding: 6px 10px; border-radius: 6px; cursor: pointer; }
      iframe { flex: 1; border: 0; width: 100%; }
    </style>
  </head>
  <body>
    <header>
      <span>${l}</span>
      <div>
        <button id="fullscreen">${e("widgets.local_web.open_fullscreen_button")}</button>
        <button id="close">${e("widgets.local_web.close_window_button")}</button>
      </div>
    </header>
    <iframe src="${m}" title="${l}"></iframe>
    <script>
      const fullBtn = document.getElementById('fullscreen');
      const closeBtn = document.getElementById('close');
      const header = document.querySelector('header');

      fullBtn.addEventListener('click', () => {
        const root = document.documentElement;
        if (root.requestFullscreen) root.requestFullscreen();
      });

      closeBtn.addEventListener('click', () => window.close());

      document.addEventListener('fullscreenchange', () => {
        if (document.fullscreenElement) {
          header.classList.add('hidden');
        } else {
          header.classList.remove('hidden');
        }
      });
    <\/script>
  </body>
</html>`),i.document.close(),i.focus()},X=async t=>{if(!window.confirm(e("widgets.local_web.confirm_extract",{name:t.name})))return;x(e("widgets.local_web.importing"));const i=await t.arrayBuffer(),l=Se(new Uint8Array(i)),f=[];if(Object.keys(l).forEach(b=>{if(b.endsWith("/")||b.startsWith("__MACOSX/"))return;const P=A(b),F=l[b],p=re(P),C=new Blob([F],{type:p});f.push({key:"",siteId:"",path:P,blob:C,size:C.size,type:p})}),f.length===0){x(e("widgets.local_web.import_empty"));return}const j=crypto.randomUUID(),g=Date.now(),k={id:j,name:t.name.replace(/\.zip$/i,""),profileName:c,createdAt:g,updatedAt:g,fileCount:f.length,totalBytes:f.reduce((b,P)=>b+P.size,0)};f.forEach(b=>{b.siteId=j,b.key=`${j}::${b.path}`}),await Y(k),await ne(f),x(e("widgets.local_web.import_done")),await B(c),await O(),D()},me=async t=>{if(!t.length)return;x(e("widgets.local_web.importing"));const r=crypto.randomUUID(),i=Date.now(),l=[];Array.from(t).forEach(g=>{const k=A(g.webkitRelativePath||g.name),b=g.slice(0,g.size,g.type||re(k));l.push({key:`${r}::${k}`,siteId:r,path:k,blob:b,size:b.size,type:b.type})});const f=t[0].webkitRelativePath?.split("/")[0]||t[0].name,j={id:r,name:f,profileName:c,createdAt:i,updatedAt:i,fileCount:l.length,totalBytes:l.reduce((g,k)=>g+k.size,0)};await Y(j),await ne(l),x(e("widgets.local_web.import_done")),await B(c),await O(),D()},fe=async t=>{x(e("widgets.local_web.loading"));const r=await Oe(t.id),i=new Map;r.forEach(p=>i.set(A(p.path),p));const l=r.find(p=>p.path.toLowerCase().endsWith("index.html"))?.path||r.find(p=>p.path.toLowerCase().endsWith("index.htm"))?.path||"";if(!l){x(e("widgets.local_web.missing_index"));return}W.current.forEach(p=>URL.revokeObjectURL(p)),W.current=[];const f=new Map;r.forEach(p=>{const C=URL.createObjectURL(p.blob);W.current.push(C),f.set(A(p.path),C)});const j=new Map;for(const p of r.filter(C=>C.path.toLowerCase().endsWith(".css")))try{const C=await p.blob.text(),ge=ie(C,p.path,f),ye=new Blob([ge],{type:"text/css"}),ee=URL.createObjectURL(ye);W.current.push(ee),j.set(A(p.path),ee)}catch{}const g=i.get(A(l));if(!g){x(e("widgets.local_web.missing_index"));return}const k=await g.blob.text(),b=Ue(k,l,f,j),P=new Blob([b],{type:"text/html"}),F=URL.createObjectURL(P);W.current.push(F),y(t.name),_(F),u(t.id),x("")},K=()=>{U(null),h("")},Q=async t=>{const r=E.trim();if(!r){alert(e("widgets.local_web.rename_invalid"));return}if(r===t.name){K();return}const i={...t,name:r,updatedAt:Date.now()};await Y(i),a(l=>{const f=l.map(j=>j.id===t.id?i:j);return f.sort((j,g)=>g.updatedAt-j.updatedAt),f}),o===t.id&&y(r),K()},pe=async()=>{const t=await Ne({accept:".zip"});if(!t)return;if(t.source==="local"){const[f]=t.files;f&&await X(f);return}const[r]=t.entryIds;if(!r)return;const i=await _e(r);if(!i?.blob)return;const l=new File([i.blob],i.name,{type:i.mime||i.blob.type});await X(l)},he=async t=>{t.target.files&&(await me(t.target.files),t.target.value="")},be=async t=>{window.confirm(e("widgets.local_web.confirm_delete"))&&(o===t&&V(),await Be(t),await B(c),await O(),D())};return n.jsxs("div",{className:"local-web-widget",children:[n.jsxs("div",{className:"local-web-header",children:[n.jsxs("div",{className:"local-web-title",children:[n.jsx(ve,{size:18}),n.jsx("span",{children:e("widgets.local_web.title")})]}),n.jsx("div",{className:"local-web-description",children:e("widgets.local_web.description")}),n.jsxs("div",{className:"local-web-actions",children:[n.jsxs("button",{className:"local-web-button local-web-button-secondary",onClick:()=>le(t=>!t),children:[$?n.jsx(We,{size:16}):n.jsx(ke,{size:16}),e($?"widgets.local_web.expand_list":"widgets.local_web.collapse_list")]}),n.jsxs("button",{className:"local-web-button",onClick:pe,children:[n.jsx(Ce,{size:16}),e("widgets.local_web.import_zip")]}),n.jsx("button",{className:"local-web-button",onClick:()=>q.current?.click(),children:e("widgets.local_web.import_folder")})]})]}),n.jsxs("div",{className:`local-web-storage ${ue}`,children:[n.jsx("div",{className:"local-web-storage-text",children:de}),Z!==null&&n.jsx("div",{className:"local-web-storage-bar",children:n.jsx("div",{className:"local-web-storage-bar-fill",style:{width:`${Z}%`}})})]}),n.jsxs("div",{className:`local-web-body${$?" local-web-body-collapsed":""}`,children:[n.jsxs("div",{className:`local-web-list${$?" local-web-list-collapsed":""}`,children:[v&&n.jsx("div",{className:"local-web-status",children:v}),s.length===0&&n.jsx("div",{className:"local-web-empty",children:e("widgets.local_web.empty_state")}),s.map(t=>n.jsxs("div",{className:"local-web-site",children:[n.jsxs("div",{className:"local-web-site-info",children:[S===t.id?n.jsx("input",{type:"text",value:E,onChange:r=>h(r.target.value),onBlur:()=>{if(z.current){z.current=!1;return}Q(t)},onKeyDown:r=>{r.key==="Enter"&&(z.current=!0,Q(t)),r.key==="Escape"&&(z.current=!0,K())},placeholder:e("widgets.local_web.rename_placeholder"),className:"local-web-site-name-input",autoFocus:!0}):n.jsx("div",{className:"local-web-site-name local-web-site-name-editable",onDoubleClick:()=>{U(t.id),h(t.name)},children:t.name}),n.jsx("div",{className:"local-web-site-meta",children:e("widgets.local_web.site_meta",{files:t.fileCount,size:M(t.totalBytes)})})]}),n.jsxs("div",{className:"local-web-site-actions",children:[n.jsx("button",{className:"local-web-icon-button",onClick:()=>fe(t),children:n.jsx(Ae,{size:16})}),n.jsx("button",{className:"local-web-icon-button local-web-delete",onClick:()=>be(t.id),children:n.jsx(je,{size:16})})]})]},t.id))]}),n.jsx("div",{className:"local-web-preview",children:m?n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"local-web-preview-header",children:[n.jsx("span",{children:I}),n.jsxs("div",{className:"local-web-preview-actions",children:[n.jsxs("button",{className:"local-web-button local-web-button-secondary",onClick:we,children:[n.jsx(Ee,{size:14}),e("widgets.local_web.open_fullscreen_window")]}),n.jsx("button",{className:"local-web-button local-web-button-secondary",onClick:V,children:e("widgets.local_web.close_preview")})]})]}),n.jsx("iframe",{className:"local-web-iframe",src:m,title:I,sandbox:"allow-scripts allow-same-origin allow-forms"})]}):n.jsx("div",{className:"local-web-preview-placeholder",children:e("widgets.local_web.preview_placeholder")})})]}),n.jsx("input",{ref:q,type:"file",className:"hidden",onChange:he})]})};export{De as LocalWebWidget,He as widgetConfig};
