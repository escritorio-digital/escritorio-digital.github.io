import{c as C,u as ut,r as d,s as mt,j as e,a6 as wt,F as pt,V as xt,g as Y}from"./index-DB1LVOJU.js";import{a7 as ie}from"./index-DB1LVOJU.js";import{d as ht}from"./marked.esm-IrHqQMcX.js";import{k as ft}from"./katex.min-2TduxwG8.js";import{r as kt,s as gt,d as _t}from"./saveDialog-DItMqXCA.js";import{r as bt}from"./openDialog-H-OCpcqq.js";import{B as yt,I as vt,S as jt,H as Et,a as Ct,b as $t,L as St,c as Nt,T as It,Z as zt,d as Tt,C as Mt}from"./zoom-out-C_r_A-Z8.js";import{C as Lt}from"./code-UQ9zG23S.js";import{E as Ft}from"./eye-CUWQT6Lm.js";import{S as Ot}from"./save-DEjIiajv.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rt=[["path",{d:"m18 16 4-4-4-4",key:"1inbqp"}],["path",{d:"m6 8-4 4 4 4",key:"15zrgr"}],["path",{d:"m14.5 4-5 16",key:"e7oirm"}]],Ht=C("code-xml",Rt);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qt=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M12 3v18",key:"108xh3"}]],Dt=C("columns-2",qt);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vt=[["path",{d:"M4 22h14a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v4",key:"1pf5j1"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"m5 12-3 3 3 3",key:"oke12k"}],["path",{d:"m9 18 3-3-3-3",key:"112psh"}]],At=C("file-code-2",Vt);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bt=[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]],Pt=C("link-2",Bt);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wt=[["path",{d:"M16 3a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2 1 1 0 0 1 1 1v1a2 2 0 0 1-2 2 1 1 0 0 0-1 1v2a1 1 0 0 0 1 1 6 6 0 0 0 6-6V5a2 2 0 0 0-2-2z",key:"rib7q0"}],["path",{d:"M5 3a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2 1 1 0 0 1 1 1v1a2 2 0 0 1-2 2 1 1 0 0 0-1 1v2a1 1 0 0 0 1 1 6 6 0 0 0 6-6V5a2 2 0 0 0-2-2z",key:"1ymkrd"}]],Zt=C("quote",Wt),tt="https://edicuatex.github.io";function J($,s,R={}){const v=[],g=(l,m)=>{const S=ft.renderToString(l.trim(),{throwOnError:!1,displayMode:m,output:R.katexOutput}),h=`%%MATH_${v.length}%%`;return v.push({token:h,html:S}),h};let c=s;c=c.replace(/\\\[((?:.|\n)+?)\\\]/g,(l,m)=>g(m,!0)),c=c.replace(/\$\$([\s\S]+?)\$\$/g,(l,m)=>g(m,!0)),c=c.replace(/\\\((.+?)\\\)/g,(l,m)=>g(m,!1)),c=c.replace(/\$([\s\S]+?)\$/g,(l,m)=>g(m,!1));let r=ht.parse(c);v.forEach(({token:l,html:m})=>{r=r.replace(l,m)}),$.innerHTML=r}const ne=({instanceId:$})=>{const{t:s,i18n:R,ready:v}=ut(),g=d.useRef($??`markdown-text-editor-${Date.now()}-${Math.random().toString(16).slice(2)}`),c=$??g.current,[r,l]=d.useState(s("widgets.markdown_text_editor.sample_content")),[m,S]=d.useState(""),[h,N]=d.useState(""),[I,H]=d.useState("split"),[_,et]=d.useState(1),[q,z]=d.useState(!1),[D,K]=d.useState("100"),k=d.useRef(null),[nt,V]=d.useState(null),w=d.useRef(null),U=d.useRef(null),A=d.useRef(null),f=d.useRef(null),ot=d.useMemo(()=>{const t=new URL(`${tt}/index.html`);return t.searchParams.set("pm","1"),t.searchParams.set("origin",window.location.origin),t},[]);d.useEffect(()=>{const t=s("widgets.markdown_text_editor.sample_content");t!=="widgets.markdown_text_editor.sample_content"&&l(t)},[s,R.language]),d.useEffect(()=>{const t=A.current;if(t)return document.body.appendChild(t),()=>{t.parentNode&&t.parentNode.removeChild(t)}},[]);const j=t=>{S(t),setTimeout(()=>S(""),1800)},E=t=>{const n=Math.min(5,Math.max(.75,t));et(n)};d.useEffect(()=>{q||K(`${Math.round(_*100)}`)},[_,q]);const b=(t,n)=>{const o=w.current;o&&requestAnimationFrame(()=>{o.focus(),o.setSelectionRange(t,n)})},T=(t,n,o)=>{const a=w.current;if(!a)return;const i=a.selectionStart,u=a.selectionEnd,x=r.slice(i,u)||o,y=`${r.slice(0,i)}${t}${x}${n}${r.slice(u)}`;l(y),b(i+t.length,i+t.length+x.length)},B=t=>{const n=w.current;if(!n)return;const o=n.selectionStart,a=n.selectionEnd,i=r,u=i.lastIndexOf(`
`,o-1)+1,p=i.indexOf(`
`,a),x=p===-1?i.length:p,Z=i.slice(u,x).split(`
`),M=Z.every(O=>O.startsWith(t)),L=Z.map(O=>M?O.slice(t.length):`${t}${O}`).join(`
`),F=`${i.slice(0,u)}${L}${i.slice(x)}`;l(F);const Q=u+L.length;b(Q,Q)},P=t=>{const n=`${"#".repeat(t)} `,o=w.current;if(!o)return;const a=o.selectionStart,i=r,u=i.lastIndexOf(`
`,a-1)+1,p=i.indexOf(`
`,a),x=p===-1?i.length:p,y=i.slice(u,x),M=y.startsWith(n)?y.slice(n.length):`${n}${y}`,L=`${i.slice(0,u)}${M}${i.slice(x)}`;l(L);const F=u+M.length;b(F,F)},st=()=>{const t=w.current;if(!t)return;const n=t.selectionStart,o=t.selectionEnd,a=r.slice(n,o)||s("widgets.markdown_text_editor.placeholders.code"),i="```\n",p=`${r.slice(0,n)}${i}${a}
\`\`\`${r.slice(o)}`;l(p),b(n+i.length,n+i.length+a.length)},it=()=>{const t=w.current;if(!t)return;const n=t.selectionStart,o=t.selectionEnd,a=r.slice(n,o)||s("widgets.markdown_text_editor.placeholders.link_text"),i=window.prompt(s("widgets.markdown_text_editor.prompts.link_url"));if(!i)return;const u=`[${a}](${i})`,p=`${r.slice(0,n)}${u}${r.slice(o)}`;l(p),b(n+1,n+1+a.length)},X=d.useCallback(t=>{const n=w.current;if(!n)return;const o=n.selectionStart,a=n.selectionEnd;l(i=>`${i.slice(0,o)}${t}${i.slice(a)}`),b(o+t.length,o+t.length)},[]),rt=()=>{navigator.clipboard.writeText(r).then(()=>j(s("widgets.markdown_text_editor.source_copied"))).catch(()=>j(s("widgets.markdown_text_editor.copy_failed")))},at=()=>{const t=document.createElement("div");try{J(t,r,{katexOutput:"html"})}catch(i){const u=i instanceof Error?i.message:s("widgets.markdown_text_editor.preview_error");t.innerHTML=`<div class="error-message">${u}</div>`}const o=(()=>{let i="";for(const u of Array.from(document.styleSheets))try{const p=Array.from(u.cssRules||[]);for(const x of p)x.cssText.includes(".katex")&&(i+=x.cssText)}catch{}return i.trim()})(),a=o?`<style>${o}</style>${t.innerHTML}`:t.innerHTML;navigator.clipboard.writeText(a).then(()=>j(s("widgets.markdown_text_editor.html_copied"))).catch(()=>j(s("widgets.markdown_text_editor.copy_failed")))},W=async()=>{const t=new Blob([r],{type:"text/markdown;charset=utf-8"}),n=nt||s("widgets.markdown_text_editor.default_filename"),o=await kt(n);if(!o)return;o?.destination==="file-manager"?await gt({blob:t,filename:o.filename,sourceWidgetId:"markdown-text-editor",sourceWidgetTitleKey:"widgets.markdown_text_editor.title",parentId:o.parentId}):o?.destination==="download"&&_t(t,o.filename),window.dispatchEvent(new CustomEvent("widget-title-update",{detail:{instanceId:c,title:o.filename}})),V(o.filename),window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:c,widgetId:"markdown-text-editor",isDirty:!1}}));const a=JSON.stringify({input:r});N(a),window.dispatchEvent(new CustomEvent("widget-save-complete",{detail:{instanceId:c,widgetId:"markdown-text-editor"}}))},G=async t=>{const n=await t.text();l(n),N(JSON.stringify({input:n})),window.dispatchEvent(new CustomEvent("widget-title-update",{detail:{instanceId:c,title:t.name}})),V(t.name),window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:c,widgetId:"markdown-text-editor",isDirty:!1}}))},dt=async()=>{const t=await bt({accept:".md,.txt"});if(!t)return;if(t.source==="local"){const[i]=t.files;i&&await G(i);return}const[n]=t.entryIds;if(!n)return;const o=await Y(n);if(!o?.blob)return;const a=new File([o.blob],o.name,{type:o.mime||o.blob.type});await G(a)},ct=async()=>{const t=A.current;if(!t)return;J(t,r);try{await document.fonts?.ready}catch{}await new Promise(o=>requestAnimationFrame(()=>o()));const n=()=>{t.innerHTML="",window.removeEventListener("afterprint",n)};window.addEventListener("afterprint",n),window.print()},lt=()=>{const t=w.current?w.current.value.slice(w.current.selectionStart,w.current.selectionEnd).trim():"",n=new URL(ot.toString());if(t&&n.searchParams.set("sel",t),f.current&&!f.current.closed){f.current.focus();return}const o=window.open(n.toString(),"edicuatex","width=1100,height=800,menubar=no,toolbar=no,location=no,status=no");if(!o){j(s("widgets.markdown_text_editor.popup_blocked"));return}f.current=o};return d.useEffect(()=>{const t=n=>{if(n.origin!==tt||!n.data||n.data.type!=="edicuatex:result")return;const o=n.data,a=o.latex?`$$${o.latex}$$`:"",i=o.wrapped||a;i&&(X(i),f.current&&!f.current.closed&&f.current.close(),f.current=null)};return window.addEventListener("message",t),()=>window.removeEventListener("message",t)},[X]),d.useEffect(()=>{const t=U.current;if(t)try{J(t,r)}catch(n){const o=n instanceof Error?n.message:s("widgets.markdown_text_editor.preview_error");t.innerHTML=`<div class="error-message">${o}</div>`}},[r,s]),d.useEffect(()=>{h||N(JSON.stringify({input:r}))},[r,h]),d.useEffect(()=>mt("markdown-text-editor",async({entryId:n})=>{const o=await Y(n);if(!o?.blob)return;const a=await o.blob.text();l(a),N(JSON.stringify({input:a})),window.dispatchEvent(new CustomEvent("widget-title-update",{detail:{instanceId:c,title:o.name}})),V(o.name),window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:c,widgetId:"markdown-text-editor",isDirty:!1}}))}),[]),d.useEffect(()=>{const t=JSON.stringify({input:r}),n=h!==""&&t!==h;window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:c,widgetId:"markdown-text-editor",isDirty:n}}))},[r,h,c]),d.useEffect(()=>{const t=n=>{const o=n;o.detail?.instanceId===c&&(o.detail?.widgetId&&o.detail.widgetId!=="markdown-text-editor"||W())};return window.addEventListener("widget-save-request",t),()=>window.removeEventListener("widget-save-request",t)},[W,c]),d.useEffect(()=>()=>{window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:c,widgetId:"markdown-text-editor",isDirty:!1}}))},[c]),v?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`markdown-text-editor-widget view-${I}`,style:{"--md-zoom":_},children:[e.jsxs("div",{className:"markdown-toolbar",children:[e.jsxs("div",{className:"markdown-toolbar-group",children:[e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.bold"),onClick:()=>T("**","**",s("widgets.markdown_text_editor.placeholders.text")),children:e.jsx(yt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.italic"),onClick:()=>T("*","*",s("widgets.markdown_text_editor.placeholders.text")),children:e.jsx(vt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.strike"),onClick:()=>T("~~","~~",s("widgets.markdown_text_editor.placeholders.text")),children:e.jsx(jt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.h1"),onClick:()=>P(1),children:e.jsx(Et,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.h2"),onClick:()=>P(2),children:e.jsx(Ct,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.h3"),onClick:()=>P(3),children:e.jsx($t,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.bullet_list"),onClick:()=>B("- "),children:e.jsx(St,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.ordered_list"),onClick:()=>B("1. "),children:e.jsx(Nt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.quote"),onClick:()=>B("> "),children:e.jsx(Zt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.inline_code"),onClick:()=>T("`","`",s("widgets.markdown_text_editor.placeholders.code")),children:e.jsx(Lt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.code_block"),onClick:st,children:e.jsx(Ht,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.link"),onClick:it,children:e.jsx(Pt,{size:16})})]}),e.jsxs("div",{className:"markdown-toolbar-group",children:[m&&e.jsx("span",{className:"feedback-message",children:m}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.view_split"),onClick:()=>H("split"),className:I==="split"?"is-active":"",children:e.jsx(Dt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.view_editor"),onClick:()=>H("editor"),className:I==="editor"?"is-active":"",children:e.jsx(It,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.view_preview"),onClick:()=>H("preview"),className:I==="preview"?"is-active":"",children:e.jsx(Ft,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.zoom_out"),onClick:()=>E(_-.1),children:e.jsx(zt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.zoom_in"),onClick:()=>E(_+.1),children:e.jsx(Tt,{size:16})}),q?e.jsx("input",{type:"number",min:75,max:500,step:1,value:D,onChange:t=>K(t.target.value),onBlur:()=>{const t=Number.parseFloat(D);Number.isNaN(t)||E(t/100),z(!1)},onKeyDown:t=>{if(t.key==="Enter"){const n=Number.parseFloat(D);Number.isNaN(n)||E(n/100),z(!1)}t.key==="Escape"&&z(!1)},className:"zoom-input",title:s("widgets.markdown_text_editor.toolbar.zoom_reset")}):e.jsxs("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.zoom_edit_hint"),onClick:()=>{k.current&&window.clearTimeout(k.current),k.current=window.setTimeout(()=>{E(1),k.current=null},200)},onDoubleClick:()=>{k.current&&(window.clearTimeout(k.current),k.current=null),z(!0)},className:"zoom-reset",children:[Math.round(_*100),"%"]}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.formula"),onClick:lt,children:e.jsx(wt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.copy_source"),onClick:rt,children:e.jsx(Mt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.copy_html"),onClick:at,children:e.jsx(At,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.open_file"),onClick:dt,children:e.jsx(pt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.save_file"),onClick:W,children:e.jsx(Ot,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.export_pdf"),onClick:ct,children:e.jsx(xt,{size:16})})]})]}),e.jsxs("div",{className:"markdown-body",children:[e.jsxs("div",{className:"markdown-pane markdown-editor-pane",children:[e.jsx("div",{className:"markdown-pane-header",children:s("widgets.markdown_text_editor.editor_title")}),e.jsx("textarea",{ref:w,value:r,onChange:t=>l(t.target.value),spellCheck:!0,className:"editor-textarea"})]}),e.jsxs("div",{className:"markdown-pane markdown-preview-pane",children:[e.jsx("div",{className:"markdown-pane-header",children:s("widgets.markdown_text_editor.preview_title")}),e.jsx("div",{className:"preview-pane prose",ref:U})]})]})]}),e.jsx("div",{id:"markdown-text-editor-print",ref:A,className:"prose"})]}):e.jsx("div",{className:"flex items-center justify-center h-full",children:s("loading")})};export{ne as MarkdownTextEditorWidget,ie as widgetConfig};
