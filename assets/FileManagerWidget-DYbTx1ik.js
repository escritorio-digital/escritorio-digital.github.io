import{c as x,u as me,r as l,F as j,a as ue,y as U,z as fe,A as ge,B as he,j as t,C as pe,T as v,G as we,D as xe,H as ye,J as D,g as _e,K as be,L,M as je,N as K,O as Ne,P as ke}from"./index-B15WEYvh.js";import{Q as Je}from"./index-B15WEYvh.js";import{C as ve}from"./cloud-upload-B4B1GFVI.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ee=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],Ce=x("circle-x",Ee);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=[["path",{d:"M11 14h10",key:"1w8e9d"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v1.344",key:"1e62lh"}],["path",{d:"m17 18 4-4-4-4",key:"z2g111"}],["path",{d:"M8 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 1.793-1.113",key:"bjbb7m"}],["rect",{x:"8",y:"2",width:"8",height:"4",rx:"1",key:"ublpy"}]],Te=x("clipboard-paste",Me);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],Ie=x("copy",Se);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oe=[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}]],De=x("file",Oe);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=[["path",{d:"M12 10v6",key:"1bos4e"}],["path",{d:"M9 13h6",key:"1uhe8q"}],["path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z",key:"1kt360"}]],ze=x("folder-plus",Le);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=[["path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z",key:"1kt360"}]],Re=x("folder",Fe);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pe=[["circle",{cx:"6",cy:"6",r:"3",key:"1lh9wr"}],["path",{d:"M8.12 8.12 12 12",key:"1alkpv"}],["path",{d:"M20 4 8.12 15.88",key:"xgtan2"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["path",{d:"M14.8 14.8 20 20",key:"ptml3r"}]],Ae=x("scissors",Pe),$e=1,qe=[1,6,12,24],z=n=>{if(n<1024)return`${n} B`;const r=["KB","MB","GB","TB"];let f=n/1024,g=0;for(;f>=1024&&g<r.length-1;)f/=1024,g+=1;return`${f.toFixed(f>=10?0:1)} ${r[g]}`},Ke=()=>{const{t:n}=me(),[r,f]=l.useState(j),[g,N]=l.useState([]),[i,E]=l.useState(!1),[W,F]=l.useState(!1),[h,V]=l.useState({usage:null,quota:null}),[C,J]=ue("file-manager-trash-ttl-hours",$e),[m,w]=l.useState([]),[M,y]=l.useState(null),[R,k]=l.useState(null),[_,T]=l.useState(null),[b,p]=l.useState({isOpen:!1,x:0,y:0,targetFolderId:j}),P=l.useRef(null),A=l.useRef(null),$=l.useRef(null),o=l.useCallback(async()=>{F(!0);try{if(i){const e=await U();N(e)}else{const e=await fe(r);N(e)}}finally{F(!1)}},[r,i]);l.useEffect(()=>{o(),w([]),y(null)},[o]),l.useEffect(()=>{if(!b.isOpen)return;const e=s=>{A.current?.contains(s.target)||p(d=>({...d,isOpen:!1}))},a=s=>{s.key==="Escape"&&p(d=>({...d,isOpen:!1}))};return window.addEventListener("mousedown",e),window.addEventListener("keydown",a),window.addEventListener("scroll",e,!0),()=>{window.removeEventListener("mousedown",e),window.removeEventListener("keydown",a),window.removeEventListener("scroll",e,!0)}},[b.isOpen]),l.useEffect(()=>{const e=()=>o();return window.addEventListener("file-manager-refresh",e),()=>window.removeEventListener("file-manager-refresh",e)},[o]),l.useEffect(()=>{const e=Math.max(1,C)*60*60*1e3;ge(e).then(()=>o())},[o,C]),l.useEffect(()=>{let e=!0;return he().then(a=>{e&&V(a)}),()=>{e=!1}},[g.length]);const G=l.useMemo(()=>(async()=>{const a=await ye(),s=new Map(a.map(u=>[u.id,u])),d=[];let c=s.get(r);for(;c&&c.id!==j;)d.unshift(c),c=s.get(c.parentId);return d})(),[r]),S=l.useMemo(()=>{const e=[...g];return e.sort((a,s)=>a.type!==s.type?a.type==="folder"?-1:1:a.name.localeCompare(s.name)),e},[g]),I=l.useMemo(()=>h.usage==null||h.quota==null?null:Math.min(100,Math.round(h.usage/h.quota*100)),[h.quota,h.usage]),X=async()=>{const e=window.prompt(n("widgets.file_manager.new_folder_prompt"));if(!e)return;const a=e.trim();a&&(await be(a,r),o())},q=async e=>{if(i||!e||e.length===0)return;const a=Array.from(e).map(s=>Ne({name:s.name,parentId:r,blob:s,mime:s.type}));await Promise.all(a),o()},Z=e=>{if(e.preventDefault(),i)return;k(null);const a=e.dataTransfer.getData("application/x-ed-file-manager");if(a){try{const s=JSON.parse(a);D(s,r).then(o)}catch{}return}q(e.dataTransfer.files)},Y=async e=>{if(i)return;if(e.type==="folder"){f(e.id);return}const a=e.sourceWidgetId||"file-opener";window.dispatchEvent(new CustomEvent("file-manager-open",{detail:{widgetId:a,entryId:e.id}}))},Q=async e=>{await K(e.id),o()},ee=async e=>{await je(e.id),o()},te=async e=>{window.confirm(n("widgets.file_manager.delete_confirm"))&&(await L(e.id),o())},ae=async()=>{if(!window.confirm(n("widgets.file_manager.empty_trash_confirm")))return;const e=await U();e.length!==0&&(await Promise.all(e.map(a=>L(a.id))),o())},se=async e=>{if(!e.blob)return;const a=URL.createObjectURL(e.blob),s=document.createElement("a");s.href=a,s.download=e.name,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a)},ne=async()=>{if(r===j)return;const e=await _e(r);e&&f(e.parentId)},ie=(e,a,s)=>{if(i)return;const d=s.metaKey||s.ctrlKey;if(s.shiftKey&&M!==null){const c=Math.min(M,a),u=Math.max(M,a),H=S.slice(c,u+1).map(O=>O.id);w(O=>d?Array.from(new Set([...O,...H])):H)}else w(d?c=>c.includes(e)?c.filter(u=>u!==e):[...c,e]:[e]);y(a)},le=(e,a)=>{if(i)return;const s=m.includes(e.id)?m:[e.id];a.dataTransfer.setData("application/x-ed-file-manager",JSON.stringify(s)),a.dataTransfer.effectAllowed="move"},re=async(e,a)=>{if(i)return;a.preventDefault(),a.stopPropagation(),k(null);const s=a.dataTransfer.getData("application/x-ed-file-manager");if(s)try{const c=JSON.parse(s).filter(u=>u!==e);if(c.length===0)return;await D(c,e),o()}catch{}},B=(e,a,s)=>{if(i)return;e.preventDefault(),e.stopPropagation();const d=$.current?.getBoundingClientRect(),c=d?e.clientX-d.left:e.clientX,u=d?e.clientY-d.top:e.clientY;if(a&&s!=null){m.includes(a.id)||(w([a.id]),y(s)),p({isOpen:!0,x:c,y:u,targetFolderId:a.type==="folder"?a.id:r});return}p({isOpen:!0,x:c,y:u,targetFolderId:r})},oe=async e=>{_&&(_.mode==="copy"?await ke(_.entryIds,e):(await D(_.entryIds,e),T(null)),o())},ce=async()=>{m.length!==0&&(await Promise.all(m.map(e=>K(e))),o(),w([]),y(null))},de=async()=>{m.length!==0&&window.confirm(n("widgets.file_manager.delete_confirm"))&&(await Promise.all(m.map(e=>L(e))),o(),w([]),y(null))};return t.jsxs("div",{ref:$,className:"file-manager-widget",onDragOver:e=>e.preventDefault(),onDrop:Z,children:[t.jsxs("div",{className:"file-manager-toolbar",children:[t.jsx("button",{className:"file-manager-button",onClick:ne,disabled:r===j||i,title:n("widgets.file_manager.up"),children:t.jsx(pe,{size:16})}),t.jsx("div",{className:"file-manager-breadcrumbs",children:t.jsx(Be,{breadcrumb:G,onNavigate:f,disabled:i})}),t.jsx("div",{className:"file-manager-spacer"}),t.jsxs("button",{className:"file-manager-button",onClick:X,disabled:i,children:[t.jsx(ze,{size:16}),n("widgets.file_manager.new_folder")]}),t.jsxs("button",{className:"file-manager-button",onClick:()=>P.current?.click(),disabled:i,children:[t.jsx(ve,{size:16}),n("widgets.file_manager.upload")]}),t.jsxs("button",{className:"file-manager-button",onClick:()=>E(e=>!e),children:[t.jsx(v,{size:16}),n(i?"widgets.file_manager.exit_trash":"widgets.file_manager.open_trash")]}),t.jsx("button",{className:"file-manager-icon-only",onClick:()=>window.dispatchEvent(new CustomEvent("open-widget",{detail:{widgetId:"local-web"}})),title:n("widgets.local_web.tooltip"),"aria-label":n("widgets.local_web.tooltip"),children:t.jsx("img",{src:we("icons/LocalWeb.png"),alt:"",className:"h-5 w-5"})}),i&&t.jsxs("button",{className:"file-manager-button",onClick:ae,children:[t.jsx(v,{size:16}),n("widgets.file_manager.empty_trash_button")]})]}),t.jsxs("div",{className:"file-manager-usage",children:[t.jsx("div",{className:"file-manager-usage-bar",children:t.jsx("div",{className:"file-manager-usage-fill",style:{width:I?`${I}%`:"0%"}})}),t.jsx("span",{className:"file-manager-usage-text",children:h.usage!=null&&h.quota!=null?n("widgets.file_manager.storage_usage",{used:z(h.usage),total:z(h.quota),percent:I??0}):n("widgets.file_manager.storage_unknown")}),i&&t.jsxs("div",{className:"file-manager-trash-settings",children:[t.jsx("label",{htmlFor:"trash-ttl",children:n("widgets.file_manager.trash_ttl")}),t.jsx("select",{id:"trash-ttl",value:C,onChange:e=>J(Number(e.target.value)),children:qe.map(e=>t.jsx("option",{value:e,children:n("widgets.file_manager.trash_option",{hours:e})},e))})]})]}),t.jsx("div",{className:"file-manager-list",onClick:e=>{e.target===e.currentTarget&&(w([]),y(null))},onContextMenu:e=>B(e),children:W?t.jsx("div",{className:"file-manager-empty",children:n("loading")}):S.length===0?t.jsx("div",{className:"file-manager-empty",children:n(i?"widgets.file_manager.empty_trash":"widgets.file_manager.empty_folder")}):S.map((e,a)=>t.jsxs("div",{className:"file-manager-row",children:[t.jsxs("button",{className:`file-manager-entry${m.includes(e.id)?" selected":""}${R===e.id?" drag-over":""}`,onClick:s=>ie(e.id,a,s),onDoubleClick:()=>Y(e),draggable:!i,onDragStart:s=>le(e,s),onDragOver:s=>{e.type!=="folder"||i||(s.preventDefault(),k(e.id))},onDragLeave:()=>{R===e.id&&k(null)},onDrop:s=>{e.type!=="folder"||i||re(e.id,s)},onContextMenu:s=>B(s,e,a),children:[e.type==="folder"?t.jsx(Re,{size:18}):t.jsx(De,{size:18}),t.jsx("span",{className:"file-manager-entry-name",children:e.name}),e.type==="file"&&e.size!=null&&t.jsx("span",{className:"file-manager-entry-size",children:z(e.size)}),e.sourceWidgetId&&t.jsx("span",{className:"file-manager-entry-source",children:n("widgets.file_manager.saved_from",{widget:e.sourceWidgetTitleKey?n(e.sourceWidgetTitleKey):e.sourceWidgetId})})]}),t.jsxs("div",{className:"file-manager-actions",children:[e.type==="file"&&!i&&t.jsx("button",{className:"file-manager-icon-button",onClick:()=>se(e),title:n("widgets.file_manager.download"),children:t.jsx(xe,{size:16})}),i?t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"file-manager-icon-button",onClick:()=>ee(e),title:n("widgets.file_manager.restore"),children:n("widgets.file_manager.restore")}),t.jsx("button",{className:"file-manager-icon-button danger",onClick:()=>te(e),title:n("widgets.file_manager.delete_permanent"),children:n("widgets.file_manager.delete_permanent")})]}):t.jsx("button",{className:"file-manager-icon-button danger",onClick:()=>Q(e),title:n("widgets.file_manager.move_to_trash"),children:t.jsx(v,{size:16})})]})]},e.id))}),t.jsx("input",{type:"file",ref:P,onChange:e=>q(e.target.files),multiple:!0,className:"hidden"}),b.isOpen&&t.jsxs("div",{ref:A,className:"file-manager-context-menu",style:{left:b.x,top:b.y},children:[t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{T({mode:"copy",entryIds:m}),p(e=>({...e,isOpen:!1}))},disabled:m.length===0,children:[t.jsx(Ie,{size:14}),n("widgets.file_manager.copy")]}),t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{T({mode:"cut",entryIds:m}),p(e=>({...e,isOpen:!1}))},disabled:m.length===0,children:[t.jsx(Ae,{size:14}),n("widgets.file_manager.cut")]}),t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{oe(b.targetFolderId),p(e=>({...e,isOpen:!1}))},disabled:!_||_.entryIds.length===0,children:[t.jsx(Te,{size:14}),n("widgets.file_manager.paste")]}),t.jsx("div",{className:"file-manager-context-separator"}),t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{ce(),p(e=>({...e,isOpen:!1}))},disabled:m.length===0,children:[t.jsx(v,{size:14,className:"text-gray-600"}),n("widgets.file_manager.move_to_trash")]}),t.jsxs("button",{className:"file-manager-context-item danger",onClick:()=>{de(),p(e=>({...e,isOpen:!1}))},disabled:m.length===0,children:[t.jsx(Ce,{size:14}),n("widgets.file_manager.delete_permanent")]})]})]})},Be=({breadcrumb:n,onNavigate:r,disabled:f})=>{const[g,N]=l.useState([]);return l.useEffect(()=>{let i=!0;return n.then(E=>{i&&N(E)}),()=>{i=!1}},[n]),g.length===0?null:t.jsx(t.Fragment,{children:g.map(i=>t.jsxs("button",{className:"file-manager-breadcrumb",onClick:()=>r(i.id),disabled:f,children:["/ ",i.name]},i.id))})};export{Ke as FileManagerWidget,Je as widgetConfig};
