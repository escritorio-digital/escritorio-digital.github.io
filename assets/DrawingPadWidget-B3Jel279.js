import{c as P,u as Ue,r as i,f as Ve,j as r,W as Ge,F as Qe,T as Ze,R as et,h as re}from"./index-Ha-A2SqS.js";import{z as Tt}from"./index-Ha-A2SqS.js";import{S as tt,a as nt,s as Ie,r as at,d as st}from"./saveDialog-5GOlg44P.js";import{r as rt}from"./openDialog-H-OCpcqq.js";import{E as it,H as ct,S as ot,A as dt}from"./square-CEcTXq2z.js";import{C as lt}from"./circle-IEENnZmL.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ut=[["path",{d:"M3 3v16a2 2 0 0 0 2 2h16",key:"c24i48"}],["path",{d:"m19 9-5 5-4-4-3 3",key:"2osh9i"}]],ht=P("chart-line",ut);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gt=[["path",{d:"M12 2v20",key:"t6zp3m"}],["path",{d:"m15 19-3 3-3-3",key:"11eu04"}],["path",{d:"m19 9 3 3-3 3",key:"1mg7y2"}],["path",{d:"M2 12h20",key:"9i4pu4"}],["path",{d:"m5 9-3 3 3 3",key:"j64kie"}],["path",{d:"m9 5 3-3 3 3",key:"l8vdw6"}]],wt=P("move",gt);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pt=[["path",{d:"m14.622 17.897-10.68-2.913",key:"vj2p1u"}],["path",{d:"M18.376 2.622a1 1 0 1 1 3.002 3.002L17.36 9.643a.5.5 0 0 0 0 .707l.944.944a2.41 2.41 0 0 1 0 3.408l-.944.944a.5.5 0 0 1-.707 0L8.354 7.348a.5.5 0 0 1 0-.707l.944-.944a2.41 2.41 0 0 1 3.408 0l.944.944a.5.5 0 0 0 .707 0z",key:"18tc5c"}],["path",{d:"M9 8c-1.804 2.71-3.97 3.46-6.583 3.948a.507.507 0 0 0-.302.819l7.32 8.883a1 1 0 0 0 1.185.204C12.735 20.405 16 16.792 16 15",key:"ytzfxy"}]],ft=P("paintbrush",pt);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mt=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]],xt=P("pen",mt);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bt=[["path",{d:"M3 3h.01",key:"159qn6"}],["path",{d:"M7 5h.01",key:"1hq22a"}],["path",{d:"M11 7h.01",key:"1osv80"}],["path",{d:"M3 7h.01",key:"1xzrh3"}],["path",{d:"M7 9h.01",key:"19b3jx"}],["path",{d:"M3 11h.01",key:"1eifu7"}],["rect",{width:"4",height:"4",x:"15",y:"5",key:"mri9e4"}],["path",{d:"m19 9 2 2v10c0 .6-.4 1-1 1h-6c-.6 0-1-.4-1-1V11l2-2",key:"aib6hk"}],["path",{d:"m13 14 8-2",key:"1d7bmk"}],["path",{d:"m13 19 8-2",key:"1y2vml"}]],yt=P("spray-can",bt);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vt=[["path",{d:"M12 4v16",key:"1654pz"}],["path",{d:"M4 7V5a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v2",key:"e0r10z"}],["path",{d:"M9 20h6",key:"s66wpe"}]],kt=P("type",vt),_t=({instanceId:ie})=>{const{t:u}=Ue(),je=i.useRef(ie??`drawing-pad-${Date.now()}-${Math.random().toString(16).slice(2)}`),F=ie??je.current,p=i.useRef(null),f=i.useRef(null),[ce,L]=i.useState(!1),[_,Se]=i.useState("#000000"),[I,_e]=i.useState(5),[N,oe]=i.useState("draw"),[w,j]=i.useState("pencil"),[A,de]=i.useState(null),[b,Ne]=i.useState(0),[y,Re]=i.useState(0),[R,D]=i.useState(null),[le,H]=i.useState(!1),[q,X]=i.useState(""),[ue,Te]=i.useState(0),[he,ze]=i.useState(0),ge=i.useRef(null),[K,Pe]=i.useState(!0),[M,J]=i.useState({x:0,y:0}),[v,Ee]=i.useState(!1),[U,V]=i.useState(null),[De,G]=i.useState(null),[we,Xe]=i.useState(null),[Ye,T]=i.useState(!1),C=i.useRef(null),[Q,Z]=i.useState(!1),Y=i.useRef(typeof window<"u"&&window.devicePixelRatio||1),$=i.useRef(M),ee=i.useRef(Q);$.current=M,ee.current=Q;const x=i.useCallback(()=>{K&&Pe(!1)},[K]),[E,S]=i.useState(null),B=i.useCallback((e,n)=>{if(!p.current||!C.current)return;const t=p.current,a=C.current,s=t.getContext("2d");if(s){s.clearRect(0,0,t.width,t.height);const c=Y.current||1,l=Math.max(0,Math.round(e*c)),o=Math.max(0,Math.round(n*c)),d=Math.min(t.width,a.width-l),h=Math.min(t.height,a.height-o);d>0&&h>0&&s.drawImage(a,l,o,d,h,0,0,d,h)}},[]),$e=i.useCallback(()=>{J({x:0,y:0}),B(0,0)},[B]),Be=i.useCallback(()=>{Ee(!v),v||S(null)},[v]),te=i.useCallback(()=>(C.current||(C.current=document.createElement("canvas")),C.current),[]),W=i.useCallback(()=>{const e=p.current;if(!e)return;const n=te(),t=$.current,a=Y.current||1,s=Math.max(e.width+Math.abs(Math.round(t.x*a)),n.width||0),c=Math.max(e.height+Math.abs(Math.round(t.y*a)),n.height||0);if(n.width<s||n.height<c){const o=document.createElement("canvas");o.width=s,o.height=c;const d=o.getContext("2d");if(d){ee.current&&n.width>0&&n.height>0&&d.drawImage(n,0,0),n.width=s,n.height=c;const h=n.getContext("2d");h&&(h.clearRect(0,0,s,c),h.drawImage(o,0,0))}}const l=n.getContext("2d");if(l){const o=Math.max(0,Math.round(t.x*a)),d=Math.max(0,Math.round(t.y*a));l.drawImage(e,0,0,e.width,e.height,o,d,e.width,e.height)}Z(!0)},[te]),pe=i.useCallback(e=>{const n=p.current;if(!n)return{x:0,y:0};const t=n.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}},[]),fe=i.useCallback(e=>{const n=p.current;if(!n)return{x:0,y:0};const t=n.getBoundingClientRect(),a=n.width/t.width,s=n.height/t.height;return{x:(e.clientX-t.left)*a+M.x*a,y:(e.clientY-t.top)*s+M.y*s}},[M]),We=i.useCallback(e=>{const n=p.current;if(!n)return{x:0,y:0};const t=n.getBoundingClientRect(),a=n.width/t.width,s=n.height/t.height;return{x:(e.clientX-t.left)*a+M.x*a,y:(e.clientY-t.top)*s+M.y*s}},[M]),me=i.useCallback((e=!1,n)=>{const t=p.current,a=f.current;if(!t||!a)return;const s=n??A;let c=null;if(e&&(c=a.getImageData(0,0,t.width,t.height)),e||a.clearRect(0,0,t.width,t.height),s){const l=t.width/s.width,o=t.height/s.height,d=Math.min(l,o),h=(t.width-s.width*d)/2,m=(t.height-s.height*d)/2;if(e&&c){const k=document.createElement("canvas");k.width=t.width,k.height=t.height;const g=k.getContext("2d");g&&(g.drawImage(s,0,0,s.width,s.height,h,m,s.width*d,s.height*d),g.putImageData(c,0,0),a.clearRect(0,0,t.width,t.height),a.drawImage(k,0,0))}else a.drawImage(s,0,0,s.width,s.height,h,m,s.width*d,s.height*d)}else e&&c&&a.putImageData(c,0,0)},[A]);i.useEffect(()=>{const e=p.current;if(!e)return;const n=()=>{const s=e.offsetWidth,c=e.offsetHeight,l=(typeof window<"u"?window.devicePixelRatio:1)||1;if(Y.current=l,s<=0||c<=0)return;const o=Math.round(s*l),d=Math.round(c*l);if(e.width!==o||e.height!==d){const h=$.current,m=Math.max(0,Math.round(h.x*l)),k=Math.max(0,Math.round(h.y*l)),g=te();((Ce,Me)=>{if(g.width>=Ce&&g.height>=Me)return;const z=document.createElement("canvas");z.width=Math.max(Ce,g.width),z.height=Math.max(Me,g.height);const ae=z.getContext("2d");ae&&g.width>0&&g.height>0&&ae.drawImage(g,0,0),g.width=z.width,g.height=z.height;const se=g.getContext("2d");se&&ae&&(se.clearRect(0,0,g.width,g.height),se.drawImage(z,0,0))})(m+e.width,k+e.height);const O=g.getContext("2d");O&&e.width>0&&e.height>0&&(O.drawImage(e,0,0,e.width,e.height,m,k,e.width,e.height),ee.current=!0,Z(!0)),e.width=o,e.height=d,f.current=e.getContext("2d"),B(h.x,h.y)}},t=e.getContext("2d");if(!t)return;f.current=t,n();const a=new ResizeObserver(()=>{n()});return a.observe(e.parentElement||e),window.addEventListener("resize",n),()=>{a.disconnect(),window.removeEventListener("resize",n)}},[]),i.useEffect(()=>{f.current&&(f.current.globalCompositeOperation=N==="draw"?"source-over":"destination-out")},[N]);const Oe=e=>{if(x(),v){const a=pe(e);S(a);return}if(w==="text"&&le||!f.current||!p.current)return;const{x:n,y:t}=fe(e);w==="text"?(H(!0),Te(n),ze(t),X(""),D(f.current.getImageData(0,0,p.current.width,p.current.height)),setTimeout(()=>ge.current?.focus(),0)):["line","rectangle","circle","arrow"].includes(w)?(Ne(n),Re(t),D(f.current.getImageData(0,0,p.current.width,p.current.height))):(f.current.beginPath(),f.current.moveTo(n,t)),L(!0),T(!0)},xe=(e,n,t,a,s)=>{e.save(),e.beginPath(),e.translate(n,t),e.rotate(a),e.moveTo(0,0),e.lineTo(-s,-s/2),e.lineTo(-s,s/2),e.closePath(),e.fill(),e.restore()},Fe=e=>{if(v&&E){const s=pe(e),c=s.x-E.x,l=s.y-E.y;if(Q&&C.current){const h=C.current.getContext("2d"),m=p.current;if(h&&m){const k=$.current,g=Y.current||1,ke=Math.max(0,Math.round(k.x*g)),O=Math.max(0,Math.round(k.y*g));h.drawImage(m,0,0,m.width,m.height,ke,O,m.width,m.height)}}const o={x:M.x-c,y:M.y-l};J(o),B(o.x,o.y),S(s);return}if(!ce||!f.current)return;const{x:n,y:t}=fe(e),a=f.current;if(a.lineWidth=I,a.strokeStyle=_,a.fillStyle=_,R&&["line","rectangle","circle","arrow"].includes(w)){a.putImageData(R,0,0);const s=n-b,c=t-y;switch(w){case"line":a.beginPath(),a.moveTo(b,y),a.lineTo(n,t),a.stroke();break;case"rectangle":a.strokeRect(b,y,s,c);break;case"circle":const l=(b+n)/2,o=(y+t)/2,d=Math.abs(s/2),h=Math.abs(c/2);a.beginPath(),a.ellipse(l,o,d,h,0,0,2*Math.PI),a.stroke();break;case"arrow":a.beginPath(),a.moveTo(b,y),a.lineTo(n,t),a.stroke();const m=Math.atan2(t-y,n-b);xe(a,n,t,m,I*4);break}}else if(w!=="text"){switch(w){case"pencil":a.lineCap="round",a.lineJoin="round",a.lineTo(n,t),a.stroke();break;case"marker":a.lineCap="square",a.lineJoin="miter",a.lineTo(n,t),a.stroke();break;case"spray":for(let s=0;s<15;s++){const c=Math.random()*2*Math.PI,l=Math.random()*I,o=n+l*Math.cos(c),d=t+l*Math.sin(c);a.fillRect(o,d,1,1)}break}a.beginPath(),a.moveTo(n,t)}},be=e=>{if(v){S(null);return}if(!f.current)return;const n=f.current,{x:t,y:a}=We(e);let s=t,c=a;if(["line","rectangle","circle","arrow"].includes(w)&&(isNaN(t)||isNaN(a))&&(s=b,c=y),R&&["line","rectangle","circle","arrow"].includes(w)){n.putImageData(R,0,0);const l=s-b,o=c-y;switch(w){case"line":n.beginPath(),n.moveTo(b,y),n.lineTo(s,c),n.stroke();break;case"rectangle":n.strokeRect(b,y,l,o);break;case"circle":const d=(b+s)/2,h=(y+c)/2,m=Math.abs(l/2),k=Math.abs(o/2);n.beginPath(),n.ellipse(d,h,m,k,0,0,2*Math.PI),n.stroke();break;case"arrow":n.beginPath(),n.moveTo(b,y),n.lineTo(s,c),n.stroke();const g=Math.atan2(c-y,s-b);xe(n,s,c,g,I*4);break}D(null)}else w==="text"||n.closePath();L(!1),W()},Le=()=>{const e=p.current,n=f.current;if(e&&n&&window.confirm(u("widgets.drawing_pad.clear_confirm"))){if(de(null),n.clearRect(0,0,e.width,e.height),H(!1),X(""),C.current){const t=C.current.getContext("2d");t&&t.clearRect(0,0,C.current.width,C.current.height)}Z(!1),J({x:0,y:0}),S(null),T(!0)}},ne=(e,n,t)=>{x();const a=new FileReader;a.onload=s=>{const c=new Image;c.onload=()=>{de(c),me(!1,c),W()},c.src=s.target?.result},a.readAsDataURL(e),window.dispatchEvent(new CustomEvent("widget-title-update",{detail:{instanceId:F,title:e.name}})),V(e.name),G(n??null),Xe(t??null),T(!1)},Ae=async()=>{const e=await rt({accept:"image/*",sourceWidgetId:"drawing-pad"});if(!e)return;if(e.source==="local"){const[s]=e.files;s&&ne(s,null,null);return}const[n]=e.entryIds;if(!n)return;const t=await re(n);if(!t?.blob)return;const a=new File([t.blob],t.name,{type:t.mime||t.blob.type});ne(a,t.parentId,t.id)};i.useEffect(()=>Ve("drawing-pad",async({entryId:n})=>{const t=await re(n);if(!t?.blob)return;const a=new File([t.blob],t.name,{type:t.mime||t.blob.type});ne(a,t.parentId,t.id)}),[]);const ye=()=>{const e=p.current;e&&e.toBlob(async n=>{if(!n)return;const t=U||u("widgets.drawing_pad.default_filename"),a=await at(t,{sourceWidgetId:"drawing-pad"});if(a){if(a?.destination==="file-manager"){await Ie({blob:n,filename:a.filename,sourceWidgetId:"drawing-pad",sourceWidgetTitleKey:"widgets.drawing_pad.title",parentId:a.parentId}),window.dispatchEvent(new CustomEvent("widget-title-update",{detail:{instanceId:F,title:a.filename}})),V(a.filename),G(a.parentId),T(!1);return}a?.destination==="download"&&(st(n,a.filename),G(null)),window.dispatchEvent(new CustomEvent("widget-title-update",{detail:{instanceId:F,title:a.filename}})),V(a.filename),T(!1)}},"image/png")},He=async()=>{const e=p.current;if(!e)return;let n=De;if(!n&&we&&(n=(await re(we))?.parentId??null),U&&n){e.toBlob(async t=>{t&&(await Ie({blob:t,filename:U,sourceWidgetId:"drawing-pad",sourceWidgetTitleKey:"widgets.drawing_pad.title",parentId:n}),T(!1))},"image/png");return}ye()},qe=i.useCallback((e,n,t)=>{const a=f.current;!a||!e||(a.font=`${I*2}px Arial`,a.fillStyle=_,a.fillText(e,n,t))},[I,_]),ve=()=>{q.trim()!==""&&(R?f.current?.putImageData(R,0,0):me(),qe(q,ue,he),W()),H(!1),X(""),D(null),L(!1)},Ke=e=>{e.key==="Enter"&&ve()},Je=u(v?"widgets.drawing_pad.exit_pan":"widgets.drawing_pad.pan_mode");return r.jsxs("div",{className:"w-full h-full flex flex-col bg-gray-100 rounded-lg shadow-md overflow-hidden",children:[r.jsx(Ge,{children:r.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[r.jsxs("div",{className:"flex items-center gap-2 border-r pr-2",children:[r.jsx("button",{onClick:()=>{x(),oe("draw")},className:`p-2 rounded-md ${N==="draw"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.brush"),children:r.jsx(ft,{size:20})}),r.jsx("button",{onClick:()=>{x(),oe("erase")},className:`p-2 rounded-md ${N==="erase"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.eraser"),children:r.jsx(it,{size:20})})]}),N==="draw"&&r.jsxs("div",{className:"flex items-center gap-2 border-r pr-2",children:[r.jsx("button",{onClick:()=>{x(),j("pencil")},className:`p-2 rounded-md ${w==="pencil"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.pencil"),children:r.jsx(xt,{size:20})}),r.jsx("button",{onClick:()=>{x(),j("marker")},className:`p-2 rounded-md ${w==="marker"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.marker"),children:r.jsx(ct,{size:20})}),r.jsx("button",{onClick:()=>{x(),j("spray")},className:`p-2 rounded-md ${w==="spray"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.spray"),children:r.jsx(yt,{size:20})}),r.jsx("button",{onClick:()=>{x(),j("line")},className:`p-2 rounded-md ${w==="line"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.line"),children:r.jsx(ht,{size:20})}),r.jsx("button",{onClick:()=>{x(),j("rectangle")},className:`p-2 rounded-md ${w==="rectangle"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.rectangle"),children:r.jsx(ot,{size:20})}),r.jsx("button",{onClick:()=>{x(),j("circle")},className:`p-2 rounded-md ${w==="circle"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.circle"),children:r.jsx(lt,{size:20})}),r.jsx("button",{onClick:()=>{x(),j("arrow")},className:`p-2 rounded-md ${w==="arrow"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.arrow"),children:r.jsx(dt,{size:20})}),r.jsx("button",{onClick:()=>{x(),j("text")},className:`p-2 rounded-md ${w==="text"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.text"),children:r.jsx(kt,{size:20})})]}),r.jsxs("div",{className:"flex items-center gap-4",children:[N==="draw"&&r.jsx("input",{type:"color",value:_,onChange:e=>{x(),Se(e.target.value)},className:"w-8 h-8 cursor-pointer rounded-md border border-gray-300",title:u("widgets.drawing_pad.select_color")}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("input",{type:"range",min:"1",max:"50",value:I,onChange:e=>{x(),_e(Number(e.target.value))},className:"w-24 h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer",title:u("widgets.drawing_pad.brush_size")}),r.jsx("span",{className:"text-sm w-6 text-center text-gray-700",children:I})]})]}),r.jsx("button",{onClick:Ae,className:"p-2 rounded-md hover:bg-gray-300",title:u("widgets.drawing_pad.upload_image"),children:r.jsx(Qe,{size:20})}),r.jsx("button",{onClick:He,className:"p-2 rounded-md hover:bg-green-300 relative",title:u("actions.save"),children:r.jsxs("span",{className:"relative inline-flex",children:[r.jsx(tt,{size:20}),Ye&&r.jsx("span",{className:"absolute -top-1 -right-1 h-2 w-2 rounded-full bg-red-500","aria-hidden":"true"})]})}),r.jsx("button",{onClick:ye,className:"p-2 rounded-md hover:bg-green-300",title:u("actions.save_as"),children:r.jsx(nt,{size:20})}),r.jsx("button",{onClick:Le,className:"p-2 rounded-md hover:bg-red-300",title:u("widgets.drawing_pad.clear_all"),children:r.jsx(Ze,{size:20})}),r.jsxs("div",{className:"ml-auto flex items-center gap-2 border-l pl-2",children:[r.jsx("button",{onClick:Be,className:`p-2 rounded-md ${v?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:Je,children:r.jsx(wt,{size:20})}),r.jsx("button",{onClick:$e,className:"p-2 rounded-md hover:bg-blue-300",title:u("widgets.drawing_pad.center_view"),children:r.jsx(et,{size:20})})]})]})}),r.jsxs("div",{className:"flex-grow w-full h-full relative bg-white",children:[r.jsx("canvas",{ref:p,onMouseDown:Oe,onMouseUp:e=>{if(v){S(null),W();return}w!=="text"&&be(e.nativeEvent)},onMouseLeave:e=>{v?S(null):ce&&w!=="text"&&be(e.nativeEvent)},onMouseMove:Fe,className:`w-full h-full block ${v?"cursor-grab":E?"cursor-grabbing":"cursor-crosshair"}`,style:{cursor:v?E?"grabbing":"grab":"crosshair"}}),!A&&K&&r.jsx("div",{className:"absolute inset-0 flex items-center justify-center text-gray-400 text-lg pointer-events-none",children:u("widgets.drawing_pad.start_drawing")}),le&&r.jsx("input",{type:"text",ref:ge,value:q,onChange:e=>X(e.target.value),onBlur:ve,onKeyDown:Ke,style:{position:"absolute",left:ue,top:he,fontSize:`${I*2}px`,color:_,fontFamily:"Arial",backgroundColor:"rgba(255, 255, 255, 0.8)",border:"1px solid #ccc",padding:"2px 5px",zIndex:100,minWidth:"50px",outline:"none",transform:"translate(-50%, -50%)"},className:"rounded-md shadow-sm"})]})]})};export{_t as DrawingPadWidget,Tt as widgetConfig};
