import{c as v,u as ot,r as c,f as st,j as e,W as it,ae as rt,al as at,F as dt,a8 as ct,h as J}from"./index-C4_cQ6bu.js";import{am as Xt}from"./index-C4_cQ6bu.js";import{d as lt}from"./marked.esm-IrHqQMcX.js";import{k as ut}from"./katex.min-2TduxwG8.js";import{r as wt,s as mt,d as xt}from"./saveDialog-DGJ58OfE.js";import{r as pt}from"./openDialog-H-OCpcqq.js";import{B as ht,I as kt,S as ft,H as gt,a as _t,b as bt,L as yt,c as vt,T as jt,C as Et}from"./text-IivTXvHF.js";import{C as Ct}from"./code-kS2WUmHF.js";import{S as $t}from"./save-sMQxMTdy.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const St=[["path",{d:"m18 16 4-4-4-4",key:"1inbqp"}],["path",{d:"m6 8-4 4 4 4",key:"15zrgr"}],["path",{d:"m14.5 4-5 16",key:"e7oirm"}]],It=v("code-xml",St);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Nt=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M12 3v18",key:"108xh3"}]],Tt=v("columns-2",Nt);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zt=[["path",{d:"M4 22h14a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v4",key:"1pf5j1"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"m5 12-3 3 3 3",key:"oke12k"}],["path",{d:"m9 18 3-3-3-3",key:"112psh"}]],Lt=v("file-code-2",zt);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Mt=[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]],Ft=v("link-2",Mt);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ot=[["path",{d:"M16 3a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2 1 1 0 0 1 1 1v1a2 2 0 0 1-2 2 1 1 0 0 0-1 1v2a1 1 0 0 0 1 1 6 6 0 0 0 6-6V5a2 2 0 0 0-2-2z",key:"rib7q0"}],["path",{d:"M5 3a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2 1 1 0 0 1 1 1v1a2 2 0 0 1-2 2 1 1 0 0 0-1 1v2a1 1 0 0 0 1 1 6 6 0 0 0 6-6V5a2 2 0 0 0-2-2z",key:"1ymkrd"}]],Rt=v("quote",Ot),U="https://edicuatex.github.io";function A(j,s,L={}){const b=[],f=(l,w)=>{const E=ut.renderToString(l.trim(),{throwOnError:!1,displayMode:w,output:L.katexOutput}),h=`%%MATH_${b.length}%%`;return b.push({token:h,html:E}),h};let d=s;d=d.replace(/\\\[((?:.|\n)+?)\\\]/g,(l,w)=>f(w,!0)),d=d.replace(/\$\$([\s\S]+?)\$\$/g,(l,w)=>f(w,!0)),d=d.replace(/\\\((.+?)\\\)/g,(l,w)=>f(w,!1)),d=d.replace(/\$([\s\S]+?)\$/g,(l,w)=>f(w,!1));let a=lt.parse(d);b.forEach(({token:l,html:w})=>{a=a.replace(l,w)}),j.innerHTML=a}const Jt=({instanceId:j})=>{const{t:s,i18n:L,ready:b}=ot(),f=c.useRef(j??`markdown-text-editor-${Date.now()}-${Math.random().toString(16).slice(2)}`),d=j??f.current,[a,l]=c.useState(s("widgets.markdown_text_editor.sample_content")),[w,E]=c.useState(""),[h,C]=c.useState(""),[$,M]=c.useState("split"),[K,F]=c.useState(null),m=c.useRef(null),V=c.useRef(null),O=c.useRef(null),k=c.useRef(null),X=c.useMemo(()=>{const t=new URL(`${U}/index.html`);return t.searchParams.set("pm","1"),t.searchParams.set("origin",window.location.origin),t},[]);c.useEffect(()=>{const t=s("widgets.markdown_text_editor.sample_content");t!=="widgets.markdown_text_editor.sample_content"&&l(t)},[s,L.language]),c.useEffect(()=>{const t=O.current;if(t)return document.body.appendChild(t),()=>{t.parentNode&&t.parentNode.removeChild(t)}},[]);const y=t=>{E(t),setTimeout(()=>E(""),1800)},g=(t,o)=>{const n=m.current;n&&requestAnimationFrame(()=>{n.focus(),n.setSelectionRange(t,o)})},S=(t,o,n)=>{const r=m.current;if(!r)return;const i=r.selectionStart,u=r.selectionEnd,p=a.slice(i,u)||n,_=`${a.slice(0,i)}${t}${p}${o}${a.slice(u)}`;l(_),g(i+t.length,i+t.length+p.length)},R=t=>{const o=m.current;if(!o)return;const n=o.selectionStart,r=o.selectionEnd,i=a,u=i.lastIndexOf(`
`,n-1)+1,x=i.indexOf(`
`,r),p=x===-1?i.length:x,W=i.slice(u,p).split(`
`),I=W.every(z=>z.startsWith(t)),N=W.map(z=>I?z.slice(t.length):`${t}${z}`).join(`
`),T=`${i.slice(0,u)}${N}${i.slice(p)}`;l(T);const B=u+N.length;g(B,B)},H=t=>{const o=`${"#".repeat(t)} `,n=m.current;if(!n)return;const r=n.selectionStart,i=a,u=i.lastIndexOf(`
`,r-1)+1,x=i.indexOf(`
`,r),p=x===-1?i.length:x,_=i.slice(u,p),I=_.startsWith(o)?_.slice(o.length):`${o}${_}`,N=`${i.slice(0,u)}${I}${i.slice(p)}`;l(N);const T=u+I.length;g(T,T)},G=()=>{const t=m.current;if(!t)return;const o=t.selectionStart,n=t.selectionEnd,r=a.slice(o,n)||s("widgets.markdown_text_editor.placeholders.code"),i="```\n",x=`${a.slice(0,o)}${i}${r}
\`\`\`${a.slice(n)}`;l(x),g(o+i.length,o+i.length+r.length)},Q=()=>{const t=m.current;if(!t)return;const o=t.selectionStart,n=t.selectionEnd,r=a.slice(o,n)||s("widgets.markdown_text_editor.placeholders.link_text"),i=window.prompt(s("widgets.markdown_text_editor.prompts.link_url"));if(!i)return;const u=`[${r}](${i})`,x=`${a.slice(0,o)}${u}${a.slice(n)}`;l(x),g(o+1,o+1+r.length)},D=c.useCallback(t=>{const o=m.current;if(!o)return;const n=o.selectionStart,r=o.selectionEnd;l(i=>`${i.slice(0,n)}${t}${i.slice(r)}`),g(n+t.length,n+t.length)},[]),Y=()=>{navigator.clipboard.writeText(a).then(()=>y(s("widgets.markdown_text_editor.source_copied"))).catch(()=>y(s("widgets.markdown_text_editor.copy_failed")))},Z=()=>{const t=document.createElement("div");try{A(t,a,{katexOutput:"html"})}catch(i){const u=i instanceof Error?i.message:s("widgets.markdown_text_editor.preview_error");t.innerHTML=`<div class="error-message">${u}</div>`}const n=(()=>{let i="";for(const u of Array.from(document.styleSheets))try{const x=Array.from(u.cssRules||[]);for(const p of x)p.cssText.includes(".katex")&&(i+=p.cssText)}catch{}return i.trim()})(),r=n?`<style>${n}</style>${t.innerHTML}`:t.innerHTML;navigator.clipboard.writeText(r).then(()=>y(s("widgets.markdown_text_editor.html_copied"))).catch(()=>y(s("widgets.markdown_text_editor.copy_failed")))},q=async()=>{const t=new Blob([a],{type:"text/markdown;charset=utf-8"}),o=K||s("widgets.markdown_text_editor.default_filename"),n=await wt(o,{sourceWidgetId:"markdown-text-editor"});if(!n)return;n?.destination==="file-manager"?await mt({blob:t,filename:n.filename,sourceWidgetId:"markdown-text-editor",sourceWidgetTitleKey:"widgets.markdown_text_editor.title",parentId:n.parentId}):n?.destination==="download"&&xt(t,n.filename),window.dispatchEvent(new CustomEvent("widget-title-update",{detail:{instanceId:d,title:n.filename}})),F(n.filename),window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:d,widgetId:"markdown-text-editor",isDirty:!1}}));const r=JSON.stringify({input:a});C(r),window.dispatchEvent(new CustomEvent("widget-save-complete",{detail:{instanceId:d,widgetId:"markdown-text-editor"}}))},P=async t=>{const o=await t.text();l(o),C(JSON.stringify({input:o})),window.dispatchEvent(new CustomEvent("widget-title-update",{detail:{instanceId:d,title:t.name}})),F(t.name),window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:d,widgetId:"markdown-text-editor",isDirty:!1}}))},tt=async()=>{const t=await pt({accept:".md,.txt",sourceWidgetId:"markdown-text-editor"});if(!t)return;if(t.source==="local"){const[i]=t.files;i&&await P(i);return}const[o]=t.entryIds;if(!o)return;const n=await J(o);if(!n?.blob)return;const r=new File([n.blob],n.name,{type:n.mime||n.blob.type});await P(r)},et=async()=>{const t=O.current;if(!t)return;A(t,a);try{await document.fonts?.ready}catch{}await new Promise(n=>requestAnimationFrame(()=>n()));const o=()=>{t.innerHTML="",window.removeEventListener("afterprint",o)};window.addEventListener("afterprint",o),window.print()},nt=()=>{const t=m.current?m.current.value.slice(m.current.selectionStart,m.current.selectionEnd).trim():"",o=new URL(X.toString());if(t&&o.searchParams.set("sel",t),k.current&&!k.current.closed){k.current.focus();return}const n=window.open(o.toString(),"edicuatex","width=1100,height=800,menubar=no,toolbar=no,location=no,status=no");if(!n){y(s("widgets.markdown_text_editor.popup_blocked"));return}k.current=n};return c.useEffect(()=>{const t=o=>{if(o.origin!==U||!o.data||o.data.type!=="edicuatex:result")return;const n=o.data,r=n.latex?`$$${n.latex}$$`:"",i=n.wrapped||r;i&&(D(i),k.current&&!k.current.closed&&k.current.close(),k.current=null)};return window.addEventListener("message",t),()=>window.removeEventListener("message",t)},[D]),c.useEffect(()=>{const t=V.current;if(t)try{A(t,a)}catch(o){const n=o instanceof Error?o.message:s("widgets.markdown_text_editor.preview_error");t.innerHTML=`<div class="error-message">${n}</div>`}},[a,s]),c.useEffect(()=>{h||C(JSON.stringify({input:a}))},[a,h]),c.useEffect(()=>st("markdown-text-editor",async({entryId:o,instanceId:n})=>{if(n&&n!==d)return;const r=await J(o);if(!r?.blob)return;const i=await r.blob.text();l(i),C(JSON.stringify({input:i})),window.dispatchEvent(new CustomEvent("widget-title-update",{detail:{instanceId:d,title:r.name}})),F(r.name),window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:d,widgetId:"markdown-text-editor",isDirty:!1}}))}),[]),c.useEffect(()=>{const t=JSON.stringify({input:a}),o=h!==""&&t!==h;window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:d,widgetId:"markdown-text-editor",isDirty:o}}))},[a,h,d]),c.useEffect(()=>{const t=o=>{const n=o;n.detail?.instanceId===d&&(n.detail?.widgetId&&n.detail.widgetId!=="markdown-text-editor"||q())};return window.addEventListener("widget-save-request",t),()=>window.removeEventListener("widget-save-request",t)},[q,d]),c.useEffect(()=>()=>{window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:d,widgetId:"markdown-text-editor",isDirty:!1}}))},[d]),b?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`markdown-text-editor-widget view-${$}`,children:[e.jsx(it,{children:e.jsxs("div",{className:"markdown-toolbar",children:[e.jsxs("div",{className:"markdown-toolbar-group",children:[e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.bold"),onClick:()=>S("**","**",s("widgets.markdown_text_editor.placeholders.text")),children:e.jsx(ht,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.italic"),onClick:()=>S("*","*",s("widgets.markdown_text_editor.placeholders.text")),children:e.jsx(kt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.strike"),onClick:()=>S("~~","~~",s("widgets.markdown_text_editor.placeholders.text")),children:e.jsx(ft,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.h1"),onClick:()=>H(1),children:e.jsx(gt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.h2"),onClick:()=>H(2),children:e.jsx(_t,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.h3"),onClick:()=>H(3),children:e.jsx(bt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.bullet_list"),onClick:()=>R("- "),children:e.jsx(yt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.ordered_list"),onClick:()=>R("1. "),children:e.jsx(vt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.quote"),onClick:()=>R("> "),children:e.jsx(Rt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.inline_code"),onClick:()=>S("`","`",s("widgets.markdown_text_editor.placeholders.code")),children:e.jsx(Ct,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.code_block"),onClick:G,children:e.jsx(It,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.link"),onClick:Q,children:e.jsx(Ft,{size:16})})]}),e.jsxs("div",{className:"markdown-toolbar-group",children:[w&&e.jsx("span",{className:"feedback-message",children:w}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.view_split"),onClick:()=>M("split"),className:$==="split"?"is-active":"",children:e.jsx(Tt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.view_editor"),onClick:()=>M("editor"),className:$==="editor"?"is-active":"",children:e.jsx(jt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.view_preview"),onClick:()=>M("preview"),className:$==="preview"?"is-active":"",children:e.jsx(rt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.formula"),onClick:nt,children:e.jsx(at,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.copy_source"),onClick:Y,children:e.jsx(Et,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.copy_html"),onClick:Z,children:e.jsx(Lt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.open_file"),onClick:tt,children:e.jsx(dt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.save_file"),onClick:q,children:e.jsx($t,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.export_pdf"),onClick:et,children:e.jsx(ct,{size:16})})]})]})}),e.jsxs("div",{className:"markdown-body",children:[e.jsxs("div",{className:"markdown-pane markdown-editor-pane",children:[e.jsx("div",{className:"markdown-pane-header",children:s("widgets.markdown_text_editor.editor_title")}),e.jsx("textarea",{ref:m,value:a,onChange:t=>l(t.target.value),spellCheck:!0,className:"editor-textarea"})]}),e.jsxs("div",{className:"markdown-pane markdown-preview-pane",children:[e.jsx("div",{className:"markdown-pane-header",children:s("widgets.markdown_text_editor.preview_title")}),e.jsx("div",{className:"preview-pane prose",ref:V})]})]})]}),e.jsx("div",{id:"markdown-text-editor-print",ref:O,className:"prose"})]}):e.jsx("div",{className:"flex items-center justify-center h-full",children:s("loading")})};export{Jt as MarkdownTextEditorWidget,Xt as widgetConfig};
