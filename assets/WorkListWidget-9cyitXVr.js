import{c as A,u as H,r,e as U,f as V,j as i,F as X,aF as G,h as j}from"./index-rdPxbIB-.js";import{aT as ue}from"./index-rdPxbIB-.js";import{P as C}from"./papaparse.min-PZUSyfgP.js";import{S as Q,a as Y,s as q,r as Z,d as ee}from"./saveDialog-D67Q1G-2.js";import{r as te}from"./openDialog-H-OCpcqq.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const se=[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]],ie=A("square-pen",se),le=({instanceId:N})=>{const{t:l,ready:_}=H(),z=r.useRef(N??`work-list-${Date.now()}-${Math.random().toString(16).slice(2)}`),n=N??z.current,[o,c]=U("work-list-tasks",[]),[f,T]=r.useState(""),[m,v]=r.useState(null),[k,h]=r.useState(""),[p,w]=r.useState(""),[y,F]=r.useState(null),[J,x]=r.useState(null),[D,M]=r.useState(null),B=e=>{e.key==="Enter"&&f.trim()!==""&&(c([...o,{id:Date.now(),text:f.trim(),completed:!1}]),T(""))},K=e=>{c(o.map(s=>s.id===e?{...s,completed:!s.completed}:s))},O=e=>{c(o.filter(s=>s.id!==e))},L=e=>{v(e.id),h(e.text)},$=e=>{e.key==="Enter"&&m!==null&&(k.trim()===""?O(m):c(o.map(s=>s.id===m?{...s,text:k.trim()}:s)),v(null),h(""))},W=async()=>{const e=C.unparse(o.map(a=>({id:a.id,text:a.text,completed:a.completed}))),s=new Blob([e],{type:"text/csv;charset=utf-8;"}),t=await Z(y||"lista_de_trabajo.csv",{sourceWidgetId:"work-list"});if(!t)return;t?.destination==="file-manager"?(await q({blob:s,filename:t.filename,sourceWidgetId:"work-list",sourceWidgetTitleKey:"widgets.work_list.title",parentId:t.parentId}),x(t.parentId)):t?.destination==="download"&&(ee(s,t.filename),x(null)),window.dispatchEvent(new CustomEvent("widget-title-update",{detail:{instanceId:n,title:t.filename}})),F(t.filename),window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:n,widgetId:"work-list",isDirty:!1}}));const d=JSON.stringify(o);w(d),window.dispatchEvent(new CustomEvent("widget-save-complete",{detail:{instanceId:n,widgetId:"work-list"}}))},b=async()=>{let e=J;if(!e&&D&&(e=(await j(D))?.parentId??null),y&&e){const s=C.unparse(o.map(a=>({id:a.id,text:a.text,completed:a.completed}))),t=new Blob([s],{type:"text/csv;charset=utf-8;"});await q({blob:t,filename:y,sourceWidgetId:"work-list",sourceWidgetTitleKey:"widgets.work_list.title",parentId:e}),window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:n,widgetId:"work-list",isDirty:!1}}));const d=JSON.stringify(o);w(d),window.dispatchEvent(new CustomEvent("widget-save-complete",{detail:{instanceId:n,widgetId:"work-list"}}));return}await W()},g=r.useCallback((e,s,t,d)=>{C.parse(e,{header:!0,skipEmptyLines:!0,complete:a=>{const E=a.data.map(u=>({id:Number(u.id)||Date.now()+Math.random(),text:String(u.text||""),completed:String(u.completed).toLowerCase()==="true"})).filter(u=>u.text);window.confirm(l("widgets.work_list.replace_list_confirm"))?(c(E),w(JSON.stringify(E))):c(u=>{const P=[...u,...E];return w(JSON.stringify(P)),P});const S=s||e.name;S&&(window.dispatchEvent(new CustomEvent("widget-title-update",{detail:{instanceId:n,title:S}})),F(S),x(t??null),M(d??null)),window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:n,widgetId:"work-list",isDirty:!1}}))},error:a=>{console.error("Error al parsear el CSV:",a),alert(l("widgets.work_list.csv_error"))}})},[n,c,l]),R=async()=>{const e=await te({accept:".csv",sourceWidgetId:"work-list"});if(!e)return;if(e.source==="local"){const[a]=e.files;a&&g(a,void 0,null,null);return}const[s]=e.entryIds;if(!s)return;const t=await j(s);if(!t?.blob)return;const d=new File([t.blob],t.name,{type:t.mime||t.blob.type});g(d,t.name,t.parentId,t.id)};r.useEffect(()=>V("work-list",async({entryId:s})=>{const t=await j(s);if(!t?.blob)return;const d=new File([t.blob],t.name,{type:t.mime||t.blob.type});g(d,t.name,t.parentId,t.id)}),[g]);const I=p!==""&&JSON.stringify(o)!==p;return r.useEffect(()=>{if(!p){w(JSON.stringify(o));return}window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:n,widgetId:"work-list",isDirty:I}}))},[I,p,n,o]),r.useEffect(()=>{const e=s=>{const t=s;t.detail?.instanceId===n&&(t.detail?.widgetId&&t.detail.widgetId!=="work-list"||b())};return window.addEventListener("widget-save-request",e),()=>window.removeEventListener("widget-save-request",e)},[b,n]),r.useEffect(()=>()=>{window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:n,widgetId:"work-list",isDirty:!1}}))},[n]),console.log("WorkList translations:",{ready:_,placeholder:l("widgets.work_list.add_task_placeholder"),title:l("widgets.work_list.title")}),_?i.jsxs("div",{className:"work-list-widget",children:[i.jsxs("div",{className:"flex gap-2 mb-2",children:[i.jsx("input",{type:"text",className:"work-list-input",placeholder:l("widgets.work_list.add_task_placeholder"),value:f,onChange:e=>T(e.target.value),onKeyPress:B}),i.jsx("button",{onClick:R,className:"work-list-icon-button",title:l("widgets.work_list.load_csv"),children:i.jsx(X,{size:20})}),i.jsx("button",{onClick:b,className:"work-list-icon-button",title:l("actions.save"),children:i.jsxs("span",{className:"save-indicator-icon",children:[i.jsx(Q,{size:20}),I&&i.jsx("span",{className:"save-indicator-dot","aria-hidden":"true"})]})}),i.jsx("button",{onClick:W,className:"work-list-icon-button",title:l("actions.save_as"),children:i.jsx(Y,{size:20})})]}),i.jsx("ul",{className:"work-list-items",children:o.map(e=>i.jsxs("li",{className:`work-list-item ${e.completed?"opacity-50":""}`,children:[i.jsx("input",{type:"checkbox",className:"work-list-checkbox",checked:e.completed,onChange:()=>K(e.id)}),m===e.id?i.jsx("input",{type:"text",value:k,onChange:s=>h(s.target.value),onKeyPress:$,onBlur:()=>v(null),className:"work-list-edit-input",autoFocus:!0}):i.jsx("span",{className:`flex-grow cursor-pointer ${e.completed?"line-through":""}`,onDoubleClick:()=>L(e),children:e.text}),i.jsx("button",{onClick:()=>L(e),className:"work-list-action",children:i.jsx(ie,{size:16})}),i.jsx("button",{onClick:()=>O(e.id),className:"work-list-action delete",children:i.jsx(G,{size:16})})]},e.id))}),i.jsx("p",{className:"work-list-hint",children:l("widgets.work_list.double_click_edit")})]}):i.jsx("div",{className:"flex items-center justify-center h-full",children:l("loading")})};export{le as WorkListWidget,ue as widgetConfig};
