import{c as le,u as ue,r,j as o,_ as de,aB as he,aD as ge,R as fe,T as pe,aE as we}from"./index-CmZZXgdz.js";import{H as be,E as me,S as xe,A as ye}from"./square-0sUG7pWR.js";import{C as _e}from"./circle-D2S7G56c.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ve=[["path",{d:"M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8",key:"1p45f6"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}]],je=le("rotate-cw",ve),b="#ff2d2d",m=6,X=()=>({pen:{color:b,size:m,opacity:1},highlighter:{color:"#facc15",size:14,opacity:.2},eraser:{color:b,size:18,opacity:1},line:{color:b,size:m,opacity:1},rectangle:{color:b,size:m,opacity:1},ellipse:{color:b,size:m,opacity:1},arrow:{color:b,size:m,opacity:1}}),q="pen",Ce=12,Ie=({instanceId:$})=>{const{t:a}=ue(),J=r.useRef($??`screen-annotator-${Date.now()}-${Math.random().toString(16).slice(2)}`),j=$??J.current,C=r.useMemo(()=>`screen-annotator-draft:${j}`,[j]),S=r.useRef(null),d=r.useRef(null),l=r.useRef(null),z=r.useRef(null),T=r.useRef(null),I=r.useRef([]),Y=r.useRef(null),g=r.useRef([]),N=r.useRef([]),k=r.useRef(!1),R=r.useRef(1),p=r.useRef(null);if(!p.current)try{const e=window.localStorage.getItem(C);if(e){const t=JSON.parse(e);t&&typeof t=="object"&&(p.current={imageDataUrl:typeof t.imageDataUrl=="string"?t.imageDataUrl:null,tool:t.tool||q,toolSettings:t.toolSettings&&typeof t.toolSettings=="object"?{...X(),...t.toolSettings}:X(),fillShapes:!!t.fillShapes,toolbarPos:t.toolbarPos&&typeof t.toolbarPos.x=="number"&&typeof t.toolbarPos.y=="number"?t.toolbarPos:{x:24,y:24}})}}catch{p.current=null}const[s,W]=r.useState(p.current?.tool??q),[x,E]=r.useState(p.current?.toolSettings??X()),[f,G]=r.useState(p.current?.fillShapes??!1),[y,K]=r.useState(p.current?.toolbarPos??{x:24,y:24}),L=x[s]??{color:b,size:m,opacity:1},V=r.useMemo(()=>[{id:"pen",icon:o.jsx(de,{size:16}),label:a("widgets.screen_annotator.tool_pen")},{id:"highlighter",icon:o.jsx(be,{size:16}),label:a("widgets.screen_annotator.tool_highlighter")},{id:"eraser",icon:o.jsx(me,{size:16}),label:a("widgets.screen_annotator.tool_eraser")},{id:"line",icon:o.jsx(he,{size:16}),label:a("widgets.screen_annotator.tool_line")},{id:"rectangle",icon:o.jsx(xe,{size:16}),label:a("widgets.screen_annotator.tool_rectangle")},{id:"ellipse",icon:o.jsx(_e,{size:16}),label:a("widgets.screen_annotator.tool_ellipse")},{id:"arrow",icon:o.jsx(ye,{size:16}),label:a("widgets.screen_annotator.tool_arrow")}],[a]),_=r.useCallback((e,t)=>{const n=x[t]??{color:b,size:m,opacity:1};e.lineWidth=n.size,e.lineCap="round",e.lineJoin="round",e.strokeStyle=n.color,e.fillStyle=n.color,e.globalAlpha=Math.min(1,Math.max(.05,n.opacity)),t==="eraser"?e.globalCompositeOperation="destination-out":e.globalCompositeOperation="source-over"},[x]),U=r.useCallback(()=>{const e=S.current,t=d.current;if(!e||!t)return;const n=e.getBoundingClientRect(),i=window.devicePixelRatio||1;R.current=i;const u=t.width>0&&t.height>0?t.toDataURL("image/png"):null;t.width=Math.max(1,Math.floor(n.width*i)),t.height=Math.max(1,Math.floor(n.height*i)),t.style.width=`${n.width}px`,t.style.height=`${n.height}px`;const c=t.getContext("2d");if(c&&(c.setTransform(i,0,0,i,0,0),l.current=c,u)){const A=new Image;A.onload=()=>{c.clearRect(0,0,n.width,n.height),c.drawImage(A,0,0,n.width,n.height)},A.src=u}},[]),w=r.useCallback(()=>{const e=d.current,t=l.current;if(!e||!t)return;const n=t.getImageData(0,0,e.width,e.height);g.current.push(n),g.current.length>Ce&&g.current.shift(),N.current=[]},[]),h=r.useCallback(()=>{const e=d.current;if(e)try{const n={imageDataUrl:e.toDataURL("image/png"),tool:s,toolSettings:x,fillShapes:f,toolbarPos:y};window.localStorage.setItem(C,JSON.stringify(n))}catch{}},[f,C,y,s,x]),Z=r.useCallback(()=>{const e=d.current,t=l.current;if(!e||!t)return;const n=e.width/R.current,i=e.height/R.current;t.clearRect(0,0,n,i),w(),h()},[h,w]),Q=r.useCallback(()=>{const e=d.current,t=l.current;if(!e||!t||g.current.length<=1)return;const n=g.current.pop();n&&N.current.push(n);const i=g.current[g.current.length-1];i&&(t.putImageData(i,0,0),h())},[h]),ee=r.useCallback(()=>{const e=d.current,t=l.current;if(!e||!t)return;const n=N.current.pop();n&&(g.current.push(n),t.putImageData(n,0,0),h())},[h]),B=r.useCallback((e,t,n)=>{const i=Math.atan2(n.y-t.y,n.x-t.x),u=x.arrow??{size:m},c=Math.max(10,u.size*2.5);e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(n.x,n.y),e.moveTo(n.x,n.y),e.lineTo(n.x-c*Math.cos(i-Math.PI/6),n.y-c*Math.sin(i-Math.PI/6)),e.moveTo(n.x,n.y),e.lineTo(n.x-c*Math.cos(i+Math.PI/6),n.y-c*Math.sin(i+Math.PI/6)),e.stroke()},[x]),H=r.useCallback(e=>{const t=l.current,n=Y.current,i=z.current;if(!t||!n||!i)return;t.putImageData(i,0,0),t.save(),_(t,s);const u=e.x-n.x,c=e.y-n.y;s==="line"?(t.beginPath(),t.moveTo(n.x,n.y),t.lineTo(e.x,e.y),t.stroke()):s==="rectangle"?(t.beginPath(),t.rect(n.x,n.y,u,c),f&&t.fill(),t.stroke()):s==="ellipse"?(t.beginPath(),t.ellipse(n.x+u/2,n.y+c/2,Math.abs(u/2),Math.abs(c/2),0,0,Math.PI*2),f&&t.fill(),t.stroke()):s==="arrow"&&B(t,n,e),t.restore()},[_,B,f,s]),v=r.useCallback(()=>{const e=l.current,t=T.current,n=I.current;if(!(!e||!t||n.length===0)){e.putImageData(t,0,0),e.save(),_(e,"highlighter"),e.beginPath(),e.moveTo(n[0].x,n[0].y);for(let i=1;i<n.length;i+=1)e.lineTo(n[i].x,n[i].y);e.stroke(),e.restore()}},[_]),D=r.useCallback(e=>{const t=d.current;if(!t)return{x:0,y:0};const n=t.getBoundingClientRect();return{x:e.clientX-n.left,y:e.clientY-n.top}},[]),te=r.useCallback(e=>{if(e.button!==0)return;const t=d.current,n=l.current;if(!t||!n)return;e.currentTarget.setPointerCapture(e.pointerId);const i=D(e);k.current=!0,Y.current=i,s==="pen"||s==="eraser"?(n.save(),_(n,s),n.beginPath(),n.moveTo(i.x,i.y)):s==="highlighter"?(T.current=n.getImageData(0,0,t.width,t.height),I.current=[i],v()):z.current=n.getImageData(0,0,t.width,t.height)},[_,v,D,s]),ne=r.useCallback(e=>{if(!k.current)return;const t=l.current;if(!t)return;const n=D(e);s==="pen"||s==="eraser"?(t.lineTo(n.x,n.y),t.stroke()):s==="highlighter"?(I.current.push(n),v()):H(n)},[v,H,D,s]),M=r.useCallback(()=>{if(!k.current)return;const e=l.current;e&&((s==="pen"||s==="eraser")&&(e.closePath(),e.restore()),s==="highlighter"&&(v(),T.current=null,I.current=[]),z.current=null,k.current=!1,w(),h())},[v,h,w,s]),F=r.useCallback(e=>{e.pointerId&&e.currentTarget.hasPointerCapture(e.pointerId)&&e.currentTarget.releasePointerCapture(e.pointerId),M()},[M]),oe=r.useCallback(()=>{M()},[M]);r.useEffect(()=>{U(),g.current.length===0&&w();const e=new ResizeObserver(()=>U());return S.current&&e.observe(S.current),()=>e.disconnect()},[w,U]),r.useEffect(()=>{const e=p.current,t=d.current,n=l.current;if(!e||!e.imageDataUrl||!t||!n)return;const i=new Image;i.onload=()=>{const u=t.width/R.current,c=t.height/R.current;n.clearRect(0,0,u,c),n.drawImage(i,0,0,u,c),w()},i.src=e.imageDataUrl},[w]),r.useEffect(()=>{const e=t=>{const n=t;n.detail?.instanceId===j&&(n.detail?.widgetId&&n.detail.widgetId!=="screen-annotator"||window.localStorage.removeItem(C))};return window.addEventListener("widget-close",e),()=>window.removeEventListener("widget-close",e)},[j,C]);const P=r.useRef(null),O=r.useRef(null),re=e=>{e.preventDefault(),O.current=e.pointerId,P.current={offsetX:e.clientX-y.x,offsetY:e.clientY-y.y},e.currentTarget.setPointerCapture(e.pointerId)};r.useEffect(()=>{const e=n=>{P.current&&K({x:Math.max(12,n.clientX-P.current.offsetX),y:Math.max(12,n.clientY-P.current.offsetY)})},t=n=>{O.current===n.pointerId&&(O.current=null,P.current=null,h())};return window.addEventListener("pointermove",e),window.addEventListener("pointerup",t),window.addEventListener("pointercancel",t),()=>{window.removeEventListener("pointermove",e),window.removeEventListener("pointerup",t),window.removeEventListener("pointercancel",t)}},[h]);const ae=()=>{window.dispatchEvent(new CustomEvent("widget-close-request",{detail:{instanceId:j}}))},se=()=>{window.confirm(a("widgets.screen_annotator.clear_confirm"))&&Z()},ie=s==="eraser"?"cell":"crosshair",ce=s==="line"||s==="rectangle"||s==="ellipse"||s==="arrow";return o.jsxs("div",{ref:S,className:"screen-annotator-root",children:[o.jsx("canvas",{ref:d,className:"screen-annotator-canvas",style:{cursor:ie},onPointerDown:te,onPointerMove:ne,onPointerUp:F,onPointerCancel:F,onPointerLeave:oe}),o.jsxs("div",{className:"screen-annotator-toolbar",style:{left:y.x,top:y.y},children:[o.jsxs("div",{className:"screen-annotator-toolbar-section",children:[o.jsxs("div",{className:"screen-annotator-toolbar-header",children:[o.jsx("button",{type:"button",className:"screen-annotator-handle",title:a("widgets.screen_annotator.toolbar_drag"),"aria-label":a("widgets.screen_annotator.toolbar_drag"),onPointerDown:re,children:o.jsx(ge,{size:16})}),o.jsx("span",{children:a("widgets.screen_annotator.section_tools")})]}),o.jsx("div",{className:"screen-annotator-toolbar-row tools",children:V.map(e=>o.jsx("button",{type:"button",className:`screen-annotator-tool ${s===e.id?"is-active":""}`,title:e.label,"aria-label":e.label,onClick:()=>W(e.id),children:e.icon},e.id))})]}),o.jsx("div",{className:"screen-annotator-divider"}),o.jsxs("div",{className:"screen-annotator-toolbar-section",children:[o.jsx("div",{className:"screen-annotator-toolbar-header",children:o.jsx("span",{children:a("widgets.screen_annotator.section_properties")})}),o.jsxs("div",{className:"screen-annotator-toolbar-row settings",children:[o.jsxs("label",{className:"screen-annotator-field",children:[o.jsx("span",{children:a("widgets.screen_annotator.color_label")}),o.jsx("input",{type:"color",value:L.color,onChange:e=>{const t=e.target.value;E(n=>({...n,[s]:{...n[s],color:t}}))},"aria-label":a("widgets.screen_annotator.color_label")})]}),o.jsxs("label",{className:"screen-annotator-field",children:[o.jsx("span",{children:a("widgets.screen_annotator.size_label")}),o.jsx("input",{type:"range",min:2,max:36,value:L.size,onChange:e=>{const t=Number(e.target.value);E(n=>({...n,[s]:{...n[s],size:t}}))},"aria-label":a("widgets.screen_annotator.size_label")})]}),o.jsxs("label",{className:"screen-annotator-field",children:[o.jsx("span",{children:a("widgets.screen_annotator.opacity_label")}),o.jsx("input",{type:"range",min:5,max:100,step:5,value:Math.round(L.opacity*100),onChange:e=>{const t=Number(e.target.value)/100;E(n=>({...n,[s]:{...n[s],opacity:t}}))},"aria-label":a("widgets.screen_annotator.opacity_label")})]}),o.jsx("button",{type:"button",className:`screen-annotator-toggle ${f?"is-active":""}`,onClick:()=>G(e=>!e),disabled:!ce,title:a(f?"widgets.screen_annotator.fill_on":"widgets.screen_annotator.fill_off"),"aria-label":a(f?"widgets.screen_annotator.fill_on":"widgets.screen_annotator.fill_off"),children:a(f?"widgets.screen_annotator.fill_on":"widgets.screen_annotator.fill_off")})]})]}),o.jsx("div",{className:"screen-annotator-divider"}),o.jsxs("div",{className:"screen-annotator-toolbar-section",children:[o.jsx("div",{className:"screen-annotator-toolbar-header",children:o.jsx("span",{children:a("widgets.screen_annotator.section_actions")})}),o.jsxs("div",{className:"screen-annotator-toolbar-row actions",children:[o.jsx("button",{type:"button",className:"screen-annotator-action",onClick:Q,title:a("widgets.screen_annotator.undo"),"aria-label":a("widgets.screen_annotator.undo"),children:o.jsx(fe,{size:16})}),o.jsx("button",{type:"button",className:"screen-annotator-action",onClick:ee,title:a("widgets.screen_annotator.redo"),"aria-label":a("widgets.screen_annotator.redo"),children:o.jsx(je,{size:16})}),o.jsx("button",{type:"button",className:"screen-annotator-action",onClick:se,title:a("widgets.screen_annotator.clear"),"aria-label":a("widgets.screen_annotator.clear"),children:o.jsx(pe,{size:16})}),o.jsx("button",{type:"button",className:"screen-annotator-action screen-annotator-close",onClick:ae,title:a("widgets.screen_annotator.close"),"aria-label":a("widgets.screen_annotator.close"),children:o.jsx(we,{size:16})})]})]})]})]})};export{Ie as ScreenAnnotatorWidget};
