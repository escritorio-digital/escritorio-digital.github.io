import{c as M,u as ve,r,G as E,e as Te,H as Z,J as Ce,K as Ie,L as Se,j as t,M as Me,N as Oe,O as Q,z as De,Q as ze,S as Le,V as Re,X as Fe,W as Pe,Y as We,T as I,Z as Ae,_ as Be,$ as ee,a0 as S,a1 as te,a2 as W,h as Ke,a3 as Ue,a4 as $e,a5 as ae,a6 as qe}from"./index-C4lc0e_t.js";import{a7 as mt}from"./index-C4lc0e_t.js";import{C as Ge}from"./cloud-upload-BpiTSEUH.js";import{C as He}from"./copy-BoZFkkr8.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],Je=M("circle-x",Ye);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ve=[["path",{d:"M11 14h10",key:"1w8e9d"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v1.344",key:"1e62lh"}],["path",{d:"m17 18 4-4-4-4",key:"z2g111"}],["path",{d:"M8 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 1.793-1.113",key:"bjbb7m"}],["rect",{x:"8",y:"2",width:"8",height:"4",rx:"1",key:"ublpy"}]],Xe=M("clipboard-paste",Ve);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ze=[["path",{d:"M12 10v6",key:"1bos4e"}],["path",{d:"M9 13h6",key:"1uhe8q"}],["path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z",key:"1kt360"}]],Qe=M("folder-plus",Ze);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const et=[["circle",{cx:"6",cy:"6",r:"3",key:"1lh9wr"}],["path",{d:"M8.12 8.12 12 12",key:"1alkpv"}],["path",{d:"M20 4 8.12 15.88",key:"xgtan2"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["path",{d:"M14.8 14.8 20 20",key:"ptml3r"}]],tt=M("scissors",et),at=1,nt=[1,6,12,24],ne="file-manager-guide-seeded",st=2*1024*1024,A=2200,B=s=>{if(s<1024)return`${s} B`;const m=["KB","MB","GB","TB"];let g=s/1024,f=0;for(;g>=1024&&f<m.length-1;)g/=1024,f+=1;return`${g.toFixed(g>=10?0:1)} ${m[f]}`},ct=()=>{const{t:s}=ve(),[m,g]=r.useState(E),[f,k]=r.useState([]),[i,O]=r.useState(!1),[se,K]=r.useState(!1),[p,ie]=r.useState({usage:null,quota:null}),[D,re]=Te("file-manager-trash-ttl-hours",at),[d,w]=r.useState([]),[z,_]=r.useState(null),[U,v]=r.useState(null),[y,L]=r.useState(null),[$,T]=r.useState(null),[q,G]=r.useState(null),[j,h]=r.useState({isOpen:!1,x:0,y:0,targetFolderId:E}),H=r.useRef(null),Y=r.useRef(null),J=r.useRef(null),x=r.useRef(null),N=r.useRef(null),l=r.useCallback(async()=>{K(!0);try{if(i){const e=await Z();k(e)}else{const e=await Ce(m);k(e)}}finally{K(!1)}},[m,i]);r.useEffect(()=>{l(),w([]),_(null)},[l]),r.useEffect(()=>{if(!j.isOpen)return;const e=n=>{Y.current?.contains(n.target)||h(c=>({...c,isOpen:!1}))},a=n=>{n.key==="Escape"&&h(c=>({...c,isOpen:!1}))};return window.addEventListener("mousedown",e),window.addEventListener("keydown",a),window.addEventListener("scroll",e,!0),()=>{window.removeEventListener("mousedown",e),window.removeEventListener("keydown",a),window.removeEventListener("scroll",e,!0)}},[j.isOpen]),r.useEffect(()=>{const e=()=>l();return window.addEventListener("file-manager-refresh",e),()=>window.removeEventListener("file-manager-refresh",e)},[l]),r.useEffect(()=>{const e=a=>{a.detail?.type==="saved"&&(T(s("widgets.file_manager.feedback_saved")),x.current&&window.clearTimeout(x.current),x.current=window.setTimeout(()=>{T(null)},A))};return window.addEventListener("file-manager-feedback",e),()=>{window.removeEventListener("file-manager-feedback",e)}},[s]),r.useEffect(()=>{const e=Math.max(1,D)*60*60*1e3;Ie(e).then(()=>l())},[l,D]),r.useEffect(()=>{let e=!0;return(async()=>{const n=window.localStorage.getItem(ne)==="1";n||window.localStorage.setItem(ne,"1");const o=(await ee()).filter(u=>u.sourceWidgetId==="program-guide");if(o.length>1){const u=[...o].sort((b,ke)=>b.createdAt-ke.createdAt),[,...C]=u;await Promise.all(C.map(b=>S(b.id)))}if(o.length>0){e&&l();return}n||(await te({name:s("widgets.program_guide.title"),parentId:E,blob:new Blob([""],{type:"text/plain"}),mime:"text/plain",sourceWidgetId:"program-guide",sourceWidgetTitleKey:"widgets.program_guide.title"}),e&&l())})(),()=>{e=!1}},[l,s]),r.useEffect(()=>{let e=!0;return Se().then(a=>{e&&ie(a)}),()=>{e=!1}},[f.length]),r.useEffect(()=>()=>{x.current&&window.clearTimeout(x.current),N.current&&window.clearTimeout(N.current)},[]);const le=r.useMemo(()=>(async()=>{const a=await ee(),n=new Map(a.map(u=>[u.id,u])),c=[];let o=n.get(m);for(;o&&o.id!==E;)c.unshift(o),o=n.get(o.parentId);return c})(),[m]),R=r.useMemo(()=>{const e=[...f];return e.sort((a,n)=>a.type!==n.type?a.type==="folder"?-1:1:a.name.localeCompare(n.name)),e},[f]),oe=r.useCallback(e=>{if(e.type==="folder")return t.jsx("span",{className:"file-manager-entry-icon",children:t.jsx(Me,{size:18})});const a=e.sourceWidgetId?Oe[e.sourceWidgetId]:void 0;if(a?.icon){const n=typeof a.icon=="string"?t.jsx("img",{src:Q(a.icon),alt:""}):a.icon;return t.jsx("span",{className:"file-manager-entry-icon",children:n})}return e.mime?.startsWith("image/")?t.jsx("span",{className:"file-manager-entry-icon",children:t.jsx(De,{size:18})}):e.mime?.startsWith("audio/")?t.jsx("span",{className:"file-manager-entry-icon",children:t.jsx(ze,{size:18})}):e.mime?.startsWith("video/")?t.jsx("span",{className:"file-manager-entry-icon",children:t.jsx(Le,{size:18})}):t.jsx("span",{className:"file-manager-entry-icon",children:t.jsx(Re,{size:18})})},[]),F=r.useMemo(()=>p.usage==null||p.quota==null?null:Math.min(100,Math.round(p.usage/p.quota*100)),[p.quota,p.usage]),ce=async()=>{const e=window.prompt(s("widgets.file_manager.new_folder_prompt"));if(!e)return;const a=e.trim();a&&(await Ue(a,m),l())},V=async e=>{if(i||!e||e.length===0)return;const a=Array.from(e).map(n=>te({name:n.name,parentId:m,blob:n,mime:n.type}));await Promise.all(a),l(),T(s("widgets.file_manager.feedback_saved")),x.current&&window.clearTimeout(x.current),x.current=window.setTimeout(()=>{T(null)},A)},de=e=>{if(e.preventDefault(),i)return;v(null);const a=e.dataTransfer.getData("application/x-ed-file-manager");if(a){try{const n=JSON.parse(a);W(n,m).then(l)}catch{}return}V(e.dataTransfer.files)},ue=async e=>{if(i)return;if(e.type==="folder"){g(e.id);return}(e.size??e.blob?.size??0)>=st&&(G(s("widgets.file_manager.feedback_opening")),N.current&&window.clearTimeout(N.current),N.current=window.setTimeout(()=>{G(null)},A));const n=e.sourceWidgetId||"file-opener";window.dispatchEvent(new CustomEvent("file-manager-open",{detail:{widgetId:n,entryId:e.id}}))},me=async e=>{await ae(e.id),l()},fe=async e=>{await $e(e.id),l()},ge=async e=>{window.confirm(s("widgets.file_manager.delete_confirm"))&&(await S(e.id),l())},pe=async()=>{if(!window.confirm(s("widgets.file_manager.empty_trash_confirm")))return;const e=await Z();e.length!==0&&(await Promise.all(e.map(a=>S(a.id))),l())},he=async e=>{if(!e.blob)return;const a=URL.createObjectURL(e.blob),n=document.createElement("a");n.href=a,n.download=e.name,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(a)},we=async()=>{if(m===E)return;const e=await Ke(m);e&&g(e.parentId)},xe=(e,a,n)=>{if(i)return;const c=n.metaKey||n.ctrlKey;if(n.shiftKey&&z!==null){const o=Math.min(z,a),u=Math.max(z,a),C=R.slice(o,u+1).map(b=>b.id);w(b=>c?Array.from(new Set([...b,...C])):C)}else w(c?o=>o.includes(e)?o.filter(u=>u!==e):[...o,e]:[e]);_(a)},be=(e,a)=>{if(i)return;const n=d.includes(e.id)?d:[e.id];a.dataTransfer.setData("application/x-ed-file-manager",JSON.stringify(n)),a.dataTransfer.effectAllowed="move"},_e=async(e,a)=>{if(i)return;a.preventDefault(),a.stopPropagation(),v(null);const n=a.dataTransfer.getData("application/x-ed-file-manager");if(n)try{const o=JSON.parse(n).filter(u=>u!==e);if(o.length===0)return;await W(o,e),l()}catch{}},X=(e,a,n)=>{if(i)return;e.preventDefault(),e.stopPropagation();const c=J.current?.getBoundingClientRect(),o=c?e.clientX-c.left:e.clientX,u=c?e.clientY-c.top:e.clientY;if(a&&n!=null){d.includes(a.id)||(w([a.id]),_(n)),h({isOpen:!0,x:o,y:u,targetFolderId:a.type==="folder"?a.id:m});return}h({isOpen:!0,x:o,y:u,targetFolderId:m})},ye=e=>{const a=e.trim();if(!a)return"";let n=a.replace(/[\\/:*?"<>|]/g,"-");return n=n.replace(/[\u0000-\u001f]/g,""),n=n.replace(/\s+/g," "),n=n.replace(/^\.+/,"").replace(/\.+$/,""),n.trim()},P=r.useCallback(async()=>{if(i||d.length!==1)return;const e=d[0],a=f.find(u=>u.id===e);if(!a)return;const n=window.prompt(s("widgets.file_manager.rename_prompt"),a.name);if(n===null)return;const c=ye(n);if(!c){window.alert(s("widgets.file_manager.rename_invalid"));return}if(c===a.name)return;if(f.some(u=>u.id!==a.id&&u.name===c)){window.alert(s("widgets.file_manager.rename_duplicate"));return}await Fe(a.id,c),l(),w([a.id])},[f,i,l,d,s]),je=async e=>{y&&(y.mode==="copy"?await qe(y.entryIds,e):(await W(y.entryIds,e),L(null)),l())},Ee=async()=>{d.length!==0&&(await Promise.all(d.map(e=>ae(e))),l(),w([]),_(null))},Ne=async()=>{d.length!==0&&window.confirm(s("widgets.file_manager.delete_confirm"))&&(await Promise.all(d.map(e=>S(e))),l(),w([]),_(null))};return r.useEffect(()=>{const e=a=>{a.key!=="F2"||a.target?.closest('input, textarea, select, [contenteditable="true"]')||d.length!==1||i||(a.preventDefault(),P())};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[P,i,d.length]),t.jsxs("div",{ref:J,className:"file-manager-widget",onDragOver:e=>e.preventDefault(),onDrop:de,children:[t.jsx(Pe,{children:t.jsxs("div",{className:"file-manager-toolbar",children:[t.jsx("button",{className:"file-manager-button",onClick:we,disabled:m===E||i,title:s("widgets.file_manager.up"),children:t.jsx(We,{size:16})}),t.jsx("div",{className:"file-manager-breadcrumbs",children:t.jsx(it,{breadcrumb:le,onNavigate:g,disabled:i})}),t.jsx("div",{className:"file-manager-spacer"}),t.jsxs("button",{className:"file-manager-button",onClick:ce,disabled:i,children:[t.jsx(Qe,{size:16}),s("widgets.file_manager.new_folder")]}),t.jsxs("button",{className:"file-manager-button",onClick:()=>H.current?.click(),disabled:i,children:[t.jsx(Ge,{size:16}),s("widgets.file_manager.upload")]}),t.jsxs("button",{className:"file-manager-button",onClick:()=>O(e=>!e),children:[t.jsx(I,{size:16}),s(i?"widgets.file_manager.exit_trash":"widgets.file_manager.open_trash")]}),t.jsx("button",{className:"file-manager-icon-only",onClick:()=>window.dispatchEvent(new CustomEvent("open-widget",{detail:{widgetId:"local-web"}})),title:s("widgets.local_web.tooltip"),"aria-label":s("widgets.local_web.tooltip"),children:t.jsx("img",{src:Q("icons/LocalWeb.png"),alt:"",className:"h-5 w-5"})}),i&&t.jsxs("button",{className:"file-manager-button",onClick:pe,children:[t.jsx(I,{size:16}),s("widgets.file_manager.empty_trash_button")]})]})}),t.jsxs("div",{className:"file-manager-usage",children:[t.jsx("div",{className:"file-manager-usage-bar",children:t.jsx("div",{className:"file-manager-usage-fill",style:{width:F?`${F}%`:"0%"}})}),t.jsx("span",{className:"file-manager-usage-text",children:p.usage!=null&&p.quota!=null?s("widgets.file_manager.storage_usage",{used:B(p.usage),total:B(p.quota),percent:F??0}):s("widgets.file_manager.storage_unknown")}),i&&t.jsxs("div",{className:"file-manager-trash-settings",children:[t.jsx("label",{htmlFor:"trash-ttl",children:s("widgets.file_manager.trash_ttl")}),t.jsx("select",{id:"trash-ttl",value:D,onChange:e=>re(Number(e.target.value)),children:nt.map(e=>t.jsx("option",{value:e,children:s("widgets.file_manager.trash_option",{hours:e})},e))})]})]}),t.jsxs("div",{className:"file-manager-list",onClick:e=>{e.target===e.currentTarget&&(w([]),_(null))},onContextMenu:e=>X(e),children:[q&&t.jsxs("div",{className:"file-manager-feedback",role:"status","aria-live":"polite",children:[t.jsx("span",{className:"file-manager-spinner","aria-hidden":"true"}),t.jsx("span",{children:q})]}),se?t.jsx("div",{className:"file-manager-empty",children:s("loading")}):R.length===0?t.jsx("div",{className:"file-manager-empty",children:s(i?"widgets.file_manager.empty_trash":"widgets.file_manager.empty_folder")}):R.map((e,a)=>t.jsxs("div",{className:"file-manager-row",children:[t.jsxs("button",{className:`file-manager-entry${d.includes(e.id)?" selected":""}${U===e.id?" drag-over":""}`,onClick:n=>xe(e.id,a,n),onDoubleClick:()=>ue(e),draggable:!i,onDragStart:n=>be(e,n),onDragOver:n=>{e.type!=="folder"||i||(n.preventDefault(),v(e.id))},onDragLeave:()=>{U===e.id&&v(null)},onDrop:n=>{e.type!=="folder"||i||_e(e.id,n)},onContextMenu:n=>X(n,e,a),children:[oe(e),t.jsx("span",{className:"file-manager-entry-name",children:e.name}),e.type==="file"&&e.size!=null&&t.jsx("span",{className:"file-manager-entry-size",children:B(e.size)}),e.sourceWidgetId&&t.jsx("span",{className:"file-manager-entry-source",children:e.sourceWidgetTitleKey?s(e.sourceWidgetTitleKey):e.sourceWidgetId})]}),t.jsxs("div",{className:"file-manager-actions",children:[e.type==="file"&&!i&&t.jsx("button",{className:"file-manager-icon-button",onClick:()=>he(e),title:s("widgets.file_manager.download"),children:t.jsx(Ae,{size:16})}),i?t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"file-manager-icon-button",onClick:()=>fe(e),title:s("widgets.file_manager.restore"),children:s("widgets.file_manager.restore")}),t.jsx("button",{className:"file-manager-icon-button danger",onClick:()=>ge(e),title:s("widgets.file_manager.delete_permanent"),children:s("widgets.file_manager.delete_permanent")})]}):t.jsx("button",{className:"file-manager-icon-button danger",onClick:()=>me(e),title:s("widgets.file_manager.move_to_trash"),children:t.jsx(I,{size:16})})]})]},e.id))]}),t.jsx("input",{type:"file",ref:H,onChange:e=>V(e.target.files),multiple:!0,className:"hidden"}),j.isOpen&&t.jsxs("div",{ref:Y,className:"file-manager-context-menu",style:{left:j.x,top:j.y},children:[t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{L({mode:"copy",entryIds:d}),h(e=>({...e,isOpen:!1}))},disabled:d.length===0,children:[t.jsx(He,{size:14}),s("widgets.file_manager.copy")]}),t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{L({mode:"cut",entryIds:d}),h(e=>({...e,isOpen:!1}))},disabled:d.length===0,children:[t.jsx(tt,{size:14}),s("widgets.file_manager.cut")]}),t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{je(j.targetFolderId),h(e=>({...e,isOpen:!1}))},disabled:!y||y.entryIds.length===0,children:[t.jsx(Xe,{size:14}),s("widgets.file_manager.paste")]}),t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{P(),h(e=>({...e,isOpen:!1}))},disabled:d.length!==1||i,children:[t.jsx(Be,{size:14}),s("widgets.file_manager.rename")]}),t.jsx("div",{className:"file-manager-context-separator"}),t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{Ee(),h(e=>({...e,isOpen:!1}))},disabled:d.length===0,children:[t.jsx(I,{size:14,className:"text-gray-600"}),s("widgets.file_manager.move_to_trash")]}),t.jsxs("button",{className:"file-manager-context-item danger",onClick:()=>{Ne(),h(e=>({...e,isOpen:!1}))},disabled:d.length===0,children:[t.jsx(Je,{size:14}),s("widgets.file_manager.delete_permanent")]})]}),$&&t.jsx("div",{className:"file-manager-toast",role:"status","aria-live":"polite",children:$})]})},it=({breadcrumb:s,onNavigate:m,disabled:g})=>{const[f,k]=r.useState([]);return r.useEffect(()=>{let i=!0;return s.then(O=>{i&&k(O)}),()=>{i=!1}},[s]),f.length===0?null:t.jsx(t.Fragment,{children:f.map(i=>t.jsxs("button",{className:"file-manager-breadcrumb",onClick:()=>m(i.id),disabled:g,children:["/ ",i.name]},i.id))})};export{ct as FileManagerWidget,mt as widgetConfig};
