import{c as y,u as he,r,F as E,a as pe,y as H,z as we,A as xe,B as ye,j as t,C as _e,T as C,G as be,D as je,H as K,J as I,K as W,L as z,g as Ee,M as Ne,N as ke,O as G,P as ve}from"./index-DVJj0eXH.js";import{Q as Ye}from"./index-DVJj0eXH.js";import{C as Ce}from"./cloud-upload-6Lq9WG0c.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],Me=y("circle-x",Ie);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=[["path",{d:"M11 14h10",key:"1w8e9d"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v1.344",key:"1e62lh"}],["path",{d:"m17 18 4-4-4-4",key:"z2g111"}],["path",{d:"M8 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 1.793-1.113",key:"bjbb7m"}],["rect",{x:"8",y:"2",width:"8",height:"4",rx:"1",key:"ublpy"}]],Te=y("clipboard-paste",Se);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oe=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],De=y("copy",Oe);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}]],ze=y("file",Le);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=[["path",{d:"M12 10v6",key:"1bos4e"}],["path",{d:"M9 13h6",key:"1uhe8q"}],["path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z",key:"1kt360"}]],Re=y("folder-plus",Fe);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pe=[["path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z",key:"1kt360"}]],Ae=y("folder",Pe);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=[["circle",{cx:"6",cy:"6",r:"3",key:"1lh9wr"}],["path",{d:"M8.12 8.12 12 12",key:"1alkpv"}],["path",{d:"M20 4 8.12 15.88",key:"xgtan2"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["path",{d:"M14.8 14.8 20 20",key:"ptml3r"}]],$e=y("scissors",Be),qe=1,Ue=[1,6,12,24],V="file-manager-guide-seeded",F=n=>{if(n<1024)return`${n} B`;const d=["KB","MB","GB","TB"];let g=n/1024,f=0;for(;g>=1024&&f<d.length-1;)g/=1024,f+=1;return`${g.toFixed(g>=10?0:1)} ${d[f]}`},Ge=()=>{const{t:n}=he(),[d,g]=r.useState(E),[f,N]=r.useState([]),[i,M]=r.useState(!1),[J,R]=r.useState(!1),[h,Y]=r.useState({usage:null,quota:null}),[S,X]=pe("file-manager-trash-ttl-hours",qe),[m,w]=r.useState([]),[T,_]=r.useState(null),[P,k]=r.useState(null),[b,O]=r.useState(null),[j,p]=r.useState({isOpen:!1,x:0,y:0,targetFolderId:E}),A=r.useRef(null),B=r.useRef(null),$=r.useRef(null),o=r.useCallback(async()=>{R(!0);try{if(i){const e=await H();N(e)}else{const e=await we(d);N(e)}}finally{R(!1)}},[d,i]);r.useEffect(()=>{o(),w([]),_(null)},[o]),r.useEffect(()=>{if(!j.isOpen)return;const e=s=>{B.current?.contains(s.target)||p(c=>({...c,isOpen:!1}))},a=s=>{s.key==="Escape"&&p(c=>({...c,isOpen:!1}))};return window.addEventListener("mousedown",e),window.addEventListener("keydown",a),window.addEventListener("scroll",e,!0),()=>{window.removeEventListener("mousedown",e),window.removeEventListener("keydown",a),window.removeEventListener("scroll",e,!0)}},[j.isOpen]),r.useEffect(()=>{const e=()=>o();return window.addEventListener("file-manager-refresh",e),()=>window.removeEventListener("file-manager-refresh",e)},[o]),r.useEffect(()=>{const e=Math.max(1,S)*60*60*1e3;xe(e).then(()=>o())},[o,S]),r.useEffect(()=>{let e=!0;return(async()=>{const s=window.localStorage.getItem(V)==="1";s||window.localStorage.setItem(V,"1");const l=(await K()).filter(u=>u.sourceWidgetId==="program-guide");if(l.length>1){const u=[...l].sort((x,fe)=>x.createdAt-fe.createdAt),[,...v]=u;await Promise.all(v.map(x=>I(x.id)))}if(l.length>0){e&&o();return}s||(await W({name:n("widgets.program_guide.title"),parentId:E,blob:new Blob([""],{type:"text/plain"}),mime:"text/plain",sourceWidgetId:"program-guide",sourceWidgetTitleKey:"widgets.program_guide.title"}),e&&o())})(),()=>{e=!1}},[o,n]),r.useEffect(()=>{let e=!0;return ye().then(a=>{e&&Y(a)}),()=>{e=!1}},[f.length]);const Z=r.useMemo(()=>(async()=>{const a=await K(),s=new Map(a.map(u=>[u.id,u])),c=[];let l=s.get(d);for(;l&&l.id!==E;)c.unshift(l),l=s.get(l.parentId);return c})(),[d]),D=r.useMemo(()=>{const e=[...f];return e.sort((a,s)=>a.type!==s.type?a.type==="folder"?-1:1:a.name.localeCompare(s.name)),e},[f]),L=r.useMemo(()=>h.usage==null||h.quota==null?null:Math.min(100,Math.round(h.usage/h.quota*100)),[h.quota,h.usage]),Q=async()=>{const e=window.prompt(n("widgets.file_manager.new_folder_prompt"));if(!e)return;const a=e.trim();a&&(await Ne(a,d),o())},q=async e=>{if(i||!e||e.length===0)return;const a=Array.from(e).map(s=>W({name:s.name,parentId:d,blob:s,mime:s.type}));await Promise.all(a),o()},ee=e=>{if(e.preventDefault(),i)return;k(null);const a=e.dataTransfer.getData("application/x-ed-file-manager");if(a){try{const s=JSON.parse(a);z(s,d).then(o)}catch{}return}q(e.dataTransfer.files)},te=async e=>{if(i)return;if(e.type==="folder"){g(e.id);return}const a=e.sourceWidgetId||"file-opener";window.dispatchEvent(new CustomEvent("file-manager-open",{detail:{widgetId:a,entryId:e.id}}))},ae=async e=>{await G(e.id),o()},se=async e=>{await ke(e.id),o()},ne=async e=>{window.confirm(n("widgets.file_manager.delete_confirm"))&&(await I(e.id),o())},ie=async()=>{if(!window.confirm(n("widgets.file_manager.empty_trash_confirm")))return;const e=await H();e.length!==0&&(await Promise.all(e.map(a=>I(a.id))),o())},re=async e=>{if(!e.blob)return;const a=URL.createObjectURL(e.blob),s=document.createElement("a");s.href=a,s.download=e.name,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(a)},le=async()=>{if(d===E)return;const e=await Ee(d);e&&g(e.parentId)},oe=(e,a,s)=>{if(i)return;const c=s.metaKey||s.ctrlKey;if(s.shiftKey&&T!==null){const l=Math.min(T,a),u=Math.max(T,a),v=D.slice(l,u+1).map(x=>x.id);w(x=>c?Array.from(new Set([...x,...v])):v)}else w(c?l=>l.includes(e)?l.filter(u=>u!==e):[...l,e]:[e]);_(a)},de=(e,a)=>{if(i)return;const s=m.includes(e.id)?m:[e.id];a.dataTransfer.setData("application/x-ed-file-manager",JSON.stringify(s)),a.dataTransfer.effectAllowed="move"},ce=async(e,a)=>{if(i)return;a.preventDefault(),a.stopPropagation(),k(null);const s=a.dataTransfer.getData("application/x-ed-file-manager");if(s)try{const l=JSON.parse(s).filter(u=>u!==e);if(l.length===0)return;await z(l,e),o()}catch{}},U=(e,a,s)=>{if(i)return;e.preventDefault(),e.stopPropagation();const c=$.current?.getBoundingClientRect(),l=c?e.clientX-c.left:e.clientX,u=c?e.clientY-c.top:e.clientY;if(a&&s!=null){m.includes(a.id)||(w([a.id]),_(s)),p({isOpen:!0,x:l,y:u,targetFolderId:a.type==="folder"?a.id:d});return}p({isOpen:!0,x:l,y:u,targetFolderId:d})},ue=async e=>{b&&(b.mode==="copy"?await ve(b.entryIds,e):(await z(b.entryIds,e),O(null)),o())},me=async()=>{m.length!==0&&(await Promise.all(m.map(e=>G(e))),o(),w([]),_(null))},ge=async()=>{m.length!==0&&window.confirm(n("widgets.file_manager.delete_confirm"))&&(await Promise.all(m.map(e=>I(e))),o(),w([]),_(null))};return t.jsxs("div",{ref:$,className:"file-manager-widget",onDragOver:e=>e.preventDefault(),onDrop:ee,children:[t.jsxs("div",{className:"file-manager-toolbar",children:[t.jsx("button",{className:"file-manager-button",onClick:le,disabled:d===E||i,title:n("widgets.file_manager.up"),children:t.jsx(_e,{size:16})}),t.jsx("div",{className:"file-manager-breadcrumbs",children:t.jsx(He,{breadcrumb:Z,onNavigate:g,disabled:i})}),t.jsx("div",{className:"file-manager-spacer"}),t.jsxs("button",{className:"file-manager-button",onClick:Q,disabled:i,children:[t.jsx(Re,{size:16}),n("widgets.file_manager.new_folder")]}),t.jsxs("button",{className:"file-manager-button",onClick:()=>A.current?.click(),disabled:i,children:[t.jsx(Ce,{size:16}),n("widgets.file_manager.upload")]}),t.jsxs("button",{className:"file-manager-button",onClick:()=>M(e=>!e),children:[t.jsx(C,{size:16}),n(i?"widgets.file_manager.exit_trash":"widgets.file_manager.open_trash")]}),t.jsx("button",{className:"file-manager-icon-only",onClick:()=>window.dispatchEvent(new CustomEvent("open-widget",{detail:{widgetId:"local-web"}})),title:n("widgets.local_web.tooltip"),"aria-label":n("widgets.local_web.tooltip"),children:t.jsx("img",{src:be("icons/LocalWeb.png"),alt:"",className:"h-5 w-5"})}),i&&t.jsxs("button",{className:"file-manager-button",onClick:ie,children:[t.jsx(C,{size:16}),n("widgets.file_manager.empty_trash_button")]})]}),t.jsxs("div",{className:"file-manager-usage",children:[t.jsx("div",{className:"file-manager-usage-bar",children:t.jsx("div",{className:"file-manager-usage-fill",style:{width:L?`${L}%`:"0%"}})}),t.jsx("span",{className:"file-manager-usage-text",children:h.usage!=null&&h.quota!=null?n("widgets.file_manager.storage_usage",{used:F(h.usage),total:F(h.quota),percent:L??0}):n("widgets.file_manager.storage_unknown")}),i&&t.jsxs("div",{className:"file-manager-trash-settings",children:[t.jsx("label",{htmlFor:"trash-ttl",children:n("widgets.file_manager.trash_ttl")}),t.jsx("select",{id:"trash-ttl",value:S,onChange:e=>X(Number(e.target.value)),children:Ue.map(e=>t.jsx("option",{value:e,children:n("widgets.file_manager.trash_option",{hours:e})},e))})]})]}),t.jsx("div",{className:"file-manager-list",onClick:e=>{e.target===e.currentTarget&&(w([]),_(null))},onContextMenu:e=>U(e),children:J?t.jsx("div",{className:"file-manager-empty",children:n("loading")}):D.length===0?t.jsx("div",{className:"file-manager-empty",children:n(i?"widgets.file_manager.empty_trash":"widgets.file_manager.empty_folder")}):D.map((e,a)=>t.jsxs("div",{className:"file-manager-row",children:[t.jsxs("button",{className:`file-manager-entry${m.includes(e.id)?" selected":""}${P===e.id?" drag-over":""}`,onClick:s=>oe(e.id,a,s),onDoubleClick:()=>te(e),draggable:!i,onDragStart:s=>de(e,s),onDragOver:s=>{e.type!=="folder"||i||(s.preventDefault(),k(e.id))},onDragLeave:()=>{P===e.id&&k(null)},onDrop:s=>{e.type!=="folder"||i||ce(e.id,s)},onContextMenu:s=>U(s,e,a),children:[e.type==="folder"?t.jsx(Ae,{size:18}):t.jsx(ze,{size:18}),t.jsx("span",{className:"file-manager-entry-name",children:e.name}),e.type==="file"&&e.size!=null&&t.jsx("span",{className:"file-manager-entry-size",children:F(e.size)}),e.sourceWidgetId&&t.jsx("span",{className:"file-manager-entry-source",children:n("widgets.file_manager.saved_from",{widget:e.sourceWidgetTitleKey?n(e.sourceWidgetTitleKey):e.sourceWidgetId})})]}),t.jsxs("div",{className:"file-manager-actions",children:[e.type==="file"&&!i&&t.jsx("button",{className:"file-manager-icon-button",onClick:()=>re(e),title:n("widgets.file_manager.download"),children:t.jsx(je,{size:16})}),i?t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"file-manager-icon-button",onClick:()=>se(e),title:n("widgets.file_manager.restore"),children:n("widgets.file_manager.restore")}),t.jsx("button",{className:"file-manager-icon-button danger",onClick:()=>ne(e),title:n("widgets.file_manager.delete_permanent"),children:n("widgets.file_manager.delete_permanent")})]}):t.jsx("button",{className:"file-manager-icon-button danger",onClick:()=>ae(e),title:n("widgets.file_manager.move_to_trash"),children:t.jsx(C,{size:16})})]})]},e.id))}),t.jsx("input",{type:"file",ref:A,onChange:e=>q(e.target.files),multiple:!0,className:"hidden"}),j.isOpen&&t.jsxs("div",{ref:B,className:"file-manager-context-menu",style:{left:j.x,top:j.y},children:[t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{O({mode:"copy",entryIds:m}),p(e=>({...e,isOpen:!1}))},disabled:m.length===0,children:[t.jsx(De,{size:14}),n("widgets.file_manager.copy")]}),t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{O({mode:"cut",entryIds:m}),p(e=>({...e,isOpen:!1}))},disabled:m.length===0,children:[t.jsx($e,{size:14}),n("widgets.file_manager.cut")]}),t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{ue(j.targetFolderId),p(e=>({...e,isOpen:!1}))},disabled:!b||b.entryIds.length===0,children:[t.jsx(Te,{size:14}),n("widgets.file_manager.paste")]}),t.jsx("div",{className:"file-manager-context-separator"}),t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{me(),p(e=>({...e,isOpen:!1}))},disabled:m.length===0,children:[t.jsx(C,{size:14,className:"text-gray-600"}),n("widgets.file_manager.move_to_trash")]}),t.jsxs("button",{className:"file-manager-context-item danger",onClick:()=>{ge(),p(e=>({...e,isOpen:!1}))},disabled:m.length===0,children:[t.jsx(Me,{size:14}),n("widgets.file_manager.delete_permanent")]})]})]})},He=({breadcrumb:n,onNavigate:d,disabled:g})=>{const[f,N]=r.useState([]);return r.useEffect(()=>{let i=!0;return n.then(M=>{i&&N(M)}),()=>{i=!1}},[n]),f.length===0?null:t.jsx(t.Fragment,{children:f.map(i=>t.jsxs("button",{className:"file-manager-breadcrumb",onClick:()=>d(i.id),disabled:g,children:["/ ",i.name]},i.id))})};export{Ge as FileManagerWidget,Ye as widgetConfig};
