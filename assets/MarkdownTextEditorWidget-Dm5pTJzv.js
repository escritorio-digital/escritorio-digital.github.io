import{c as S,u as pt,r as c,f as xt,j as r,W as ft,ae as ht,ak as gt,F as kt,a8 as _t,h as K}from"./index-Ha-A2SqS.js";import{al as se}from"./index-Ha-A2SqS.js";import{d as yt}from"./marked.esm-IrHqQMcX.js";import{k as bt}from"./katex.min-2TduxwG8.js";import{S as vt,a as Et,s as rt,r as jt,d as It}from"./saveDialog-5GOlg44P.js";import{r as Ct}from"./openDialog-H-OCpcqq.js";import{B as St,I as $t,S as Nt,H as Mt,a as Tt,b as zt,L as Lt,c as Ft,T as Ot,C as Rt}from"./text-CGWWhHJz.js";import{C as Ht}from"./code-C5N73NlZ.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pt=[["path",{d:"m18 16 4-4-4-4",key:"1inbqp"}],["path",{d:"m6 8-4 4 4 4",key:"15zrgr"}],["path",{d:"m14.5 4-5 16",key:"e7oirm"}]],Wt=S("code-xml",Pt);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qt=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M12 3v18",key:"108xh3"}]],At=S("columns-2",qt);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Dt=[["path",{d:"M4 22h14a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v4",key:"1pf5j1"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"m5 12-3 3 3 3",key:"oke12k"}],["path",{d:"m9 18 3-3-3-3",key:"112psh"}]],Vt=S("file-code-2",Dt);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bt=[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]],Jt=S("link-2",Bt);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Kt=[["path",{d:"M16 3a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2 1 1 0 0 1 1 1v1a2 2 0 0 1-2 2 1 1 0 0 0-1 1v2a1 1 0 0 0 1 1 6 6 0 0 0 6-6V5a2 2 0 0 0-2-2z",key:"rib7q0"}],["path",{d:"M5 3a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2 1 1 0 0 1 1 1v1a2 2 0 0 1-2 2 1 1 0 0 0-1 1v2a1 1 0 0 0 1 1 6 6 0 0 0 6-6V5a2 2 0 0 0-2-2z",key:"1ymkrd"}]],Ut=S("quote",Kt),ot="https://edicuatex.github.io";function U($,o,R={}){const E=[],k=(l,w)=>{const a=bt.renderToString(l.trim(),{throwOnError:!1,displayMode:w,output:R.katexOutput}),m=`%%MATH_${E.length}%%`;return E.push({token:m,html:a}),m};let d=o;d=d.replace(/\\\[((?:.|\n)+?)\\\]/g,(l,w)=>k(w,!0)),d=d.replace(/\$\$([\s\S]+?)\$\$/g,(l,w)=>k(w,!0)),d=d.replace(/\\\((.+?)\\\)/g,(l,w)=>k(w,!1)),d=d.replace(/\$([\s\S]+?)\$/g,(l,w)=>k(w,!1));let h=yt.parse(d);E.forEach(({token:l,html:w})=>{h=h.replace(l,w)}),$.innerHTML=h}const ne=({instanceId:$})=>{const{t:o,i18n:R,ready:E}=pt(),k=c.useRef($??`markdown-text-editor-${Date.now()}-${Math.random().toString(16).slice(2)}`),d=$??k.current,h=`markdown-text-editor-draft:${d}`,l=c.useRef(null);if(!l.current)try{const t=window.localStorage.getItem(h);if(t){const e=JSON.parse(t);e&&typeof e.input=="string"&&(l.current={input:e.input,lastSavedSnapshot:typeof e.lastSavedSnapshot=="string"?e.lastSavedSnapshot:"",viewMode:e.viewMode==="editor"||e.viewMode==="preview"||e.viewMode==="split"?e.viewMode:"split",currentFilename:typeof e.currentFilename=="string"?e.currentFilename:null,currentParentId:typeof e.currentParentId=="string"?e.currentParentId:null,currentEntryId:typeof e.currentEntryId=="string"?e.currentEntryId:null})}}catch{l.current=null}const w=c.useRef(o("widgets.markdown_text_editor.sample_content")),[a,m]=c.useState(l.current?.input??w.current),[X,G]=c.useState(""),[_,j]=c.useState(l.current?.lastSavedSnapshot??""),[y,H]=c.useState(l.current?.viewMode??"split"),[I,P]=c.useState(l.current?.currentFilename??null),[W,N]=c.useState(l.current?.currentParentId??null),[M,Q]=c.useState(l.current?.currentEntryId??null),p=c.useRef(null),Y=c.useRef(null),q=c.useRef(null),g=c.useRef(null),st=c.useMemo(()=>{const t=new URL(`${ot}/index.html`);return t.searchParams.set("pm","1"),t.searchParams.set("origin",window.location.origin),t},[]);c.useEffect(()=>{const t=o("widgets.markdown_text_editor.sample_content");!l.current&&a===w.current&&m(t),w.current=t},[o,R.language,a]),c.useEffect(()=>{const t={input:a,lastSavedSnapshot:_,viewMode:y,currentFilename:I,currentParentId:W,currentEntryId:M};window.localStorage.setItem(h,JSON.stringify(t))},[h,a,_,y,I,W,M]),c.useEffect(()=>{const t=e=>{const n=e;n.detail?.instanceId===d&&(n.detail?.widgetId&&n.detail.widgetId!=="markdown-text-editor"||window.localStorage.removeItem(h))};return window.addEventListener("widget-close",t),()=>window.removeEventListener("widget-close",t)},[h,d]),c.useEffect(()=>{const t=q.current;if(t)return document.body.appendChild(t),()=>{t.parentNode&&t.parentNode.removeChild(t)}},[]);const C=t=>{G(t),setTimeout(()=>G(""),1800)},b=(t,e)=>{const n=p.current;n&&requestAnimationFrame(()=>{n.focus(),n.setSelectionRange(t,e)})},T=(t,e,n)=>{const i=p.current;if(!i)return;const s=i.selectionStart,u=i.selectionEnd,f=a.slice(s,u)||n,v=`${a.slice(0,s)}${t}${f}${e}${a.slice(u)}`;m(v),b(s+t.length,s+t.length+f.length)},A=t=>{const e=p.current;if(!e)return;const n=e.selectionStart,i=e.selectionEnd,s=a,u=s.lastIndexOf(`
`,n-1)+1,x=s.indexOf(`
`,i),f=x===-1?s.length:x,J=s.slice(u,f).split(`
`),z=J.every(O=>O.startsWith(t)),L=J.map(O=>z?O.slice(t.length):`${t}${O}`).join(`
`),F=`${s.slice(0,u)}${L}${s.slice(f)}`;m(F);const nt=u+L.length;b(nt,nt)},D=t=>{const e=`${"#".repeat(t)} `,n=p.current;if(!n)return;const i=n.selectionStart,s=a,u=s.lastIndexOf(`
`,i-1)+1,x=s.indexOf(`
`,i),f=x===-1?s.length:x,v=s.slice(u,f),z=v.startsWith(e)?v.slice(e.length):`${e}${v}`,L=`${s.slice(0,u)}${z}${s.slice(f)}`;m(L);const F=u+z.length;b(F,F)},it=()=>{const t=p.current;if(!t)return;const e=t.selectionStart,n=t.selectionEnd,i=a.slice(e,n)||o("widgets.markdown_text_editor.placeholders.code"),s="```\n",x=`${a.slice(0,e)}${s}${i}
\`\`\`${a.slice(n)}`;m(x),b(e+s.length,e+s.length+i.length)},at=()=>{const t=p.current;if(!t)return;const e=t.selectionStart,n=t.selectionEnd,i=a.slice(e,n)||o("widgets.markdown_text_editor.placeholders.link_text"),s=window.prompt(o("widgets.markdown_text_editor.prompts.link_url"));if(!s)return;const u=`[${i}](${s})`,x=`${a.slice(0,e)}${u}${a.slice(n)}`;m(x),b(e+1,e+1+i.length)},Z=c.useCallback(t=>{const e=p.current;if(!e)return;const n=e.selectionStart,i=e.selectionEnd;m(s=>`${s.slice(0,n)}${t}${s.slice(i)}`),b(n+t.length,n+t.length)},[]),dt=()=>{navigator.clipboard.writeText(a).then(()=>C(o("widgets.markdown_text_editor.source_copied"))).catch(()=>C(o("widgets.markdown_text_editor.copy_failed")))},ct=()=>{const t=document.createElement("div");try{U(t,a,{katexOutput:"html"})}catch(s){const u=s instanceof Error?s.message:o("widgets.markdown_text_editor.preview_error");t.innerHTML=`<div class="error-message">${u}</div>`}const n=(()=>{let s="";for(const u of Array.from(document.styleSheets))try{const x=Array.from(u.cssRules||[]);for(const f of x)f.cssText.includes(".katex")&&(s+=f.cssText)}catch{}return s.trim()})(),i=n?`<style>${n}</style>${t.innerHTML}`:t.innerHTML;navigator.clipboard.writeText(i).then(()=>C(o("widgets.markdown_text_editor.html_copied"))).catch(()=>C(o("widgets.markdown_text_editor.copy_failed")))},tt=async()=>{const t=new Blob([a],{type:"text/markdown;charset=utf-8"}),e=I||o("widgets.markdown_text_editor.default_filename"),n=await jt(e,{sourceWidgetId:"markdown-text-editor"});if(!n)return;n?.destination==="file-manager"?(await rt({blob:t,filename:n.filename,sourceWidgetId:"markdown-text-editor",sourceWidgetTitleKey:"widgets.markdown_text_editor.title",parentId:n.parentId}),N(n.parentId)):n?.destination==="download"&&(It(t,n.filename),N(null)),window.dispatchEvent(new CustomEvent("widget-title-update",{detail:{instanceId:d,title:n.filename}})),P(n.filename),window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:d,widgetId:"markdown-text-editor",isDirty:!1}}));const i=JSON.stringify({input:a});j(i),window.dispatchEvent(new CustomEvent("widget-save-complete",{detail:{instanceId:d,widgetId:"markdown-text-editor"}}))},V=async()=>{let t=W;if(!t&&M&&(t=(await K(M))?.parentId??null),I&&t){const e=new Blob([a],{type:"text/markdown;charset=utf-8"});await rt({blob:e,filename:I,sourceWidgetId:"markdown-text-editor",sourceWidgetTitleKey:"widgets.markdown_text_editor.title",parentId:t}),window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:d,widgetId:"markdown-text-editor",isDirty:!1}}));const n=JSON.stringify({input:a});j(n),window.dispatchEvent(new CustomEvent("widget-save-complete",{detail:{instanceId:d,widgetId:"markdown-text-editor"}}));return}await tt()},et=async(t,e,n)=>{const i=await t.text();m(i),j(JSON.stringify({input:i})),window.dispatchEvent(new CustomEvent("widget-title-update",{detail:{instanceId:d,title:t.name}})),P(t.name),N(e??null),Q(n??null),window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:d,widgetId:"markdown-text-editor",isDirty:!1}}))},lt=async()=>{const t=await Ct({accept:".md,.txt",sourceWidgetId:"markdown-text-editor"});if(!t)return;if(t.source==="local"){const[s]=t.files;s&&await et(s,null,null);return}const[e]=t.entryIds;if(!e)return;const n=await K(e);if(!n?.blob)return;const i=new File([n.blob],n.name,{type:n.mime||n.blob.type});await et(i,n.parentId,n.id)},ut=async()=>{const t=q.current;if(!t)return;U(t,a);try{await document.fonts?.ready}catch{}await new Promise(n=>requestAnimationFrame(()=>n()));const e=()=>{t.innerHTML="",window.removeEventListener("afterprint",e)};window.addEventListener("afterprint",e),window.print()},wt=()=>{const t=p.current?p.current.value.slice(p.current.selectionStart,p.current.selectionEnd).trim():"",e=new URL(st.toString());if(t&&e.searchParams.set("sel",t),g.current&&!g.current.closed){g.current.focus();return}const n=window.open(e.toString(),"edicuatex","width=1100,height=800,menubar=no,toolbar=no,location=no,status=no");if(!n){C(o("widgets.markdown_text_editor.popup_blocked"));return}g.current=n};c.useEffect(()=>{const t=e=>{if(e.origin!==ot||!e.data||e.data.type!=="edicuatex:result")return;const n=e.data,i=n.latex?`$$${n.latex}$$`:"",s=n.wrapped||i;s&&(Z(s),g.current&&!g.current.closed&&g.current.close(),g.current=null)};return window.addEventListener("message",t),()=>window.removeEventListener("message",t)},[Z]),c.useEffect(()=>{const t=Y.current;if(t)try{U(t,a)}catch(e){const n=e instanceof Error?e.message:o("widgets.markdown_text_editor.preview_error");t.innerHTML=`<div class="error-message">${n}</div>`}},[a,o]),c.useEffect(()=>{_||j(JSON.stringify({input:a}))},[a,_]),c.useEffect(()=>xt("markdown-text-editor",async({entryId:e,instanceId:n})=>{if(n&&n!==d)return;const i=await K(e);if(!i?.blob)return;const s=await i.blob.text();m(s),j(JSON.stringify({input:s})),window.dispatchEvent(new CustomEvent("widget-title-update",{detail:{instanceId:d,title:i.name}})),P(i.name),N(i.parentId),Q(i.id),window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:d,widgetId:"markdown-text-editor",isDirty:!1}}))}),[]);const mt=c.useMemo(()=>JSON.stringify({input:a}),[a]),B=_!==""&&mt!==_;return c.useEffect(()=>{window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:d,widgetId:"markdown-text-editor",isDirty:B}}))},[B,d]),c.useEffect(()=>{const t=e=>{const n=e;n.detail?.instanceId===d&&(n.detail?.widgetId&&n.detail.widgetId!=="markdown-text-editor"||V())};return window.addEventListener("widget-save-request",t),()=>window.removeEventListener("widget-save-request",t)},[V,d]),c.useEffect(()=>()=>{window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:d,widgetId:"markdown-text-editor",isDirty:!1}}))},[d]),E?r.jsxs(r.Fragment,{children:[r.jsxs("div",{className:`markdown-text-editor-widget view-${y}`,children:[r.jsx(ft,{children:r.jsxs("div",{className:"markdown-toolbar",children:[r.jsxs("div",{className:"markdown-toolbar-group",children:[r.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.bold"),onClick:()=>T("**","**",o("widgets.markdown_text_editor.placeholders.text")),children:r.jsx(St,{size:16})}),r.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.italic"),onClick:()=>T("*","*",o("widgets.markdown_text_editor.placeholders.text")),children:r.jsx($t,{size:16})}),r.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.strike"),onClick:()=>T("~~","~~",o("widgets.markdown_text_editor.placeholders.text")),children:r.jsx(Nt,{size:16})}),r.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.h1"),onClick:()=>D(1),children:r.jsx(Mt,{size:16})}),r.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.h2"),onClick:()=>D(2),children:r.jsx(Tt,{size:16})}),r.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.h3"),onClick:()=>D(3),children:r.jsx(zt,{size:16})}),r.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.bullet_list"),onClick:()=>A("- "),children:r.jsx(Lt,{size:16})}),r.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.ordered_list"),onClick:()=>A("1. "),children:r.jsx(Ft,{size:16})}),r.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.quote"),onClick:()=>A("> "),children:r.jsx(Ut,{size:16})}),r.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.inline_code"),onClick:()=>T("`","`",o("widgets.markdown_text_editor.placeholders.code")),children:r.jsx(Ht,{size:16})}),r.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.code_block"),onClick:it,children:r.jsx(Wt,{size:16})}),r.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.link"),onClick:at,children:r.jsx(Jt,{size:16})})]}),r.jsxs("div",{className:"markdown-toolbar-group",children:[X&&r.jsx("span",{className:"feedback-message",children:X}),r.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.view_split"),onClick:()=>H("split"),className:y==="split"?"is-active":"",children:r.jsx(At,{size:16})}),r.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.view_editor"),onClick:()=>H("editor"),className:y==="editor"?"is-active":"",children:r.jsx(Ot,{size:16})}),r.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.view_preview"),onClick:()=>H("preview"),className:y==="preview"?"is-active":"",children:r.jsx(ht,{size:16})}),r.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.formula"),onClick:wt,children:r.jsx(gt,{size:16})}),r.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.copy_source"),onClick:dt,children:r.jsx(Rt,{size:16})}),r.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.copy_html"),onClick:ct,children:r.jsx(Vt,{size:16})}),r.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.open_file"),onClick:lt,children:r.jsx(kt,{size:16})}),r.jsx("button",{type:"button",title:o("actions.save"),onClick:V,className:"save-indicator-button",children:r.jsxs("span",{className:"save-indicator-icon",children:[r.jsx(vt,{size:16}),B&&r.jsx("span",{className:"save-indicator-dot","aria-hidden":"true"})]})}),r.jsx("button",{type:"button",title:o("actions.save_as"),onClick:tt,children:r.jsx(Et,{size:16})}),r.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.export_pdf"),onClick:ut,children:r.jsx(_t,{size:16})})]})]})}),r.jsxs("div",{className:"markdown-body",children:[r.jsxs("div",{className:"markdown-pane markdown-editor-pane",children:[r.jsx("div",{className:"markdown-pane-header",children:o("widgets.markdown_text_editor.editor_title")}),r.jsx("textarea",{ref:p,value:a,onChange:t=>m(t.target.value),spellCheck:!0,className:"editor-textarea"})]}),r.jsxs("div",{className:"markdown-pane markdown-preview-pane",children:[r.jsx("div",{className:"markdown-pane-header",children:o("widgets.markdown_text_editor.preview_title")}),r.jsx("div",{className:"preview-pane prose",ref:Y})]})]})]}),r.jsx("div",{id:"markdown-text-editor-print",ref:q,className:"prose"})]}):r.jsx("div",{className:"flex items-center justify-center h-full",children:o("loading")})};export{ne as MarkdownTextEditorWidget,se as widgetConfig};
