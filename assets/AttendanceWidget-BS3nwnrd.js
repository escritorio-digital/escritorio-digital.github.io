import{c as W,u as X,r,e as ee,j as n,f as te,U as ne,F as ae,R as se,h as k}from"./index-CmQIKd-y.js";import{i as Ne}from"./index-CmQIKd-y.js";import{P as R}from"./papaparse.min-DkdTayEf.js";import{S as ie,a as de,s as M,r as ce,d as re}from"./saveDialog-BxXDziQd.js";import{r as oe}from"./openDialog-H-OCpcqq.js";import{U as le}from"./user-plus-6J5ZmT2C.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=[["path",{d:"M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.77 4.78 4 4 0 0 1-6.75 0 4 4 0 0 1-4.78-4.77 4 4 0 0 1 0-6.76Z",key:"3c2336"}]],me=W("badge",ue);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],ge=W("triangle-alert",pe),we=l=>{const i=l.getFullYear(),v=String(l.getMonth()+1).padStart(2,"0"),f=String(l.getDate()).padStart(2,"0");return`${i}-${v}-${f}`},ye=({instanceId:l})=>{const{t:i,ready:v}=X(),f=r.useRef(l??`attendance-${Date.now()}-${Math.random().toString(16).slice(2)}`),d=l??f.current,[c,D]=ee("attendance-records",{}),[P,q]=r.useState(()=>new Date),[w,x]=r.useState("attendance"),[y,F]=r.useState(""),[b,h]=r.useState(""),[j,A]=r.useState(null),[J,S]=r.useState(null),[L,K]=r.useState(null),U=[{id:1,icon:"â­",description:i("widgets.attendance.badges.excellent_work")},{id:2,icon:"ðŸ‘",description:i("widgets.attendance.badges.good_participation")},{id:3,icon:"ðŸŽ¯",description:i("widgets.attendance.badges.goal_achieved")},{id:4,icon:"ðŸ¤",description:i("widgets.attendance.badges.helps_classmates")}],V=[{id:1,icon:"ðŸ’¬",description:i("widgets.attendance.alerts.talks_in_class")},{id:2,icon:"ðŸ˜´",description:i("widgets.attendance.alerts.doesnt_work")},{id:3,icon:"ðŸ˜ ",description:i("widgets.attendance.alerts.bad_behavior")},{id:4,icon:"âœï¸",description:i("widgets.attendance.alerts.incomplete_homework")}];if(!v)return n.jsx("div",{className:"flex items-center justify-center h-full",children:i("loading")});const m=we(P),O=()=>{if(c[m])return c[m];const e=Object.keys(c).sort().pop();return e?c[e].map(({id:t,name:a})=>({id:t,name:a,status:"absent",badges:[],alerts:[]})):[]},p=O(),g=e=>{D(t=>({...t,[m]:e}))},$=()=>{if(y.trim()==="")return;const e={id:Date.now(),name:y.trim(),status:"absent",badges:[],alerts:[]},t=O();g([...t,e]),F("")},N=(e,t)=>{const a=p.map(s=>s.id===e?{...s,status:t}:s);g(a)},G=(e,t)=>{const a=p.map(s=>{if(s.id!==e)return s;const o=s.badges.includes(t)?s.badges.filter(u=>u!==t):[...s.badges,t];return{...s,badges:o}});g(a)},Y=(e,t)=>{const a=p.map(s=>{if(s.id!==e)return s;const o=s.alerts.includes(t)?s.alerts.filter(u=>u!==t):[...s.alerts,t];return{...s,alerts:o}});g(a)},E=(e,t,a,s)=>{R.parse(e,{header:!0,skipEmptyLines:!0,complete:o=>{const u=o.data.map(T=>({id:Number(T.id)||Date.now()+Math.random(),name:String(T.name||i("widgets.attendance.no_name")),status:"absent",badges:[],alerts:[]}));g(u),h(JSON.stringify({...c,[m]:u}));const C=t||e.name;C&&(window.dispatchEvent(new CustomEvent("widget-title-update",{detail:{instanceId:d,title:C}})),A(C),S(a??null),K(s??null)),window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:d,widgetId:"attendance",isDirty:!1}}))}})},Z=async()=>{const e=await oe({accept:".csv",sourceWidgetId:"attendance"});if(!e)return;if(e.source==="local"){const[o]=e.files;o&&E(o,void 0,null,null);return}const[t]=e.entryIds;if(!t)return;const a=await k(t);if(!a?.blob)return;const s=new File([a.blob],a.name,{type:a.mime||a.blob.type});E(s,a.name,a.parentId,a.id)},I=b!==""&&JSON.stringify(c)!==b;r.useEffect(()=>{if(!b){h(JSON.stringify(c));return}window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:d,widgetId:"attendance",isDirty:I}}))},[I,b,c,d]),r.useEffect(()=>()=>{window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:d,widgetId:"attendance",isDirty:!1}}))},[d]),r.useEffect(()=>te("attendance",async({entryId:t})=>{const a=await k(t);if(!a?.blob)return;const s=new File([a.blob],a.name,{type:a.mime||a.blob.type});E(s,a.name,a.parentId,a.id)}),[]);const z=()=>{const e=[];Object.keys(c).sort().forEach(a=>{c[a].forEach(s=>{e.push({date:a,id:s.id,name:s.name,status:s.status,badges:s.badges.join(";"),alerts:s.alerts.join(";")})})});const t=R.unparse(e);return new Blob(["\uFEFF"+t],{type:"text/csv;charset=utf-8;"})},B=async()=>{const e=z(),t=await ce(j||"asistencia_completa.csv",{sourceWidgetId:"attendance"});t&&(t?.destination==="file-manager"?(await M({blob:e,filename:t.filename,sourceWidgetId:"attendance",sourceWidgetTitleKey:"widgets.attendance.title",parentId:t.parentId}),S(t.parentId)):t?.destination==="download"&&(re(e,t.filename),S(null)),window.dispatchEvent(new CustomEvent("widget-title-update",{detail:{instanceId:d,title:t.filename}})),A(t.filename),window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:d,widgetId:"attendance",isDirty:!1}})),h(JSON.stringify(c)),window.dispatchEvent(new CustomEvent("widget-save-complete",{detail:{instanceId:d,widgetId:"attendance"}})))},_=async()=>{let e=J;if(!e&&L&&(e=(await k(L))?.parentId??null),j&&e){const t=z();await M({blob:t,filename:j,sourceWidgetId:"attendance",sourceWidgetTitleKey:"widgets.attendance.title",parentId:e}),window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:d,widgetId:"attendance",isDirty:!1}})),h(JSON.stringify(c)),window.dispatchEvent(new CustomEvent("widget-save-complete",{detail:{instanceId:d,widgetId:"attendance"}}));return}await B()};r.useEffect(()=>{const e=t=>{const a=t;a.detail?.instanceId===d&&(a.detail?.widgetId&&a.detail.widgetId!=="attendance"||_())};return window.addEventListener("widget-save-request",e),()=>window.removeEventListener("widget-save-request",e)},[_,d]);const H=()=>{window.confirm(i("widgets.attendance.reset_confirm"))&&D({})},Q=e=>{switch(w){case"attendance":return n.jsxs("div",{className:"controls attendance-controls",children:[n.jsx("button",{onClick:()=>N(e.id,"present"),className:`status-btn present ${e.status==="present"?"active":""}`,children:i("widgets.attendance.present")}),n.jsx("button",{onClick:()=>N(e.id,"absent"),className:`status-btn absent ${e.status==="absent"?"active":""}`,children:i("widgets.attendance.absent")}),n.jsx("button",{onClick:()=>N(e.id,"late"),className:`status-btn late ${e.status==="late"?"active":""}`,children:i("widgets.attendance.late")})]});case"badges":return n.jsx("div",{className:"controls badge-controls",children:U.map(t=>n.jsx("button",{title:t.description,onClick:()=>G(e.id,t.id),className:`badge-btn ${e.badges.includes(t.id)?"active":""}`,children:t.icon},t.id))});case"alerts":return n.jsx("div",{className:"controls alert-controls",children:V.map(t=>n.jsx("button",{title:t.description,onClick:()=>Y(e.id,t.id),className:`alert-btn ${e.alerts.includes(t.id)?"active":""}`,children:t.icon},t.id))})}};return n.jsxs("div",{className:"attendance-widget",children:[n.jsxs("div",{className:"date-controls",children:[n.jsx("label",{htmlFor:"attendance-date",children:i("widgets.attendance.date")}),n.jsx("input",{type:"date",id:"attendance-date",value:m,onChange:e=>{const[t,a,s]=e.target.value.split("-").map(Number);q(new Date(t,a-1,s))}})]}),n.jsxs("div",{className:"main-content",children:[n.jsxs("div",{className:"tabs",children:[n.jsxs("button",{onClick:()=>x("attendance"),className:w==="attendance"?"active":"",children:[n.jsx(ne,{size:16})," ",i("widgets.attendance.attendance_tab")]}),n.jsxs("button",{onClick:()=>x("badges"),className:w==="badges"?"active":"",children:[n.jsx(me,{size:16})," ",i("widgets.attendance.badges_tab")]}),n.jsxs("button",{onClick:()=>x("alerts"),className:w==="alerts"?"active":"",children:[n.jsx(ge,{size:16})," ",i("widgets.attendance.alerts_tab")]})]}),n.jsx("div",{className:"content-area",children:p.length===0?n.jsxs("div",{className:"empty-state",children:[n.jsx("p",{children:i("widgets.attendance.no_students_message")}),n.jsx("p",{className:"text-sm",children:i("widgets.attendance.add_students_instruction")})]}):n.jsx("ul",{className:"student-list",children:p.map(e=>n.jsxs("li",{className:"student-item",children:[n.jsx("span",{className:"student-name",children:e.name}),Q(e)]},e.id))})})]}),n.jsxs("div",{className:"footer",children:[n.jsxs("div",{className:"add-student-form",children:[n.jsx("input",{type:"text",value:y,onChange:e=>F(e.target.value),placeholder:i("widgets.attendance.new_student_placeholder"),onKeyPress:e=>e.key==="Enter"&&$()}),n.jsx("button",{onClick:$,children:n.jsx(le,{size:16})})]}),n.jsxs("div",{className:"actions-group",children:[n.jsx("button",{onClick:Z,className:"action-btn",title:i("widgets.attendance.import_csv_tooltip"),children:n.jsx(ae,{size:16})}),n.jsx("button",{onClick:_,className:"action-btn save-indicator-button",title:i("actions.save"),children:n.jsxs("span",{className:"save-indicator-icon",children:[n.jsx(ie,{size:16}),I&&n.jsx("span",{className:"save-indicator-dot","aria-hidden":"true"})]})}),n.jsx("button",{onClick:B,className:"action-btn",title:i("actions.save_as"),children:n.jsx(de,{size:16})}),n.jsx("button",{onClick:H,className:"action-btn danger",title:i("widgets.attendance.delete_all_tooltip"),children:n.jsx(se,{size:16})})]})]})]})};export{ye as AttendanceWidget,Ne as widgetConfig};
