import{c as y,u as ke,r,x as k,a as ve,y as Z,z as Ne,A as Te,B as Ce,C as Me,j as t,G as Se,T as S,H as Ie,D as Oe,P as De,J as Q,K as I,L as ee,M as A,g as Le,N as ze,O as Re,Q as te,R as Fe}from"./index-8xu0GoH7.js";import{S as ot}from"./index-8xu0GoH7.js";import{C as Pe}from"./cloud-upload-C7isQ6Qc.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ae=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],Be=y("circle-x",Ae);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $e=[["path",{d:"M11 14h10",key:"1w8e9d"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v1.344",key:"1e62lh"}],["path",{d:"m17 18 4-4-4-4",key:"z2g111"}],["path",{d:"M8 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 1.793-1.113",key:"bjbb7m"}],["rect",{x:"8",y:"2",width:"8",height:"4",rx:"1",key:"ublpy"}]],Ke=y("clipboard-paste",$e);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],qe=y("copy",Ue);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}]],We=y("file",He);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=[["path",{d:"M12 10v6",key:"1bos4e"}],["path",{d:"M9 13h6",key:"1uhe8q"}],["path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z",key:"1kt360"}]],Ve=y("folder-plus",Ge);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=[["path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z",key:"1kt360"}]],Je=y("folder",Ye);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xe=[["circle",{cx:"6",cy:"6",r:"3",key:"1lh9wr"}],["path",{d:"M8.12 8.12 12 12",key:"1alkpv"}],["path",{d:"M20 4 8.12 15.88",key:"xgtan2"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["path",{d:"M14.8 14.8 20 20",key:"ptml3r"}]],Ze=y("scissors",Xe),Qe=1,et=[1,6,12,24],ae="file-manager-guide-seeded",tt=2*1024*1024,B=2200,$=s=>{if(s<1024)return`${s} B`;const m=["KB","MB","GB","TB"];let g=s/1024,f=0;for(;g>=1024&&f<m.length-1;)g/=1024,f+=1;return`${g.toFixed(g>=10?0:1)} ${m[f]}`},it=()=>{const{t:s}=ke(),[m,g]=r.useState(k),[f,N]=r.useState([]),[i,O]=r.useState(!1),[ne,K]=r.useState(!1),[h,se]=r.useState({usage:null,quota:null}),[D,ie]=ve("file-manager-trash-ttl-hours",Qe),[d,w]=r.useState([]),[L,b]=r.useState(null),[U,T]=r.useState(null),[E,z]=r.useState(null),[q,C]=r.useState(null),[H,W]=r.useState(null),[j,p]=r.useState({isOpen:!1,x:0,y:0,targetFolderId:k}),G=r.useRef(null),V=r.useRef(null),Y=r.useRef(null),x=r.useRef(null),v=r.useRef(null),l=r.useCallback(async()=>{K(!0);try{if(i){const e=await Z();N(e)}else{const e=await Ne(m);N(e)}}finally{K(!1)}},[m,i]);r.useEffect(()=>{l(),w([]),b(null)},[l]),r.useEffect(()=>{if(!j.isOpen)return;const e=n=>{V.current?.contains(n.target)||p(c=>({...c,isOpen:!1}))},a=n=>{n.key==="Escape"&&p(c=>({...c,isOpen:!1}))};return window.addEventListener("mousedown",e),window.addEventListener("keydown",a),window.addEventListener("scroll",e,!0),()=>{window.removeEventListener("mousedown",e),window.removeEventListener("keydown",a),window.removeEventListener("scroll",e,!0)}},[j.isOpen]),r.useEffect(()=>{const e=()=>l();return window.addEventListener("file-manager-refresh",e),()=>window.removeEventListener("file-manager-refresh",e)},[l]),r.useEffect(()=>{const e=a=>{a.detail?.type==="saved"&&(C(s("widgets.file_manager.feedback_saved")),x.current&&window.clearTimeout(x.current),x.current=window.setTimeout(()=>{C(null)},B))};return window.addEventListener("file-manager-feedback",e),()=>{window.removeEventListener("file-manager-feedback",e)}},[s]),r.useEffect(()=>{const e=Math.max(1,D)*60*60*1e3;Te(e).then(()=>l())},[l,D]),r.useEffect(()=>{let e=!0;return(async()=>{const n=window.localStorage.getItem(ae)==="1";n||window.localStorage.setItem(ae,"1");const o=(await Q()).filter(u=>u.sourceWidgetId==="program-guide");if(o.length>1){const u=[...o].sort((_,je)=>_.createdAt-je.createdAt),[,...M]=u;await Promise.all(M.map(_=>I(_.id)))}if(o.length>0){e&&l();return}n||(await ee({name:s("widgets.program_guide.title"),parentId:k,blob:new Blob([""],{type:"text/plain"}),mime:"text/plain",sourceWidgetId:"program-guide",sourceWidgetTitleKey:"widgets.program_guide.title"}),e&&l())})(),()=>{e=!1}},[l,s]),r.useEffect(()=>{let e=!0;return Ce().then(a=>{e&&se(a)}),()=>{e=!1}},[f.length]),r.useEffect(()=>()=>{x.current&&window.clearTimeout(x.current),v.current&&window.clearTimeout(v.current)},[]);const re=r.useMemo(()=>(async()=>{const a=await Q(),n=new Map(a.map(u=>[u.id,u])),c=[];let o=n.get(m);for(;o&&o.id!==k;)c.unshift(o),o=n.get(o.parentId);return c})(),[m]),R=r.useMemo(()=>{const e=[...f];return e.sort((a,n)=>a.type!==n.type?a.type==="folder"?-1:1:a.name.localeCompare(n.name)),e},[f]),F=r.useMemo(()=>h.usage==null||h.quota==null?null:Math.min(100,Math.round(h.usage/h.quota*100)),[h.quota,h.usage]),le=async()=>{const e=window.prompt(s("widgets.file_manager.new_folder_prompt"));if(!e)return;const a=e.trim();a&&(await ze(a,m),l())},J=async e=>{if(i||!e||e.length===0)return;const a=Array.from(e).map(n=>ee({name:n.name,parentId:m,blob:n,mime:n.type}));await Promise.all(a),l(),C(s("widgets.file_manager.feedback_saved")),x.current&&window.clearTimeout(x.current),x.current=window.setTimeout(()=>{C(null)},B)},oe=e=>{if(e.preventDefault(),i)return;T(null);const a=e.dataTransfer.getData("application/x-ed-file-manager");if(a){try{const n=JSON.parse(a);A(n,m).then(l)}catch{}return}J(e.dataTransfer.files)},ce=async e=>{if(i)return;if(e.type==="folder"){g(e.id);return}(e.size??e.blob?.size??0)>=tt&&(W(s("widgets.file_manager.feedback_opening")),v.current&&window.clearTimeout(v.current),v.current=window.setTimeout(()=>{W(null)},B));const n=e.sourceWidgetId||"file-opener";window.dispatchEvent(new CustomEvent("file-manager-open",{detail:{widgetId:n,entryId:e.id}}))},de=async e=>{await te(e.id),l()},ue=async e=>{await Re(e.id),l()},me=async e=>{window.confirm(s("widgets.file_manager.delete_confirm"))&&(await I(e.id),l())},fe=async()=>{if(!window.confirm(s("widgets.file_manager.empty_trash_confirm")))return;const e=await Z();e.length!==0&&(await Promise.all(e.map(a=>I(a.id))),l())},ge=async e=>{if(!e.blob)return;const a=URL.createObjectURL(e.blob),n=document.createElement("a");n.href=a,n.download=e.name,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(a)},he=async()=>{if(m===k)return;const e=await Le(m);e&&g(e.parentId)},pe=(e,a,n)=>{if(i)return;const c=n.metaKey||n.ctrlKey;if(n.shiftKey&&L!==null){const o=Math.min(L,a),u=Math.max(L,a),M=R.slice(o,u+1).map(_=>_.id);w(_=>c?Array.from(new Set([..._,...M])):M)}else w(c?o=>o.includes(e)?o.filter(u=>u!==e):[...o,e]:[e]);b(a)},we=(e,a)=>{if(i)return;const n=d.includes(e.id)?d:[e.id];a.dataTransfer.setData("application/x-ed-file-manager",JSON.stringify(n)),a.dataTransfer.effectAllowed="move"},xe=async(e,a)=>{if(i)return;a.preventDefault(),a.stopPropagation(),T(null);const n=a.dataTransfer.getData("application/x-ed-file-manager");if(n)try{const o=JSON.parse(n).filter(u=>u!==e);if(o.length===0)return;await A(o,e),l()}catch{}},X=(e,a,n)=>{if(i)return;e.preventDefault(),e.stopPropagation();const c=Y.current?.getBoundingClientRect(),o=c?e.clientX-c.left:e.clientX,u=c?e.clientY-c.top:e.clientY;if(a&&n!=null){d.includes(a.id)||(w([a.id]),b(n)),p({isOpen:!0,x:o,y:u,targetFolderId:a.type==="folder"?a.id:m});return}p({isOpen:!0,x:o,y:u,targetFolderId:m})},_e=e=>{const a=e.trim();if(!a)return"";let n=a.replace(/[\\/:*?"<>|]/g,"-");return n=n.replace(/[\u0000-\u001f]/g,""),n=n.replace(/\s+/g," "),n=n.replace(/^\.+/,"").replace(/\.+$/,""),n.trim()},P=r.useCallback(async()=>{if(i||d.length!==1)return;const e=d[0],a=f.find(u=>u.id===e);if(!a)return;const n=window.prompt(s("widgets.file_manager.rename_prompt"),a.name);if(n===null)return;const c=_e(n);if(!c){window.alert(s("widgets.file_manager.rename_invalid"));return}if(c===a.name)return;if(f.some(u=>u.id!==a.id&&u.name===c)){window.alert(s("widgets.file_manager.rename_duplicate"));return}await Me(a.id,c),l(),w([a.id])},[f,i,l,d,s]),ye=async e=>{E&&(E.mode==="copy"?await Fe(E.entryIds,e):(await A(E.entryIds,e),z(null)),l())},be=async()=>{d.length!==0&&(await Promise.all(d.map(e=>te(e))),l(),w([]),b(null))},Ee=async()=>{d.length!==0&&window.confirm(s("widgets.file_manager.delete_confirm"))&&(await Promise.all(d.map(e=>I(e))),l(),w([]),b(null))};return r.useEffect(()=>{const e=a=>{a.key!=="F2"||a.target?.closest('input, textarea, select, [contenteditable="true"]')||d.length!==1||i||(a.preventDefault(),P())};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[P,i,d.length]),t.jsxs("div",{ref:Y,className:"file-manager-widget",onDragOver:e=>e.preventDefault(),onDrop:oe,children:[t.jsxs("div",{className:"file-manager-toolbar",children:[t.jsx("button",{className:"file-manager-button",onClick:he,disabled:m===k||i,title:s("widgets.file_manager.up"),children:t.jsx(Se,{size:16})}),t.jsx("div",{className:"file-manager-breadcrumbs",children:t.jsx(at,{breadcrumb:re,onNavigate:g,disabled:i})}),t.jsx("div",{className:"file-manager-spacer"}),t.jsxs("button",{className:"file-manager-button",onClick:le,disabled:i,children:[t.jsx(Ve,{size:16}),s("widgets.file_manager.new_folder")]}),t.jsxs("button",{className:"file-manager-button",onClick:()=>G.current?.click(),disabled:i,children:[t.jsx(Pe,{size:16}),s("widgets.file_manager.upload")]}),t.jsxs("button",{className:"file-manager-button",onClick:()=>O(e=>!e),children:[t.jsx(S,{size:16}),s(i?"widgets.file_manager.exit_trash":"widgets.file_manager.open_trash")]}),t.jsx("button",{className:"file-manager-icon-only",onClick:()=>window.dispatchEvent(new CustomEvent("open-widget",{detail:{widgetId:"local-web"}})),title:s("widgets.local_web.tooltip"),"aria-label":s("widgets.local_web.tooltip"),children:t.jsx("img",{src:Ie("icons/LocalWeb.png"),alt:"",className:"h-5 w-5"})}),i&&t.jsxs("button",{className:"file-manager-button",onClick:fe,children:[t.jsx(S,{size:16}),s("widgets.file_manager.empty_trash_button")]})]}),t.jsxs("div",{className:"file-manager-usage",children:[t.jsx("div",{className:"file-manager-usage-bar",children:t.jsx("div",{className:"file-manager-usage-fill",style:{width:F?`${F}%`:"0%"}})}),t.jsx("span",{className:"file-manager-usage-text",children:h.usage!=null&&h.quota!=null?s("widgets.file_manager.storage_usage",{used:$(h.usage),total:$(h.quota),percent:F??0}):s("widgets.file_manager.storage_unknown")}),i&&t.jsxs("div",{className:"file-manager-trash-settings",children:[t.jsx("label",{htmlFor:"trash-ttl",children:s("widgets.file_manager.trash_ttl")}),t.jsx("select",{id:"trash-ttl",value:D,onChange:e=>ie(Number(e.target.value)),children:et.map(e=>t.jsx("option",{value:e,children:s("widgets.file_manager.trash_option",{hours:e})},e))})]})]}),t.jsxs("div",{className:"file-manager-list",onClick:e=>{e.target===e.currentTarget&&(w([]),b(null))},onContextMenu:e=>X(e),children:[H&&t.jsxs("div",{className:"file-manager-feedback",role:"status","aria-live":"polite",children:[t.jsx("span",{className:"file-manager-spinner","aria-hidden":"true"}),t.jsx("span",{children:H})]}),ne?t.jsx("div",{className:"file-manager-empty",children:s("loading")}):R.length===0?t.jsx("div",{className:"file-manager-empty",children:s(i?"widgets.file_manager.empty_trash":"widgets.file_manager.empty_folder")}):R.map((e,a)=>t.jsxs("div",{className:"file-manager-row",children:[t.jsxs("button",{className:`file-manager-entry${d.includes(e.id)?" selected":""}${U===e.id?" drag-over":""}`,onClick:n=>pe(e.id,a,n),onDoubleClick:()=>ce(e),draggable:!i,onDragStart:n=>we(e,n),onDragOver:n=>{e.type!=="folder"||i||(n.preventDefault(),T(e.id))},onDragLeave:()=>{U===e.id&&T(null)},onDrop:n=>{e.type!=="folder"||i||xe(e.id,n)},onContextMenu:n=>X(n,e,a),children:[e.type==="folder"?t.jsx(Je,{size:18}):t.jsx(We,{size:18}),t.jsx("span",{className:"file-manager-entry-name",children:e.name}),e.type==="file"&&e.size!=null&&t.jsx("span",{className:"file-manager-entry-size",children:$(e.size)}),e.sourceWidgetId&&t.jsx("span",{className:"file-manager-entry-source",children:s("widgets.file_manager.saved_from",{widget:e.sourceWidgetTitleKey?s(e.sourceWidgetTitleKey):e.sourceWidgetId})})]}),t.jsxs("div",{className:"file-manager-actions",children:[e.type==="file"&&!i&&t.jsx("button",{className:"file-manager-icon-button",onClick:()=>ge(e),title:s("widgets.file_manager.download"),children:t.jsx(Oe,{size:16})}),i?t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"file-manager-icon-button",onClick:()=>ue(e),title:s("widgets.file_manager.restore"),children:s("widgets.file_manager.restore")}),t.jsx("button",{className:"file-manager-icon-button danger",onClick:()=>me(e),title:s("widgets.file_manager.delete_permanent"),children:s("widgets.file_manager.delete_permanent")})]}):t.jsx("button",{className:"file-manager-icon-button danger",onClick:()=>de(e),title:s("widgets.file_manager.move_to_trash"),children:t.jsx(S,{size:16})})]})]},e.id))]}),t.jsx("input",{type:"file",ref:G,onChange:e=>J(e.target.files),multiple:!0,className:"hidden"}),j.isOpen&&t.jsxs("div",{ref:V,className:"file-manager-context-menu",style:{left:j.x,top:j.y},children:[t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{z({mode:"copy",entryIds:d}),p(e=>({...e,isOpen:!1}))},disabled:d.length===0,children:[t.jsx(qe,{size:14}),s("widgets.file_manager.copy")]}),t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{z({mode:"cut",entryIds:d}),p(e=>({...e,isOpen:!1}))},disabled:d.length===0,children:[t.jsx(Ze,{size:14}),s("widgets.file_manager.cut")]}),t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{ye(j.targetFolderId),p(e=>({...e,isOpen:!1}))},disabled:!E||E.entryIds.length===0,children:[t.jsx(Ke,{size:14}),s("widgets.file_manager.paste")]}),t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{P(),p(e=>({...e,isOpen:!1}))},disabled:d.length!==1||i,children:[t.jsx(De,{size:14}),s("widgets.file_manager.rename")]}),t.jsx("div",{className:"file-manager-context-separator"}),t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{be(),p(e=>({...e,isOpen:!1}))},disabled:d.length===0,children:[t.jsx(S,{size:14,className:"text-gray-600"}),s("widgets.file_manager.move_to_trash")]}),t.jsxs("button",{className:"file-manager-context-item danger",onClick:()=>{Ee(),p(e=>({...e,isOpen:!1}))},disabled:d.length===0,children:[t.jsx(Be,{size:14}),s("widgets.file_manager.delete_permanent")]})]}),q&&t.jsx("div",{className:"file-manager-toast",role:"status","aria-live":"polite",children:q})]})},at=({breadcrumb:s,onNavigate:m,disabled:g})=>{const[f,N]=r.useState([]);return r.useEffect(()=>{let i=!0;return s.then(O=>{i&&N(O)}),()=>{i=!1}},[s]),f.length===0?null:t.jsx(t.Fragment,{children:f.map(i=>t.jsxs("button",{className:"file-manager-breadcrumb",onClick:()=>m(i.id),disabled:g,children:["/ ",i.name]},i.id))})};export{it as FileManagerWidget,ot as widgetConfig};
