import{u as O,r as c,s as E,j as s,R as k,S as T,g as R}from"./index-B15WEYvh.js";import{V as D}from"./index-B15WEYvh.js";import{d as F}from"./marked.esm-IrHqQMcX.js";import{k as W}from"./katex.min-2TduxwG8.js";import{r as C}from"./openDialog-H-OCpcqq.js";function M(l){const d=[];let o=l.replace(/\$\$([\s\S]+?)\$\$/g,(a,m)=>{const e=d.length;return d.push({id:e,latex:m,displayMode:!0}),`@@LATEX_BLOCK_${e}@@`});o=o.replace(/\$(?!\$)([^\n$]+?)\$/g,(a,m)=>{const e=d.length;return d.push({id:e,latex:m,displayMode:!1}),`@@LATEX_INLINE_${e}@@`});let i=F.parse(o);for(const a of d){const m=a.displayMode?`@@LATEX_BLOCK_${a.id}@@`:`@@LATEX_INLINE_${a.id}@@`,e=W.renderToString(a.latex.trim(),{throwOnError:!1,displayMode:a.displayMode});i=i.split(m).join(e)}return i}const X=()=>{const{t:l}=O(),d=c.useRef(null),[o,i]=c.useState("none"),[a,m]=c.useState(""),[e,p]=c.useState(""),[x,w]=c.useState("");c.useEffect(()=>()=>{e&&URL.revokeObjectURL(e)},[e]);const j=async()=>{const t=await C({accept:"image/*,application/pdf,text/plain,text/markdown,text/html,video/*,audio/*,.md,.markdown,.txt,.html,.htm,.xhtml"});if(!t)return;if(t.source==="local"){const[b]=t.files;b&&h(b);return}const[u]=t.entryIds;if(!u)return;const n=await R(u);if(!n?.blob)return;const f=new File([n.blob],n.name,{type:n.mime||n.blob.type});h(f)},h=c.useCallback(async t=>{e&&URL.revokeObjectURL(e),p(""),w("");const u=t.name,n=u.toLowerCase(),f=t.type.startsWith("image/")||n.match(/\.(png|jpe?g|gif|webp|bmp|svg)$/),b=t.type==="application/pdf"||n.endsWith(".pdf"),v=n.endsWith(".md")||n.endsWith(".markdown"),y=t.type==="text/html"||n.match(/\.(html?|xhtml)$/),U=t.type.startsWith("text/")&&!y||n.endsWith(".txt"),_=t.type.startsWith("video/")||n.match(/\.(mp4|webm|ogg|mov)$/),$=t.type.startsWith("audio/")||n.match(/\.(mp3|wav|ogg|m4a|aac|flac)$/);if(m(u),f){const r=URL.createObjectURL(t);p(r),i("image");return}if(b){const r=URL.createObjectURL(t);p(r),i("pdf");return}if(v){const r=await t.text();i("markdown"),w(r),p("");return}if(y){const r=URL.createObjectURL(t);p(r),i("html");return}if(U){const r=await t.text();i("text"),w(r),p("");return}if(_){const r=URL.createObjectURL(t);p(r),i("video");return}if($){const r=URL.createObjectURL(t);p(r),i("audio");return}const L=URL.createObjectURL(t);window.open(L,"_blank"),window.setTimeout(()=>URL.revokeObjectURL(L),6e4)},[e]);c.useEffect(()=>E("file-opener",async({entryId:u})=>{const n=await R(u);if(!n?.blob)return;const f=new File([n.blob],n.name,{type:n.mime||n.blob.type});await h(f)}),[h]);const g=c.useMemo(()=>o!=="markdown"||!x?"":M(x),[o,x]);c.useEffect(()=>{const t=d.current;t&&(t.innerHTML=g)},[g]);const N=o==="text"||o==="markdown";return s.jsxs("div",{className:"file-opener-widget",children:[s.jsxs("div",{className:"file-opener-header",children:[s.jsx(k,{size:18}),s.jsx("span",{children:a||l("widgets.file_opener.title")}),s.jsx("div",{className:"file-opener-spacer"}),s.jsx("button",{onClick:j,className:"file-opener-button",children:l("widgets.file_opener.open_button")})]}),s.jsxs("div",{className:`file-opener-body${N?" file-opener-body-doc":""}`,onClick:o==="none"?j:void 0,children:[o==="none"&&s.jsxs("div",{className:"file-opener-placeholder",children:[s.jsx(k,{size:32}),s.jsx("p",{children:l("widgets.file_opener.description")}),s.jsx("p",{className:"file-opener-hint",children:l("widgets.file_opener.supported_formats")})]}),o==="image"&&e&&s.jsx("img",{src:e,alt:a,className:"file-opener-image"}),o==="pdf"&&e&&s.jsx("object",{data:e,type:"application/pdf",className:"file-opener-embed",children:s.jsxs("div",{className:"file-opener-placeholder",children:[s.jsx(T,{size:24}),s.jsx("p",{children:l("widgets.file_opener.pdf_fallback")})]})}),o==="html"&&e&&s.jsx("iframe",{className:"file-opener-embed",src:e,title:a||l("widgets.file_opener.title"),sandbox:"allow-same-origin allow-scripts allow-forms"}),o==="video"&&e&&s.jsx("video",{className:"file-opener-video",controls:!0,src:e}),o==="audio"&&e&&s.jsx("audio",{className:"file-opener-audio",controls:!0,src:e}),o==="text"&&s.jsx("pre",{className:"file-opener-text",children:x}),o==="markdown"&&s.jsx("div",{className:"file-opener-markdown prose",ref:d})]})]})};export{X as FileOpenerWidget,D as widgetConfig};
