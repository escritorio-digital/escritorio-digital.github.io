import{c as b,u as je,r as i,F as k,a as Ee,y as X,z as ke,A as ve,B as Ne,j as t,C as Te,T as S,G as Ce,D as Me,H as Z,J as I,K as Q,L as P,g as Se,M as Ie,N as Oe,O as ee,P as De}from"./index-CHlQH2X_.js";import{Q as st}from"./index-CHlQH2X_.js";import{C as Le}from"./cloud-upload-CNzeqtfV.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ze=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],Fe=b("circle-x",ze);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Re=[["path",{d:"M11 14h10",key:"1w8e9d"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v1.344",key:"1e62lh"}],["path",{d:"m17 18 4-4-4-4",key:"z2g111"}],["path",{d:"M8 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 1.793-1.113",key:"bjbb7m"}],["rect",{x:"8",y:"2",width:"8",height:"4",rx:"1",key:"ublpy"}]],Pe=b("clipboard-paste",Re);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ae=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],Be=b("copy",Ae);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}]],$e=b("file",Ue);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=[["path",{d:"M12 10v6",key:"1bos4e"}],["path",{d:"M9 13h6",key:"1uhe8q"}],["path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z",key:"1kt360"}]],Ke=b("folder-plus",qe);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=[["path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z",key:"1kt360"}]],We=b("folder",He);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=[["circle",{cx:"6",cy:"6",r:"3",key:"1lh9wr"}],["path",{d:"M8.12 8.12 12 12",key:"1alkpv"}],["path",{d:"M20 4 8.12 15.88",key:"xgtan2"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["path",{d:"M14.8 14.8 20 20",key:"ptml3r"}]],Ve=b("scissors",Ge),Ye=1,Je=[1,6,12,24],te="file-manager-guide-seeded",Xe=2*1024*1024,A=2200,B=s=>{if(s<1024)return`${s} B`;const c=["KB","MB","GB","TB"];let f=s/1024,g=0;for(;f>=1024&&g<c.length-1;)f/=1024,g+=1;return`${f.toFixed(f>=10?0:1)} ${c[g]}`},tt=()=>{const{t:s}=je(),[c,f]=i.useState(k),[g,N]=i.useState([]),[r,O]=i.useState(!1),[ae,U]=i.useState(!1),[h,ne]=i.useState({usage:null,quota:null}),[D,se]=Ee("file-manager-trash-ttl-hours",Ye),[m,w]=i.useState([]),[L,y]=i.useState(null),[$,T]=i.useState(null),[j,z]=i.useState(null),[q,C]=i.useState(null),[K,H]=i.useState(null),[E,p]=i.useState({isOpen:!1,x:0,y:0,targetFolderId:k}),W=i.useRef(null),G=i.useRef(null),V=i.useRef(null),x=i.useRef(null),v=i.useRef(null),o=i.useCallback(async()=>{U(!0);try{if(r){const e=await X();N(e)}else{const e=await ke(c);N(e)}}finally{U(!1)}},[c,r]);i.useEffect(()=>{o(),w([]),y(null)},[o]),i.useEffect(()=>{if(!E.isOpen)return;const e=a=>{G.current?.contains(a.target)||p(d=>({...d,isOpen:!1}))},n=a=>{a.key==="Escape"&&p(d=>({...d,isOpen:!1}))};return window.addEventListener("mousedown",e),window.addEventListener("keydown",n),window.addEventListener("scroll",e,!0),()=>{window.removeEventListener("mousedown",e),window.removeEventListener("keydown",n),window.removeEventListener("scroll",e,!0)}},[E.isOpen]),i.useEffect(()=>{const e=()=>o();return window.addEventListener("file-manager-refresh",e),()=>window.removeEventListener("file-manager-refresh",e)},[o]),i.useEffect(()=>{const e=n=>{n.detail?.type==="saved"&&(C(s("widgets.file_manager.feedback_saved")),x.current&&window.clearTimeout(x.current),x.current=window.setTimeout(()=>{C(null)},A))};return window.addEventListener("file-manager-feedback",e),()=>{window.removeEventListener("file-manager-feedback",e)}},[s]),i.useEffect(()=>{const e=Math.max(1,D)*60*60*1e3;ve(e).then(()=>o())},[o,D]),i.useEffect(()=>{let e=!0;return(async()=>{const a=window.localStorage.getItem(te)==="1";a||window.localStorage.setItem(te,"1");const l=(await Z()).filter(u=>u.sourceWidgetId==="program-guide");if(l.length>1){const u=[...l].sort((_,ye)=>_.createdAt-ye.createdAt),[,...M]=u;await Promise.all(M.map(_=>I(_.id)))}if(l.length>0){e&&o();return}a||(await Q({name:s("widgets.program_guide.title"),parentId:k,blob:new Blob([""],{type:"text/plain"}),mime:"text/plain",sourceWidgetId:"program-guide",sourceWidgetTitleKey:"widgets.program_guide.title"}),e&&o())})(),()=>{e=!1}},[o,s]),i.useEffect(()=>{let e=!0;return Ne().then(n=>{e&&ne(n)}),()=>{e=!1}},[g.length]),i.useEffect(()=>()=>{x.current&&window.clearTimeout(x.current),v.current&&window.clearTimeout(v.current)},[]);const ie=i.useMemo(()=>(async()=>{const n=await Z(),a=new Map(n.map(u=>[u.id,u])),d=[];let l=a.get(c);for(;l&&l.id!==k;)d.unshift(l),l=a.get(l.parentId);return d})(),[c]),F=i.useMemo(()=>{const e=[...g];return e.sort((n,a)=>n.type!==a.type?n.type==="folder"?-1:1:n.name.localeCompare(a.name)),e},[g]),R=i.useMemo(()=>h.usage==null||h.quota==null?null:Math.min(100,Math.round(h.usage/h.quota*100)),[h.quota,h.usage]),re=async()=>{const e=window.prompt(s("widgets.file_manager.new_folder_prompt"));if(!e)return;const n=e.trim();n&&(await Ie(n,c),o())},Y=async e=>{if(r||!e||e.length===0)return;const n=Array.from(e).map(a=>Q({name:a.name,parentId:c,blob:a,mime:a.type}));await Promise.all(n),o(),C(s("widgets.file_manager.feedback_saved")),x.current&&window.clearTimeout(x.current),x.current=window.setTimeout(()=>{C(null)},A)},le=e=>{if(e.preventDefault(),r)return;T(null);const n=e.dataTransfer.getData("application/x-ed-file-manager");if(n){try{const a=JSON.parse(n);P(a,c).then(o)}catch{}return}Y(e.dataTransfer.files)},oe=async e=>{if(r)return;if(e.type==="folder"){f(e.id);return}(e.size??e.blob?.size??0)>=Xe&&(H(s("widgets.file_manager.feedback_opening")),v.current&&window.clearTimeout(v.current),v.current=window.setTimeout(()=>{H(null)},A));const a=e.sourceWidgetId||"file-opener";window.dispatchEvent(new CustomEvent("file-manager-open",{detail:{widgetId:a,entryId:e.id}}))},ce=async e=>{await ee(e.id),o()},de=async e=>{await Oe(e.id),o()},ue=async e=>{window.confirm(s("widgets.file_manager.delete_confirm"))&&(await I(e.id),o())},me=async()=>{if(!window.confirm(s("widgets.file_manager.empty_trash_confirm")))return;const e=await X();e.length!==0&&(await Promise.all(e.map(n=>I(n.id))),o())},fe=async e=>{if(!e.blob)return;const n=URL.createObjectURL(e.blob),a=document.createElement("a");a.href=n,a.download=e.name,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)},ge=async()=>{if(c===k)return;const e=await Se(c);e&&f(e.parentId)},he=(e,n,a)=>{if(r)return;const d=a.metaKey||a.ctrlKey;if(a.shiftKey&&L!==null){const l=Math.min(L,n),u=Math.max(L,n),M=F.slice(l,u+1).map(_=>_.id);w(_=>d?Array.from(new Set([..._,...M])):M)}else w(d?l=>l.includes(e)?l.filter(u=>u!==e):[...l,e]:[e]);y(n)},pe=(e,n)=>{if(r)return;const a=m.includes(e.id)?m:[e.id];n.dataTransfer.setData("application/x-ed-file-manager",JSON.stringify(a)),n.dataTransfer.effectAllowed="move"},we=async(e,n)=>{if(r)return;n.preventDefault(),n.stopPropagation(),T(null);const a=n.dataTransfer.getData("application/x-ed-file-manager");if(a)try{const l=JSON.parse(a).filter(u=>u!==e);if(l.length===0)return;await P(l,e),o()}catch{}},J=(e,n,a)=>{if(r)return;e.preventDefault(),e.stopPropagation();const d=V.current?.getBoundingClientRect(),l=d?e.clientX-d.left:e.clientX,u=d?e.clientY-d.top:e.clientY;if(n&&a!=null){m.includes(n.id)||(w([n.id]),y(a)),p({isOpen:!0,x:l,y:u,targetFolderId:n.type==="folder"?n.id:c});return}p({isOpen:!0,x:l,y:u,targetFolderId:c})},xe=async e=>{j&&(j.mode==="copy"?await De(j.entryIds,e):(await P(j.entryIds,e),z(null)),o())},_e=async()=>{m.length!==0&&(await Promise.all(m.map(e=>ee(e))),o(),w([]),y(null))},be=async()=>{m.length!==0&&window.confirm(s("widgets.file_manager.delete_confirm"))&&(await Promise.all(m.map(e=>I(e))),o(),w([]),y(null))};return t.jsxs("div",{ref:V,className:"file-manager-widget",onDragOver:e=>e.preventDefault(),onDrop:le,children:[t.jsxs("div",{className:"file-manager-toolbar",children:[t.jsx("button",{className:"file-manager-button",onClick:ge,disabled:c===k||r,title:s("widgets.file_manager.up"),children:t.jsx(Te,{size:16})}),t.jsx("div",{className:"file-manager-breadcrumbs",children:t.jsx(Ze,{breadcrumb:ie,onNavigate:f,disabled:r})}),t.jsx("div",{className:"file-manager-spacer"}),t.jsxs("button",{className:"file-manager-button",onClick:re,disabled:r,children:[t.jsx(Ke,{size:16}),s("widgets.file_manager.new_folder")]}),t.jsxs("button",{className:"file-manager-button",onClick:()=>W.current?.click(),disabled:r,children:[t.jsx(Le,{size:16}),s("widgets.file_manager.upload")]}),t.jsxs("button",{className:"file-manager-button",onClick:()=>O(e=>!e),children:[t.jsx(S,{size:16}),s(r?"widgets.file_manager.exit_trash":"widgets.file_manager.open_trash")]}),t.jsx("button",{className:"file-manager-icon-only",onClick:()=>window.dispatchEvent(new CustomEvent("open-widget",{detail:{widgetId:"local-web"}})),title:s("widgets.local_web.tooltip"),"aria-label":s("widgets.local_web.tooltip"),children:t.jsx("img",{src:Ce("icons/LocalWeb.png"),alt:"",className:"h-5 w-5"})}),r&&t.jsxs("button",{className:"file-manager-button",onClick:me,children:[t.jsx(S,{size:16}),s("widgets.file_manager.empty_trash_button")]})]}),t.jsxs("div",{className:"file-manager-usage",children:[t.jsx("div",{className:"file-manager-usage-bar",children:t.jsx("div",{className:"file-manager-usage-fill",style:{width:R?`${R}%`:"0%"}})}),t.jsx("span",{className:"file-manager-usage-text",children:h.usage!=null&&h.quota!=null?s("widgets.file_manager.storage_usage",{used:B(h.usage),total:B(h.quota),percent:R??0}):s("widgets.file_manager.storage_unknown")}),r&&t.jsxs("div",{className:"file-manager-trash-settings",children:[t.jsx("label",{htmlFor:"trash-ttl",children:s("widgets.file_manager.trash_ttl")}),t.jsx("select",{id:"trash-ttl",value:D,onChange:e=>se(Number(e.target.value)),children:Je.map(e=>t.jsx("option",{value:e,children:s("widgets.file_manager.trash_option",{hours:e})},e))})]})]}),t.jsxs("div",{className:"file-manager-list",onClick:e=>{e.target===e.currentTarget&&(w([]),y(null))},onContextMenu:e=>J(e),children:[K&&t.jsxs("div",{className:"file-manager-feedback",role:"status","aria-live":"polite",children:[t.jsx("span",{className:"file-manager-spinner","aria-hidden":"true"}),t.jsx("span",{children:K})]}),ae?t.jsx("div",{className:"file-manager-empty",children:s("loading")}):F.length===0?t.jsx("div",{className:"file-manager-empty",children:s(r?"widgets.file_manager.empty_trash":"widgets.file_manager.empty_folder")}):F.map((e,n)=>t.jsxs("div",{className:"file-manager-row",children:[t.jsxs("button",{className:`file-manager-entry${m.includes(e.id)?" selected":""}${$===e.id?" drag-over":""}`,onClick:a=>he(e.id,n,a),onDoubleClick:()=>oe(e),draggable:!r,onDragStart:a=>pe(e,a),onDragOver:a=>{e.type!=="folder"||r||(a.preventDefault(),T(e.id))},onDragLeave:()=>{$===e.id&&T(null)},onDrop:a=>{e.type!=="folder"||r||we(e.id,a)},onContextMenu:a=>J(a,e,n),children:[e.type==="folder"?t.jsx(We,{size:18}):t.jsx($e,{size:18}),t.jsx("span",{className:"file-manager-entry-name",children:e.name}),e.type==="file"&&e.size!=null&&t.jsx("span",{className:"file-manager-entry-size",children:B(e.size)}),e.sourceWidgetId&&t.jsx("span",{className:"file-manager-entry-source",children:s("widgets.file_manager.saved_from",{widget:e.sourceWidgetTitleKey?s(e.sourceWidgetTitleKey):e.sourceWidgetId})})]}),t.jsxs("div",{className:"file-manager-actions",children:[e.type==="file"&&!r&&t.jsx("button",{className:"file-manager-icon-button",onClick:()=>fe(e),title:s("widgets.file_manager.download"),children:t.jsx(Me,{size:16})}),r?t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"file-manager-icon-button",onClick:()=>de(e),title:s("widgets.file_manager.restore"),children:s("widgets.file_manager.restore")}),t.jsx("button",{className:"file-manager-icon-button danger",onClick:()=>ue(e),title:s("widgets.file_manager.delete_permanent"),children:s("widgets.file_manager.delete_permanent")})]}):t.jsx("button",{className:"file-manager-icon-button danger",onClick:()=>ce(e),title:s("widgets.file_manager.move_to_trash"),children:t.jsx(S,{size:16})})]})]},e.id))]}),t.jsx("input",{type:"file",ref:W,onChange:e=>Y(e.target.files),multiple:!0,className:"hidden"}),E.isOpen&&t.jsxs("div",{ref:G,className:"file-manager-context-menu",style:{left:E.x,top:E.y},children:[t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{z({mode:"copy",entryIds:m}),p(e=>({...e,isOpen:!1}))},disabled:m.length===0,children:[t.jsx(Be,{size:14}),s("widgets.file_manager.copy")]}),t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{z({mode:"cut",entryIds:m}),p(e=>({...e,isOpen:!1}))},disabled:m.length===0,children:[t.jsx(Ve,{size:14}),s("widgets.file_manager.cut")]}),t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{xe(E.targetFolderId),p(e=>({...e,isOpen:!1}))},disabled:!j||j.entryIds.length===0,children:[t.jsx(Pe,{size:14}),s("widgets.file_manager.paste")]}),t.jsx("div",{className:"file-manager-context-separator"}),t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{_e(),p(e=>({...e,isOpen:!1}))},disabled:m.length===0,children:[t.jsx(S,{size:14,className:"text-gray-600"}),s("widgets.file_manager.move_to_trash")]}),t.jsxs("button",{className:"file-manager-context-item danger",onClick:()=>{be(),p(e=>({...e,isOpen:!1}))},disabled:m.length===0,children:[t.jsx(Fe,{size:14}),s("widgets.file_manager.delete_permanent")]})]}),q&&t.jsx("div",{className:"file-manager-toast",role:"status","aria-live":"polite",children:q})]})},Ze=({breadcrumb:s,onNavigate:c,disabled:f})=>{const[g,N]=i.useState([]);return i.useEffect(()=>{let r=!0;return s.then(O=>{r&&N(O)}),()=>{r=!1}},[s]),g.length===0?null:t.jsx(t.Fragment,{children:g.map(r=>t.jsxs("button",{className:"file-manager-breadcrumb",onClick:()=>c(r.id),disabled:f,children:["/ ",r.name]},r.id))})};export{tt as FileManagerWidget,st as widgetConfig};
