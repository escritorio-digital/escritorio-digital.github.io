import{u as O,r as l,s as E,j as s,F as j,W as T,g as _}from"./index-BZogMUUP.js";import{X as q}from"./index-BZogMUUP.js";import{d as F}from"./marked.esm-IrHqQMcX.js";import{k as W}from"./katex.min-2TduxwG8.js";import{r as C}from"./openDialog-H-OCpcqq.js";import{H as M}from"./HideableToolbar-lDPqPL0A.js";import"./eye-DKkD9Ej8.js";function I(c){const d=[];let o=c.replace(/\$\$([\s\S]+?)\$\$/g,(a,m)=>{const e=d.length;return d.push({id:e,latex:m,displayMode:!0}),`@@LATEX_BLOCK_${e}@@`});o=o.replace(/\$(?!\$)([^\n$]+?)\$/g,(a,m)=>{const e=d.length;return d.push({id:e,latex:m,displayMode:!1}),`@@LATEX_INLINE_${e}@@`});let i=F.parse(o);for(const a of d){const m=a.displayMode?`@@LATEX_BLOCK_${a.id}@@`:`@@LATEX_INLINE_${a.id}@@`,e=W.renderToString(a.latex.trim(),{throwOnError:!1,displayMode:a.displayMode});i=i.split(m).join(e)}return i}const D=()=>{const{t:c}=O(),d=l.useRef(null),[o,i]=l.useState("none"),[a,m]=l.useState(""),[e,p]=l.useState(""),[x,w]=l.useState("");l.useEffect(()=>()=>{e&&URL.revokeObjectURL(e)},[e]);const g=async()=>{const t=await C({accept:"image/*,application/pdf,text/plain,text/markdown,text/html,video/*,audio/*,.md,.markdown,.txt,.html,.htm,.xhtml"});if(!t)return;if(t.source==="local"){const[h]=t.files;h&&b(h);return}const[u]=t.entryIds;if(!u)return;const n=await _(u);if(!n?.blob)return;const f=new File([n.blob],n.name,{type:n.mime||n.blob.type});b(f)},b=l.useCallback(async t=>{e&&URL.revokeObjectURL(e),p(""),w("");const u=t.name,n=u.toLowerCase(),f=t.type.startsWith("image/")||n.match(/\.(png|jpe?g|gif|webp|bmp|svg)$/),h=t.type==="application/pdf"||n.endsWith(".pdf"),R=n.endsWith(".md")||n.endsWith(".markdown"),L=t.type==="text/html"||n.match(/\.(html?|xhtml)$/),U=t.type.startsWith("text/")&&!L||n.endsWith(".txt"),v=t.type.startsWith("video/")||n.match(/\.(mp4|webm|ogg|mov)$/),$=t.type.startsWith("audio/")||n.match(/\.(mp3|wav|ogg|m4a|aac|flac)$/);if(m(u),f){const r=URL.createObjectURL(t);p(r),i("image");return}if(h){const r=URL.createObjectURL(t);p(r),i("pdf");return}if(R){const r=await t.text();i("markdown"),w(r),p("");return}if(L){const r=URL.createObjectURL(t);p(r),i("html");return}if(U){const r=await t.text();i("text"),w(r),p("");return}if(v){const r=URL.createObjectURL(t);p(r),i("video");return}if($){const r=URL.createObjectURL(t);p(r),i("audio");return}const k=URL.createObjectURL(t);window.open(k,"_blank"),window.setTimeout(()=>URL.revokeObjectURL(k),6e4)},[e]);l.useEffect(()=>E("file-opener",async({entryId:u})=>{const n=await _(u);if(!n?.blob)return;const f=new File([n.blob],n.name,{type:n.mime||n.blob.type});await b(f)}),[b]);const y=l.useMemo(()=>o!=="markdown"||!x?"":I(x),[o,x]);l.useEffect(()=>{const t=d.current;t&&(t.innerHTML=y)},[y]);const N=o==="text"||o==="markdown";return s.jsxs("div",{className:"file-opener-widget",children:[s.jsxs(M,{className:"file-opener-header",children:[s.jsx(j,{size:18}),s.jsx("span",{children:a||c("widgets.file_opener.title")}),s.jsx("div",{className:"file-opener-spacer"}),s.jsx("button",{onClick:g,className:"file-opener-icon-button",title:c("widgets.file_opener.open_button"),"aria-label":c("widgets.file_opener.open_button"),children:s.jsx(j,{size:16})})]}),s.jsxs("div",{className:`file-opener-body${N?" file-opener-body-doc":""}`,onClick:o==="none"?g:void 0,children:[o==="none"&&s.jsxs("div",{className:"file-opener-placeholder",children:[s.jsx(j,{size:32}),s.jsx("p",{children:c("widgets.file_opener.description")}),s.jsx("p",{className:"file-opener-hint",children:c("widgets.file_opener.supported_formats")})]}),o==="image"&&e&&s.jsx("img",{src:e,alt:a,className:"file-opener-image"}),o==="pdf"&&e&&s.jsx("object",{data:e,type:"application/pdf",className:"file-opener-embed",children:s.jsxs("div",{className:"file-opener-placeholder",children:[s.jsx(T,{size:24}),s.jsx("p",{children:c("widgets.file_opener.pdf_fallback")})]})}),o==="html"&&e&&s.jsx("iframe",{className:"file-opener-embed",src:e,title:a||c("widgets.file_opener.title"),sandbox:"allow-same-origin allow-scripts allow-forms"}),o==="video"&&e&&s.jsx("video",{className:"file-opener-video",controls:!0,src:e}),o==="audio"&&e&&s.jsx("audio",{className:"file-opener-audio",controls:!0,src:e}),o==="text"&&s.jsx("pre",{className:"file-opener-text",children:x}),o==="markdown"&&s.jsx("div",{className:"file-opener-markdown prose",ref:d})]})]})};export{D as FileOpenerWidget,q as widgetConfig};
