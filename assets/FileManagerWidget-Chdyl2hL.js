import{c as M,u as Ce,e as W,r,D as b,G as Q,H as Ie,h as ee,J as Se,K as Me,j as t,L as De,M as Oe,N as te,O as ze,Q as Le,S as Re,V as Fe,X as Pe,W as We,Y as Ae,T as I,Z as Be,_ as Ke,$ as ae,a0 as S,a1 as ne,a2 as A,a3 as Ue,a4 as $e,a5 as se,a6 as qe}from"./index-C5_U1qcH.js";import{a7 as mt}from"./index-C5_U1qcH.js";import{C as Ge}from"./cloud-upload-B-GrRHWp.js";import{C as He}from"./copy-Cgf0zgFB.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],Je=M("circle-x",Ye);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ve=[["path",{d:"M11 14h10",key:"1w8e9d"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v1.344",key:"1e62lh"}],["path",{d:"m17 18 4-4-4-4",key:"z2g111"}],["path",{d:"M8 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 1.793-1.113",key:"bjbb7m"}],["rect",{x:"8",y:"2",width:"8",height:"4",rx:"1",key:"ublpy"}]],Xe=M("clipboard-paste",Ve);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ze=[["path",{d:"M12 10v6",key:"1bos4e"}],["path",{d:"M9 13h6",key:"1uhe8q"}],["path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z",key:"1kt360"}]],Qe=M("folder-plus",Ze);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const et=[["circle",{cx:"6",cy:"6",r:"3",key:"1lh9wr"}],["path",{d:"M8.12 8.12 12 12",key:"1alkpv"}],["path",{d:"M20 4 8.12 15.88",key:"xgtan2"}],["circle",{cx:"6",cy:"18",r:"3",key:"fqmcym"}],["path",{d:"M14.8 14.8 20 20",key:"ptml3r"}]],tt=M("scissors",et),at=1,nt=[1,6,12,24],ie="file-manager-guide-seeded",st=2*1024*1024,B=2200,K=s=>{if(s<1024)return`${s} B`;const d=["KB","MB","GB","TB"];let g=s/1024,f=0;for(;g>=1024&&f<d.length-1;)g/=1024,f+=1;return`${g.toFixed(g>=10?0:1)} ${d[f]}`},ct=()=>{const{t:s}=Ce(),[d,g]=W("file-manager-current-folder-id",b),[f,v]=r.useState([]),[i,D]=W("file-manager-trash-view",!1),[re,U]=r.useState(!1),[h,le]=r.useState({usage:null,quota:null}),[O,oe]=W("file-manager-trash-ttl-hours",at),[u,w]=r.useState([]),[z,y]=r.useState(null),[$,k]=r.useState(null),[j,L]=r.useState(null),[q,T]=r.useState(null),[G,H]=r.useState(null),[E,p]=r.useState({isOpen:!1,x:0,y:0,targetFolderId:b}),Y=r.useRef(null),J=r.useRef(null),V=r.useRef(null),x=r.useRef(null),N=r.useRef(null),l=r.useCallback(async()=>{U(!0);try{if(i){const e=await Q();v(e)}else{const e=await Ie(d);v(e)}}finally{U(!1)}},[d,i]);r.useEffect(()=>{l(),w([]),y(null)},[l]),r.useEffect(()=>{if(i||d===b)return;let e=!0;return ee(d).then(a=>{e&&(!a||a.type!=="folder")&&g(b)}),()=>{e=!1}},[d,i,g]),r.useEffect(()=>{if(!E.isOpen)return;const e=n=>{J.current?.contains(n.target)||p(c=>({...c,isOpen:!1}))},a=n=>{n.key==="Escape"&&p(c=>({...c,isOpen:!1}))};return window.addEventListener("mousedown",e),window.addEventListener("keydown",a),window.addEventListener("scroll",e,!0),()=>{window.removeEventListener("mousedown",e),window.removeEventListener("keydown",a),window.removeEventListener("scroll",e,!0)}},[E.isOpen]),r.useEffect(()=>{const e=()=>l();return window.addEventListener("file-manager-refresh",e),()=>window.removeEventListener("file-manager-refresh",e)},[l]),r.useEffect(()=>{const e=a=>{a.detail?.type==="saved"&&(T(s("widgets.file_manager.feedback_saved")),x.current&&window.clearTimeout(x.current),x.current=window.setTimeout(()=>{T(null)},B))};return window.addEventListener("file-manager-feedback",e),()=>{window.removeEventListener("file-manager-feedback",e)}},[s]),r.useEffect(()=>{const e=Math.max(1,O)*60*60*1e3;Se(e).then(()=>l())},[l,O]),r.useEffect(()=>{let e=!0;return(async()=>{const n=window.localStorage.getItem(ie)==="1";n||window.localStorage.setItem(ie,"1");const o=(await ae()).filter(m=>m.sourceWidgetId==="program-guide");if(o.length>1){const m=[...o].sort((_,Te)=>_.createdAt-Te.createdAt),[,...C]=m;await Promise.all(C.map(_=>S(_.id)))}if(o.length>0){e&&l();return}n||(await ne({name:s("widgets.program_guide.title"),parentId:b,blob:new Blob([""],{type:"text/plain"}),mime:"text/plain",sourceWidgetId:"program-guide",sourceWidgetTitleKey:"widgets.program_guide.title"}),e&&l())})(),()=>{e=!1}},[l,s]),r.useEffect(()=>{let e=!0;return Me().then(a=>{e&&le(a)}),()=>{e=!1}},[f.length]),r.useEffect(()=>()=>{x.current&&window.clearTimeout(x.current),N.current&&window.clearTimeout(N.current)},[]);const ce=r.useMemo(()=>(async()=>{const a=await ae(),n=new Map(a.map(m=>[m.id,m])),c=[];let o=n.get(d);for(;o&&o.id!==b;)c.unshift(o),o=n.get(o.parentId);return c})(),[d]),R=r.useMemo(()=>{const e=[...f];return e.sort((a,n)=>a.type!==n.type?a.type==="folder"?-1:1:a.name.localeCompare(n.name)),e},[f]),de=r.useCallback(e=>{if(e.type==="folder")return t.jsx("span",{className:"file-manager-entry-icon file-manager-entry-icon-folder",children:t.jsx(De,{size:18})});const a=e.sourceWidgetId?Oe[e.sourceWidgetId]:void 0;if(a?.icon){const n=typeof a.icon=="string"?t.jsx("img",{src:te(a.icon),alt:""}):a.icon;return t.jsx("span",{className:"file-manager-entry-icon",children:n})}return e.mime?.startsWith("image/")?t.jsx("span",{className:"file-manager-entry-icon",children:t.jsx(ze,{size:18})}):e.mime?.startsWith("audio/")?t.jsx("span",{className:"file-manager-entry-icon",children:t.jsx(Le,{size:18})}):e.mime?.startsWith("video/")?t.jsx("span",{className:"file-manager-entry-icon",children:t.jsx(Re,{size:18})}):t.jsx("span",{className:"file-manager-entry-icon",children:t.jsx(Fe,{size:18})})},[]),F=r.useMemo(()=>h.usage==null||h.quota==null?null:Math.min(100,Math.round(h.usage/h.quota*100)),[h.quota,h.usage]),ue=async()=>{const e=window.prompt(s("widgets.file_manager.new_folder_prompt"));if(!e)return;const a=e.trim();a&&(await Ue(a,d),l())},X=async e=>{if(i||!e||e.length===0)return;const a=Array.from(e).map(n=>ne({name:n.name,parentId:d,blob:n,mime:n.type}));await Promise.all(a),l(),T(s("widgets.file_manager.feedback_saved")),x.current&&window.clearTimeout(x.current),x.current=window.setTimeout(()=>{T(null)},B)},me=e=>{if(e.preventDefault(),i)return;k(null);const a=e.dataTransfer.getData("application/x-ed-file-manager");if(a){try{const n=JSON.parse(a);A(n,d).then(l)}catch{}return}X(e.dataTransfer.files)},fe=async e=>{if(i)return;if(e.type==="folder"){g(e.id);return}(e.size??e.blob?.size??0)>=st&&(H(s("widgets.file_manager.feedback_opening")),N.current&&window.clearTimeout(N.current),N.current=window.setTimeout(()=>{H(null)},B));const n=e.sourceWidgetId||"file-opener";window.dispatchEvent(new CustomEvent("file-manager-open",{detail:{widgetId:n,entryId:e.id}}))},ge=async e=>{await se(e.id),l()},he=async e=>{await $e(e.id),l()},pe=async e=>{window.confirm(s("widgets.file_manager.delete_confirm"))&&(await S(e.id),l())},we=async()=>{if(!window.confirm(s("widgets.file_manager.empty_trash_confirm")))return;const e=await Q();e.length!==0&&(await Promise.all(e.map(a=>S(a.id))),l())},xe=async e=>{if(!e.blob)return;const a=URL.createObjectURL(e.blob),n=document.createElement("a");n.href=a,n.download=e.name,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(a)},be=async()=>{if(d===b)return;const e=await ee(d);e&&g(e.parentId)},_e=(e,a,n)=>{if(i)return;const c=n.metaKey||n.ctrlKey;if(n.shiftKey&&z!==null){const o=Math.min(z,a),m=Math.max(z,a),C=R.slice(o,m+1).map(_=>_.id);w(_=>c?Array.from(new Set([..._,...C])):C)}else w(c?o=>o.includes(e)?o.filter(m=>m!==e):[...o,e]:[e]);y(a)},ye=(e,a)=>{if(i)return;const n=u.includes(e.id)?u:[e.id];a.dataTransfer.setData("application/x-ed-file-manager",JSON.stringify(n)),a.dataTransfer.effectAllowed="move"},je=async(e,a)=>{if(i)return;a.preventDefault(),a.stopPropagation(),k(null);const n=a.dataTransfer.getData("application/x-ed-file-manager");if(n)try{const o=JSON.parse(n).filter(m=>m!==e);if(o.length===0)return;await A(o,e),l()}catch{}},Z=(e,a,n)=>{if(i)return;e.preventDefault(),e.stopPropagation();const c=V.current?.getBoundingClientRect(),o=c?e.clientX-c.left:e.clientX,m=c?e.clientY-c.top:e.clientY;if(a&&n!=null){u.includes(a.id)||(w([a.id]),y(n)),p({isOpen:!0,x:o,y:m,targetFolderId:a.type==="folder"?a.id:d});return}p({isOpen:!0,x:o,y:m,targetFolderId:d})},Ee=e=>{const a=e.trim();if(!a)return"";let n=a.replace(/[\\/:*?"<>|]/g,"-");return n=n.replace(/[\u0000-\u001f]/g,""),n=n.replace(/\s+/g," "),n=n.replace(/^\.+/,"").replace(/\.+$/,""),n.trim()},P=r.useCallback(async()=>{if(i||u.length!==1)return;const e=u[0],a=f.find(m=>m.id===e);if(!a)return;const n=window.prompt(s("widgets.file_manager.rename_prompt"),a.name);if(n===null)return;const c=Ee(n);if(!c){window.alert(s("widgets.file_manager.rename_invalid"));return}if(c===a.name)return;if(f.some(m=>m.id!==a.id&&m.name===c)){window.alert(s("widgets.file_manager.rename_duplicate"));return}await Pe(a.id,c),l(),w([a.id])},[f,i,l,u,s]),Ne=async e=>{j&&(j.mode==="copy"?await qe(j.entryIds,e):(await A(j.entryIds,e),L(null)),l())},ve=async()=>{u.length!==0&&(await Promise.all(u.map(e=>se(e))),l(),w([]),y(null))},ke=async()=>{u.length!==0&&window.confirm(s("widgets.file_manager.delete_confirm"))&&(await Promise.all(u.map(e=>S(e))),l(),w([]),y(null))};return r.useEffect(()=>{const e=a=>{a.key!=="F2"||a.target?.closest('input, textarea, select, [contenteditable="true"]')||u.length!==1||i||(a.preventDefault(),P())};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[P,i,u.length]),t.jsxs("div",{ref:V,className:"file-manager-widget",onDragOver:e=>e.preventDefault(),onDrop:me,children:[t.jsx(We,{children:t.jsxs("div",{className:"file-manager-toolbar",children:[t.jsx("button",{className:"file-manager-button",onClick:be,disabled:d===b||i,title:s("widgets.file_manager.up"),children:t.jsx(Ae,{size:16})}),t.jsx("div",{className:"file-manager-breadcrumbs",children:t.jsx(it,{breadcrumb:ce,onNavigate:g,disabled:i})}),t.jsx("div",{className:"file-manager-spacer"}),t.jsxs("button",{className:"file-manager-button",onClick:ue,disabled:i,children:[t.jsx(Qe,{size:16}),s("widgets.file_manager.new_folder")]}),t.jsxs("button",{className:"file-manager-button",onClick:()=>Y.current?.click(),disabled:i,children:[t.jsx(Ge,{size:16}),s("widgets.file_manager.upload")]}),t.jsxs("button",{className:"file-manager-button",onClick:()=>D(e=>!e),children:[t.jsx(I,{size:16}),s(i?"widgets.file_manager.exit_trash":"widgets.file_manager.open_trash")]}),t.jsx("button",{className:"file-manager-icon-only",onClick:()=>window.dispatchEvent(new CustomEvent("open-widget",{detail:{widgetId:"local-web"}})),title:s("widgets.local_web.tooltip"),"aria-label":s("widgets.local_web.tooltip"),children:t.jsx("img",{src:te("icons/LocalWeb.png"),alt:"",className:"h-5 w-5"})}),i&&t.jsxs("button",{className:"file-manager-button",onClick:we,children:[t.jsx(I,{size:16}),s("widgets.file_manager.empty_trash_button")]})]})}),t.jsxs("div",{className:"file-manager-usage",children:[t.jsx("div",{className:"file-manager-usage-bar",children:t.jsx("div",{className:"file-manager-usage-fill",style:{width:F?`${F}%`:"0%"}})}),t.jsx("span",{className:"file-manager-usage-text",children:h.usage!=null&&h.quota!=null?s("widgets.file_manager.storage_usage",{used:K(h.usage),total:K(h.quota),percent:F??0}):s("widgets.file_manager.storage_unknown")}),i&&t.jsxs("div",{className:"file-manager-trash-settings",children:[t.jsx("label",{htmlFor:"trash-ttl",children:s("widgets.file_manager.trash_ttl")}),t.jsx("select",{id:"trash-ttl",value:O,onChange:e=>oe(Number(e.target.value)),children:nt.map(e=>t.jsx("option",{value:e,children:s("widgets.file_manager.trash_option",{hours:e})},e))})]})]}),t.jsxs("div",{className:"file-manager-list",onClick:e=>{e.target===e.currentTarget&&(w([]),y(null))},onContextMenu:e=>Z(e),children:[G&&t.jsxs("div",{className:"file-manager-feedback",role:"status","aria-live":"polite",children:[t.jsx("span",{className:"file-manager-spinner","aria-hidden":"true"}),t.jsx("span",{children:G})]}),re?t.jsx("div",{className:"file-manager-empty",children:s("loading")}):R.length===0?t.jsx("div",{className:"file-manager-empty",children:s(i?"widgets.file_manager.empty_trash":"widgets.file_manager.empty_folder")}):R.map((e,a)=>t.jsxs("div",{className:"file-manager-row",children:[t.jsxs("button",{className:`file-manager-entry${u.includes(e.id)?" selected":""}${$===e.id?" drag-over":""}`,onClick:n=>_e(e.id,a,n),onDoubleClick:()=>fe(e),draggable:!i,onDragStart:n=>ye(e,n),onDragOver:n=>{e.type!=="folder"||i||(n.preventDefault(),k(e.id))},onDragLeave:()=>{$===e.id&&k(null)},onDrop:n=>{e.type!=="folder"||i||je(e.id,n)},onContextMenu:n=>Z(n,e,a),children:[de(e),t.jsx("span",{className:"file-manager-entry-name",children:e.name}),e.type==="file"&&e.size!=null&&t.jsx("span",{className:"file-manager-entry-size",children:K(e.size)}),e.sourceWidgetId&&t.jsx("span",{className:"file-manager-entry-source",children:e.sourceWidgetTitleKey?s(e.sourceWidgetTitleKey):e.sourceWidgetId})]}),t.jsxs("div",{className:"file-manager-actions",children:[e.type==="file"&&!i&&t.jsx("button",{className:"file-manager-icon-button",onClick:()=>xe(e),title:s("widgets.file_manager.download"),children:t.jsx(Be,{size:16})}),i?t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"file-manager-icon-button",onClick:()=>he(e),title:s("widgets.file_manager.restore"),children:s("widgets.file_manager.restore")}),t.jsx("button",{className:"file-manager-icon-button danger",onClick:()=>pe(e),title:s("widgets.file_manager.delete_permanent"),children:s("widgets.file_manager.delete_permanent")})]}):t.jsx("button",{className:"file-manager-icon-button danger",onClick:()=>ge(e),title:s("widgets.file_manager.move_to_trash"),children:t.jsx(I,{size:16})})]})]},e.id))]}),t.jsx("input",{type:"file",ref:Y,onChange:e=>X(e.target.files),multiple:!0,className:"hidden"}),E.isOpen&&t.jsxs("div",{ref:J,className:"file-manager-context-menu",style:{left:E.x,top:E.y},children:[t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{L({mode:"copy",entryIds:u}),p(e=>({...e,isOpen:!1}))},disabled:u.length===0,children:[t.jsx(He,{size:14}),s("widgets.file_manager.copy")]}),t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{L({mode:"cut",entryIds:u}),p(e=>({...e,isOpen:!1}))},disabled:u.length===0,children:[t.jsx(tt,{size:14}),s("widgets.file_manager.cut")]}),t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{Ne(E.targetFolderId),p(e=>({...e,isOpen:!1}))},disabled:!j||j.entryIds.length===0,children:[t.jsx(Xe,{size:14}),s("widgets.file_manager.paste")]}),t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{P(),p(e=>({...e,isOpen:!1}))},disabled:u.length!==1||i,children:[t.jsx(Ke,{size:14}),s("widgets.file_manager.rename")]}),t.jsx("div",{className:"file-manager-context-separator"}),t.jsxs("button",{className:"file-manager-context-item",onClick:()=>{ve(),p(e=>({...e,isOpen:!1}))},disabled:u.length===0,children:[t.jsx(I,{size:14,className:"text-gray-600"}),s("widgets.file_manager.move_to_trash")]}),t.jsxs("button",{className:"file-manager-context-item danger",onClick:()=>{ke(),p(e=>({...e,isOpen:!1}))},disabled:u.length===0,children:[t.jsx(Je,{size:14}),s("widgets.file_manager.delete_permanent")]})]}),q&&t.jsx("div",{className:"file-manager-toast",role:"status","aria-live":"polite",children:q})]})},it=({breadcrumb:s,onNavigate:d,disabled:g})=>{const[f,v]=r.useState([]);return r.useEffect(()=>{let i=!0;return s.then(D=>{i&&v(D)}),()=>{i=!1}},[s]),f.length===0?null:t.jsx(t.Fragment,{children:f.map(i=>t.jsxs("button",{className:"file-manager-breadcrumb",onClick:()=>d(i.id),disabled:g,children:["/ ",i.name]},i.id))})};export{ct as FileManagerWidget,mt as widgetConfig};
