import{c as E,u as Ue,r as i,f as Ve,j as s,W as Ge,z as Qe,T as Ze,R as et,h as re}from"./index-CmZZXgdz.js";import{A as Tt}from"./index-CmZZXgdz.js";import{S as tt,a as nt,s as Ie,r as at,d as st}from"./saveDialog-BJld9mPl.js";import{r as rt}from"./openDialog-H-OCpcqq.js";import{E as it,H as ct,S as ot,A as dt}from"./square-0sUG7pWR.js";import{C as lt}from"./circle-D2S7G56c.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ut=[["path",{d:"M3 3v16a2 2 0 0 0 2 2h16",key:"c24i48"}],["path",{d:"m19 9-5 5-4-4-3 3",key:"2osh9i"}]],ht=E("chart-line",ut);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gt=[["path",{d:"M12 2v20",key:"t6zp3m"}],["path",{d:"m15 19-3 3-3-3",key:"11eu04"}],["path",{d:"m19 9 3 3-3 3",key:"1mg7y2"}],["path",{d:"M2 12h20",key:"9i4pu4"}],["path",{d:"m5 9-3 3 3 3",key:"j64kie"}],["path",{d:"m9 5 3-3 3 3",key:"l8vdw6"}]],wt=E("move",gt);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pt=[["path",{d:"m14.622 17.897-10.68-2.913",key:"vj2p1u"}],["path",{d:"M18.376 2.622a1 1 0 1 1 3.002 3.002L17.36 9.643a.5.5 0 0 0 0 .707l.944.944a2.41 2.41 0 0 1 0 3.408l-.944.944a.5.5 0 0 1-.707 0L8.354 7.348a.5.5 0 0 1 0-.707l.944-.944a2.41 2.41 0 0 1 3.408 0l.944.944a.5.5 0 0 0 .707 0z",key:"18tc5c"}],["path",{d:"M9 8c-1.804 2.71-3.97 3.46-6.583 3.948a.507.507 0 0 0-.302.819l7.32 8.883a1 1 0 0 0 1.185.204C12.735 20.405 16 16.792 16 15",key:"ytzfxy"}]],ft=E("paintbrush",pt);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mt=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]],xt=E("pen",mt);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bt=[["path",{d:"M3 3h.01",key:"159qn6"}],["path",{d:"M7 5h.01",key:"1hq22a"}],["path",{d:"M11 7h.01",key:"1osv80"}],["path",{d:"M3 7h.01",key:"1xzrh3"}],["path",{d:"M7 9h.01",key:"19b3jx"}],["path",{d:"M3 11h.01",key:"1eifu7"}],["rect",{width:"4",height:"4",x:"15",y:"5",key:"mri9e4"}],["path",{d:"m19 9 2 2v10c0 .6-.4 1-1 1h-6c-.6 0-1-.4-1-1V11l2-2",key:"aib6hk"}],["path",{d:"m13 14 8-2",key:"1d7bmk"}],["path",{d:"m13 19 8-2",key:"1y2vml"}]],yt=E("spray-can",bt);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vt=[["path",{d:"M12 4v16",key:"1654pz"}],["path",{d:"M4 7V5a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v2",key:"e0r10z"}],["path",{d:"M9 20h6",key:"s66wpe"}]],kt=E("type",vt),_t=({instanceId:ie})=>{const{t:u}=Ue(),je=i.useRef(ie??`drawing-pad-${Date.now()}-${Math.random().toString(16).slice(2)}`),A=ie??je.current,w=i.useRef(null),f=i.useRef(null),[ce,L]=i.useState(!1),[N,Se]=i.useState("#000000"),[I,_e]=i.useState(5),[R,oe]=i.useState("draw"),[h,j]=i.useState("pencil"),[m,de]=i.useState(null),[y,Ne]=i.useState(0),[v,Re]=i.useState(0),[T,X]=i.useState(null),[le,H]=i.useState(!1),[q,Y]=i.useState(""),[ue,Te]=i.useState(0),[he,ze]=i.useState(0),ge=i.useRef(null),[K,Pe]=i.useState(!0),[M,J]=i.useState({x:0,y:0}),[k,Ee]=i.useState(!1),[U,V]=i.useState(null),[De,G]=i.useState(null),[we,Xe]=i.useState(null),[Ye,z]=i.useState(!1),C=i.useRef(null),[Q,Z]=i.useState(!1),$=i.useRef(typeof window<"u"&&window.devicePixelRatio||1),B=i.useRef(M),ee=i.useRef(Q);B.current=M,ee.current=Q;const b=i.useCallback(()=>{K&&Pe(!1)},[K]),[D,S]=i.useState(null),W=i.useCallback((e,t)=>{if(!w.current||!C.current)return;const n=w.current,a=C.current,r=n.getContext("2d");if(r){r.clearRect(0,0,n.width,n.height);const c=$.current||1,o=Math.max(0,Math.round(e*c)),d=Math.max(0,Math.round(t*c)),g=Math.min(n.width,a.width-o),l=Math.min(n.height,a.height-d);g>0&&l>0&&r.drawImage(a,o,d,g,l,0,0,g,l)}},[]),$e=i.useCallback(()=>{J({x:0,y:0}),W(0,0)},[W]),Be=i.useCallback(()=>{Ee(!k),k||S(null)},[k]),te=i.useCallback(()=>(C.current||(C.current=document.createElement("canvas")),C.current),[]),O=i.useCallback(()=>{const e=w.current;if(!e)return;const t=te(),n=B.current,a=$.current||1,r=Math.max(e.width+Math.abs(Math.round(n.x*a)),t.width||0),c=Math.max(e.height+Math.abs(Math.round(n.y*a)),t.height||0);if(t.width<r||t.height<c){const d=document.createElement("canvas");d.width=r,d.height=c;const g=d.getContext("2d");if(g){ee.current&&t.width>0&&t.height>0&&g.drawImage(t,0,0),t.width=r,t.height=c;const l=t.getContext("2d");l&&(l.clearRect(0,0,r,c),l.drawImage(d,0,0))}}const o=t.getContext("2d");if(o){const d=Math.max(0,Math.round(n.x*a)),g=Math.max(0,Math.round(n.y*a));o.drawImage(e,0,0,e.width,e.height,d,g,e.width,e.height)}Z(!0)},[te]),pe=i.useCallback(e=>{const t=w.current;if(!t)return{x:0,y:0};const n=t.getBoundingClientRect();return{x:e.clientX-n.left,y:e.clientY-n.top}},[]),fe=i.useCallback(e=>{const t=w.current;if(!t)return{x:0,y:0};const n=t.getBoundingClientRect(),a=t.width/n.width,r=t.height/n.height;return{x:(e.clientX-n.left)*a+M.x*a,y:(e.clientY-n.top)*r+M.y*r}},[M]),We=i.useCallback(e=>{const t=w.current;if(!t)return{x:0,y:0};const n=t.getBoundingClientRect(),a=t.width/n.width,r=t.height/n.height;return{x:(e.clientX-n.left)*a+M.x*a,y:(e.clientY-n.top)*r+M.y*r}},[M]),me=i.useCallback((e=!1)=>{const t=w.current,n=f.current;if(!t||!n)return;let a=null;if(e&&(a=n.getImageData(0,0,t.width,t.height)),e||n.clearRect(0,0,t.width,t.height),m){const r=t.width/m.width,c=t.height/m.height,o=Math.min(r,c),d=(t.width-m.width*o)/2,g=(t.height-m.height*o)/2;if(e&&a){const l=document.createElement("canvas");l.width=t.width,l.height=t.height;const x=l.getContext("2d");x&&(x.drawImage(m,0,0,m.width,m.height,d,g,m.width*o,m.height*o),x.putImageData(a,0,0),n.clearRect(0,0,t.width,t.height),n.drawImage(l,0,0))}else n.drawImage(m,0,0,m.width,m.height,d,g,m.width*o,m.height*o)}else e&&a&&n.putImageData(a,0,0)},[m]);i.useEffect(()=>{const e=w.current;if(!e)return;const t=()=>{const r=e.offsetWidth,c=e.offsetHeight,o=(typeof window<"u"?window.devicePixelRatio:1)||1;if($.current=o,r<=0||c<=0)return;const d=Math.round(r*o),g=Math.round(c*o);if(e.width!==d||e.height!==g){const l=B.current,x=Math.max(0,Math.round(l.x*o)),_=Math.max(0,Math.round(l.y*o)),p=te();((Ce,Me)=>{if(p.width>=Ce&&p.height>=Me)return;const P=document.createElement("canvas");P.width=Math.max(Ce,p.width),P.height=Math.max(Me,p.height);const ae=P.getContext("2d");ae&&p.width>0&&p.height>0&&ae.drawImage(p,0,0),p.width=P.width,p.height=P.height;const se=p.getContext("2d");se&&ae&&(se.clearRect(0,0,p.width,p.height),se.drawImage(P,0,0))})(x+e.width,_+e.height);const F=p.getContext("2d");F&&e.width>0&&e.height>0&&(F.drawImage(e,0,0,e.width,e.height,x,_,e.width,e.height),ee.current=!0,Z(!0)),e.width=d,e.height=g,f.current=e.getContext("2d"),W(l.x,l.y)}},n=e.getContext("2d");if(!n)return;f.current=n,t();const a=new ResizeObserver(()=>{t()});return a.observe(e.parentElement||e),window.addEventListener("resize",t),()=>{a.disconnect(),window.removeEventListener("resize",t)}},[]),i.useEffect(()=>{f.current&&(f.current.globalCompositeOperation=R==="draw"?"source-over":"destination-out")},[R]);const Oe=e=>{if(b(),k){const a=pe(e);S(a);return}if(h==="text"&&le||!f.current||!w.current)return;const{x:t,y:n}=fe(e);h==="text"?(H(!0),Te(t),ze(n),Y(""),X(f.current.getImageData(0,0,w.current.width,w.current.height)),setTimeout(()=>ge.current?.focus(),0)):["line","rectangle","circle","arrow"].includes(h)?(Ne(t),Re(n),X(f.current.getImageData(0,0,w.current.width,w.current.height))):(f.current.beginPath(),f.current.moveTo(t,n)),L(!0),z(!0)},xe=(e,t,n,a,r)=>{e.save(),e.beginPath(),e.translate(t,n),e.rotate(a),e.moveTo(0,0),e.lineTo(-r,-r/2),e.lineTo(-r,r/2),e.closePath(),e.fill(),e.restore()},Fe=e=>{if(k&&D){const r=pe(e),c=r.x-D.x,o=r.y-D.y;if(Q&&C.current){const l=C.current.getContext("2d"),x=w.current;if(l&&x){const _=B.current,p=$.current||1,ke=Math.max(0,Math.round(_.x*p)),F=Math.max(0,Math.round(_.y*p));l.drawImage(x,0,0,x.width,x.height,ke,F,x.width,x.height)}}const d={x:M.x-c,y:M.y-o};J(d),W(d.x,d.y),S(r);return}if(!ce||!f.current)return;const{x:t,y:n}=fe(e),a=f.current;if(a.lineWidth=I,a.strokeStyle=N,a.fillStyle=N,T&&["line","rectangle","circle","arrow"].includes(h)){a.putImageData(T,0,0);const r=t-y,c=n-v;switch(h){case"line":a.beginPath(),a.moveTo(y,v),a.lineTo(t,n),a.stroke();break;case"rectangle":a.strokeRect(y,v,r,c);break;case"circle":const o=(y+t)/2,d=(v+n)/2,g=Math.abs(r/2),l=Math.abs(c/2);a.beginPath(),a.ellipse(o,d,g,l,0,0,2*Math.PI),a.stroke();break;case"arrow":a.beginPath(),a.moveTo(y,v),a.lineTo(t,n),a.stroke();const x=Math.atan2(n-v,t-y);xe(a,t,n,x,I*4);break}}else if(h!=="text"){switch(h){case"pencil":a.lineCap="round",a.lineJoin="round",a.lineTo(t,n),a.stroke();break;case"marker":a.lineCap="square",a.lineJoin="miter",a.lineTo(t,n),a.stroke();break;case"spray":for(let r=0;r<15;r++){const c=Math.random()*2*Math.PI,o=Math.random()*I,d=t+o*Math.cos(c),g=n+o*Math.sin(c);a.fillRect(d,g,1,1)}break}a.beginPath(),a.moveTo(t,n)}},be=e=>{if(k){S(null);return}if(!f.current)return;const t=f.current,{x:n,y:a}=We(e);let r=n,c=a;if(["line","rectangle","circle","arrow"].includes(h)&&(isNaN(n)||isNaN(a))&&(r=y,c=v),T&&["line","rectangle","circle","arrow"].includes(h)){t.putImageData(T,0,0);const o=r-y,d=c-v;switch(h){case"line":t.beginPath(),t.moveTo(y,v),t.lineTo(r,c),t.stroke();break;case"rectangle":t.strokeRect(y,v,o,d);break;case"circle":const g=(y+r)/2,l=(v+c)/2,x=Math.abs(o/2),_=Math.abs(d/2);t.beginPath(),t.ellipse(g,l,x,_,0,0,2*Math.PI),t.stroke();break;case"arrow":t.beginPath(),t.moveTo(y,v),t.lineTo(r,c),t.stroke();const p=Math.atan2(c-v,r-y);xe(t,r,c,p,I*4);break}X(null)}else h==="text"||t.closePath();L(!1),O()},Ae=()=>{const e=w.current,t=f.current;if(e&&t&&window.confirm(u("widgets.drawing_pad.clear_confirm"))){if(de(null),t.clearRect(0,0,e.width,e.height),H(!1),Y(""),C.current){const n=C.current.getContext("2d");n&&n.clearRect(0,0,C.current.width,C.current.height)}Z(!1),J({x:0,y:0}),S(null),z(!0)}},ne=(e,t,n)=>{b();const a=new FileReader;a.onload=r=>{const c=new Image;c.onload=()=>{de(c),me(),O()},c.src=r.target?.result},a.readAsDataURL(e),window.dispatchEvent(new CustomEvent("widget-title-update",{detail:{instanceId:A,title:e.name}})),V(e.name),G(t??null),Xe(n??null),z(!1)},Le=async()=>{const e=await rt({accept:"image/*",sourceWidgetId:"drawing-pad"});if(!e)return;if(e.source==="local"){const[r]=e.files;r&&ne(r,null,null);return}const[t]=e.entryIds;if(!t)return;const n=await re(t);if(!n?.blob)return;const a=new File([n.blob],n.name,{type:n.mime||n.blob.type});ne(a,n.parentId,n.id)};i.useEffect(()=>Ve("drawing-pad",async({entryId:t})=>{const n=await re(t);if(!n?.blob)return;const a=new File([n.blob],n.name,{type:n.mime||n.blob.type});ne(a,n.parentId,n.id)}),[]);const ye=()=>{const e=w.current;e&&e.toBlob(async t=>{if(!t)return;const n=U||u("widgets.drawing_pad.default_filename"),a=await at(n,{sourceWidgetId:"drawing-pad"});if(a){if(a?.destination==="file-manager"){await Ie({blob:t,filename:a.filename,sourceWidgetId:"drawing-pad",sourceWidgetTitleKey:"widgets.drawing_pad.title",parentId:a.parentId}),window.dispatchEvent(new CustomEvent("widget-title-update",{detail:{instanceId:A,title:a.filename}})),V(a.filename),G(a.parentId),z(!1);return}a?.destination==="download"&&(st(t,a.filename),G(null)),window.dispatchEvent(new CustomEvent("widget-title-update",{detail:{instanceId:A,title:a.filename}})),V(a.filename),z(!1)}},"image/png")},He=async()=>{const e=w.current;if(!e)return;let t=De;if(!t&&we&&(t=(await re(we))?.parentId??null),U&&t){e.toBlob(async n=>{n&&(await Ie({blob:n,filename:U,sourceWidgetId:"drawing-pad",sourceWidgetTitleKey:"widgets.drawing_pad.title",parentId:t}),z(!1))},"image/png");return}ye()},qe=i.useCallback((e,t,n)=>{const a=f.current;!a||!e||(a.font=`${I*2}px Arial`,a.fillStyle=N,a.fillText(e,t,n))},[I,N]),ve=()=>{q.trim()!==""&&(T?f.current?.putImageData(T,0,0):me(),qe(q,ue,he),O()),H(!1),Y(""),X(null),L(!1)},Ke=e=>{e.key==="Enter"&&ve()},Je=u(k?"widgets.drawing_pad.exit_pan":"widgets.drawing_pad.pan_mode");return s.jsxs("div",{className:"w-full h-full flex flex-col bg-gray-100 rounded-lg shadow-md overflow-hidden",children:[s.jsx(Ge,{children:s.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[s.jsxs("div",{className:"flex items-center gap-2 border-r pr-2",children:[s.jsx("button",{onClick:()=>{b(),oe("draw")},className:`p-2 rounded-md ${R==="draw"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.brush"),children:s.jsx(ft,{size:20})}),s.jsx("button",{onClick:()=>{b(),oe("erase")},className:`p-2 rounded-md ${R==="erase"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.eraser"),children:s.jsx(it,{size:20})})]}),R==="draw"&&s.jsxs("div",{className:"flex items-center gap-2 border-r pr-2",children:[s.jsx("button",{onClick:()=>{b(),j("pencil")},className:`p-2 rounded-md ${h==="pencil"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.pencil"),children:s.jsx(xt,{size:20})}),s.jsx("button",{onClick:()=>{b(),j("marker")},className:`p-2 rounded-md ${h==="marker"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.marker"),children:s.jsx(ct,{size:20})}),s.jsx("button",{onClick:()=>{b(),j("spray")},className:`p-2 rounded-md ${h==="spray"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.spray"),children:s.jsx(yt,{size:20})}),s.jsx("button",{onClick:()=>{b(),j("line")},className:`p-2 rounded-md ${h==="line"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.line"),children:s.jsx(ht,{size:20})}),s.jsx("button",{onClick:()=>{b(),j("rectangle")},className:`p-2 rounded-md ${h==="rectangle"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.rectangle"),children:s.jsx(ot,{size:20})}),s.jsx("button",{onClick:()=>{b(),j("circle")},className:`p-2 rounded-md ${h==="circle"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.circle"),children:s.jsx(lt,{size:20})}),s.jsx("button",{onClick:()=>{b(),j("arrow")},className:`p-2 rounded-md ${h==="arrow"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.arrow"),children:s.jsx(dt,{size:20})}),s.jsx("button",{onClick:()=>{b(),j("text")},className:`p-2 rounded-md ${h==="text"?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:u("widgets.drawing_pad.text"),children:s.jsx(kt,{size:20})})]}),s.jsxs("div",{className:"flex items-center gap-4",children:[R==="draw"&&s.jsx("input",{type:"color",value:N,onChange:e=>{b(),Se(e.target.value)},className:"w-8 h-8 cursor-pointer rounded-md border border-gray-300",title:u("widgets.drawing_pad.select_color")}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx("input",{type:"range",min:"1",max:"50",value:I,onChange:e=>{b(),_e(Number(e.target.value))},className:"w-24 h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer",title:u("widgets.drawing_pad.brush_size")}),s.jsx("span",{className:"text-sm w-6 text-center text-gray-700",children:I})]})]}),s.jsx("button",{onClick:Le,className:"p-2 rounded-md hover:bg-gray-300",title:u("widgets.drawing_pad.upload_image"),children:s.jsx(Qe,{size:20})}),s.jsx("button",{onClick:He,className:"p-2 rounded-md hover:bg-green-300 relative",title:u("actions.save"),children:s.jsxs("span",{className:"relative inline-flex",children:[s.jsx(tt,{size:20}),Ye&&s.jsx("span",{className:"absolute -top-1 -right-1 h-2 w-2 rounded-full bg-red-500","aria-hidden":"true"})]})}),s.jsx("button",{onClick:ye,className:"p-2 rounded-md hover:bg-green-300",title:u("actions.save_as"),children:s.jsx(nt,{size:20})}),s.jsx("button",{onClick:Ae,className:"p-2 rounded-md hover:bg-red-300",title:u("widgets.drawing_pad.clear_all"),children:s.jsx(Ze,{size:20})}),s.jsxs("div",{className:"ml-auto flex items-center gap-2 border-l pl-2",children:[s.jsx("button",{onClick:Be,className:`p-2 rounded-md ${k?"bg-blue-500 text-white":"hover:bg-gray-300"}`,title:Je,children:s.jsx(wt,{size:20})}),s.jsx("button",{onClick:$e,className:"p-2 rounded-md hover:bg-blue-300",title:u("widgets.drawing_pad.center_view"),children:s.jsx(et,{size:20})})]})]})}),s.jsxs("div",{className:"flex-grow w-full h-full relative bg-white",children:[s.jsx("canvas",{ref:w,onMouseDown:Oe,onMouseUp:e=>{if(k){S(null),O();return}h!=="text"&&be(e.nativeEvent)},onMouseLeave:e=>{k?S(null):ce&&h!=="text"&&be(e.nativeEvent)},onMouseMove:Fe,className:`w-full h-full block ${k?"cursor-grab":D?"cursor-grabbing":"cursor-crosshair"}`,style:{cursor:k?D?"grabbing":"grab":"crosshair"}}),!m&&K&&s.jsx("div",{className:"absolute inset-0 flex items-center justify-center text-gray-400 text-lg pointer-events-none",children:u("widgets.drawing_pad.start_drawing")}),le&&s.jsx("input",{type:"text",ref:ge,value:q,onChange:e=>Y(e.target.value),onBlur:ve,onKeyDown:Ke,style:{position:"absolute",left:ue,top:he,fontSize:`${I*2}px`,color:N,fontFamily:"Arial",backgroundColor:"rgba(255, 255, 255, 0.8)",border:"1px solid #ccc",padding:"2px 5px",zIndex:100,minWidth:"50px",outline:"none",transform:"translate(-50%, -50%)"},className:"rounded-md shadow-sm"})]})]})};export{_t as DrawingPadWidget,Tt as widgetConfig};
