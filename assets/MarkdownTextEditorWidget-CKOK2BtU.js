import{c as j,u as ut,r as c,f as wt,j as n,W as mt,ae as pt,al as xt,F as ht,a8 as kt,h as V}from"./index-C4lc0e_t.js";import{am as ne}from"./index-C4lc0e_t.js";import{d as ft}from"./marked.esm-IrHqQMcX.js";import{k as gt}from"./katex.min-2TduxwG8.js";import{S as _t,a as bt,s as Z,r as yt,d as vt}from"./saveDialog-dqU-mStL.js";import{r as jt}from"./openDialog-H-OCpcqq.js";import{B as Et,I as Ct,S as It,H as $t,a as St,b as Nt,L as Tt,c as zt,T as Lt,C as Mt}from"./text-CiQ2j9D6.js";import{C as Ot}from"./code-ywl6WCDH.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ft=[["path",{d:"m18 16 4-4-4-4",key:"1inbqp"}],["path",{d:"m6 8-4 4 4 4",key:"15zrgr"}],["path",{d:"m14.5 4-5 16",key:"e7oirm"}]],Rt=j("code-xml",Ft);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ht=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M12 3v18",key:"108xh3"}]],Wt=j("columns-2",Ht);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qt=[["path",{d:"M4 22h14a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v4",key:"1pf5j1"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"m5 12-3 3 3 3",key:"oke12k"}],["path",{d:"m9 18 3-3-3-3",key:"112psh"}]],At=j("file-code-2",qt);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pt=[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]],Dt=j("link-2",Pt);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vt=[["path",{d:"M16 3a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2 1 1 0 0 1 1 1v1a2 2 0 0 1-2 2 1 1 0 0 0-1 1v2a1 1 0 0 0 1 1 6 6 0 0 0 6-6V5a2 2 0 0 0-2-2z",key:"rib7q0"}],["path",{d:"M5 3a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2 1 1 0 0 1 1 1v1a2 2 0 0 1-2 2 1 1 0 0 0-1 1v2a1 1 0 0 0 1 1 6 6 0 0 0 6-6V5a2 2 0 0 0-2-2z",key:"1ymkrd"}]],Bt=j("quote",Vt),tt="https://edicuatex.github.io";function B(E,o,M={}){const b=[],f=(l,w)=>{const C=gt.renderToString(l.trim(),{throwOnError:!1,displayMode:w,output:M.katexOutput}),k=`%%MATH_${b.length}%%`;return b.push({token:k,html:C}),k};let d=o;d=d.replace(/\\\[((?:.|\n)+?)\\\]/g,(l,w)=>f(w,!0)),d=d.replace(/\$\$([\s\S]+?)\$\$/g,(l,w)=>f(w,!0)),d=d.replace(/\\\((.+?)\\\)/g,(l,w)=>f(w,!1)),d=d.replace(/\$([\s\S]+?)\$/g,(l,w)=>f(w,!1));let a=ft.parse(d);b.forEach(({token:l,html:w})=>{a=a.replace(l,w)}),E.innerHTML=a}const Zt=({instanceId:E})=>{const{t:o,i18n:M,ready:b}=ut(),f=c.useRef(E??`markdown-text-editor-${Date.now()}-${Math.random().toString(16).slice(2)}`),d=E??f.current,[a,l]=c.useState(o("widgets.markdown_text_editor.sample_content")),[w,C]=c.useState(""),[k,y]=c.useState(""),[I,O]=c.useState("split"),[F,R]=c.useState(null),[et,$]=c.useState(null),[J,K]=c.useState(null),m=c.useRef(null),U=c.useRef(null),H=c.useRef(null),h=c.useRef(null),nt=c.useMemo(()=>{const t=new URL(`${tt}/index.html`);return t.searchParams.set("pm","1"),t.searchParams.set("origin",window.location.origin),t},[]);c.useEffect(()=>{const t=o("widgets.markdown_text_editor.sample_content");t!=="widgets.markdown_text_editor.sample_content"&&l(t)},[o,M.language]),c.useEffect(()=>{const t=H.current;if(t)return document.body.appendChild(t),()=>{t.parentNode&&t.parentNode.removeChild(t)}},[]);const v=t=>{C(t),setTimeout(()=>C(""),1800)},g=(t,s)=>{const e=m.current;e&&requestAnimationFrame(()=>{e.focus(),e.setSelectionRange(t,s)})},S=(t,s,e)=>{const r=m.current;if(!r)return;const i=r.selectionStart,u=r.selectionEnd,x=a.slice(i,u)||e,_=`${a.slice(0,i)}${t}${x}${s}${a.slice(u)}`;l(_),g(i+t.length,i+t.length+x.length)},W=t=>{const s=m.current;if(!s)return;const e=s.selectionStart,r=s.selectionEnd,i=a,u=i.lastIndexOf(`
`,e-1)+1,p=i.indexOf(`
`,r),x=p===-1?i.length:p,D=i.slice(u,x).split(`
`),N=D.every(L=>L.startsWith(t)),T=D.map(L=>N?L.slice(t.length):`${t}${L}`).join(`
`),z=`${i.slice(0,u)}${T}${i.slice(x)}`;l(z);const Y=u+T.length;g(Y,Y)},q=t=>{const s=`${"#".repeat(t)} `,e=m.current;if(!e)return;const r=e.selectionStart,i=a,u=i.lastIndexOf(`
`,r-1)+1,p=i.indexOf(`
`,r),x=p===-1?i.length:p,_=i.slice(u,x),N=_.startsWith(s)?_.slice(s.length):`${s}${_}`,T=`${i.slice(0,u)}${N}${i.slice(x)}`;l(T);const z=u+N.length;g(z,z)},st=()=>{const t=m.current;if(!t)return;const s=t.selectionStart,e=t.selectionEnd,r=a.slice(s,e)||o("widgets.markdown_text_editor.placeholders.code"),i="```\n",p=`${a.slice(0,s)}${i}${r}
\`\`\`${a.slice(e)}`;l(p),g(s+i.length,s+i.length+r.length)},ot=()=>{const t=m.current;if(!t)return;const s=t.selectionStart,e=t.selectionEnd,r=a.slice(s,e)||o("widgets.markdown_text_editor.placeholders.link_text"),i=window.prompt(o("widgets.markdown_text_editor.prompts.link_url"));if(!i)return;const u=`[${r}](${i})`,p=`${a.slice(0,s)}${u}${a.slice(e)}`;l(p),g(s+1,s+1+r.length)},X=c.useCallback(t=>{const s=m.current;if(!s)return;const e=s.selectionStart,r=s.selectionEnd;l(i=>`${i.slice(0,e)}${t}${i.slice(r)}`),g(e+t.length,e+t.length)},[]),it=()=>{navigator.clipboard.writeText(a).then(()=>v(o("widgets.markdown_text_editor.source_copied"))).catch(()=>v(o("widgets.markdown_text_editor.copy_failed")))},rt=()=>{const t=document.createElement("div");try{B(t,a,{katexOutput:"html"})}catch(i){const u=i instanceof Error?i.message:o("widgets.markdown_text_editor.preview_error");t.innerHTML=`<div class="error-message">${u}</div>`}const e=(()=>{let i="";for(const u of Array.from(document.styleSheets))try{const p=Array.from(u.cssRules||[]);for(const x of p)x.cssText.includes(".katex")&&(i+=x.cssText)}catch{}return i.trim()})(),r=e?`<style>${e}</style>${t.innerHTML}`:t.innerHTML;navigator.clipboard.writeText(r).then(()=>v(o("widgets.markdown_text_editor.html_copied"))).catch(()=>v(o("widgets.markdown_text_editor.copy_failed")))},G=async()=>{const t=new Blob([a],{type:"text/markdown;charset=utf-8"}),s=F||o("widgets.markdown_text_editor.default_filename"),e=await yt(s,{sourceWidgetId:"markdown-text-editor"});if(!e)return;e?.destination==="file-manager"?(await Z({blob:t,filename:e.filename,sourceWidgetId:"markdown-text-editor",sourceWidgetTitleKey:"widgets.markdown_text_editor.title",parentId:e.parentId}),$(e.parentId)):e?.destination==="download"&&(vt(t,e.filename),$(null)),window.dispatchEvent(new CustomEvent("widget-title-update",{detail:{instanceId:d,title:e.filename}})),R(e.filename),window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:d,widgetId:"markdown-text-editor",isDirty:!1}}));const r=JSON.stringify({input:a});y(r),window.dispatchEvent(new CustomEvent("widget-save-complete",{detail:{instanceId:d,widgetId:"markdown-text-editor"}}))},A=async()=>{let t=et;if(!t&&J&&(t=(await V(J))?.parentId??null),F&&t){const s=new Blob([a],{type:"text/markdown;charset=utf-8"});await Z({blob:s,filename:F,sourceWidgetId:"markdown-text-editor",sourceWidgetTitleKey:"widgets.markdown_text_editor.title",parentId:t}),window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:d,widgetId:"markdown-text-editor",isDirty:!1}}));const e=JSON.stringify({input:a});y(e),window.dispatchEvent(new CustomEvent("widget-save-complete",{detail:{instanceId:d,widgetId:"markdown-text-editor"}}));return}await G()},Q=async(t,s,e)=>{const r=await t.text();l(r),y(JSON.stringify({input:r})),window.dispatchEvent(new CustomEvent("widget-title-update",{detail:{instanceId:d,title:t.name}})),R(t.name),$(s??null),K(e??null),window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:d,widgetId:"markdown-text-editor",isDirty:!1}}))},at=async()=>{const t=await jt({accept:".md,.txt",sourceWidgetId:"markdown-text-editor"});if(!t)return;if(t.source==="local"){const[i]=t.files;i&&await Q(i,null,null);return}const[s]=t.entryIds;if(!s)return;const e=await V(s);if(!e?.blob)return;const r=new File([e.blob],e.name,{type:e.mime||e.blob.type});await Q(r,e.parentId,e.id)},dt=async()=>{const t=H.current;if(!t)return;B(t,a);try{await document.fonts?.ready}catch{}await new Promise(e=>requestAnimationFrame(()=>e()));const s=()=>{t.innerHTML="",window.removeEventListener("afterprint",s)};window.addEventListener("afterprint",s),window.print()},ct=()=>{const t=m.current?m.current.value.slice(m.current.selectionStart,m.current.selectionEnd).trim():"",s=new URL(nt.toString());if(t&&s.searchParams.set("sel",t),h.current&&!h.current.closed){h.current.focus();return}const e=window.open(s.toString(),"edicuatex","width=1100,height=800,menubar=no,toolbar=no,location=no,status=no");if(!e){v(o("widgets.markdown_text_editor.popup_blocked"));return}h.current=e};c.useEffect(()=>{const t=s=>{if(s.origin!==tt||!s.data||s.data.type!=="edicuatex:result")return;const e=s.data,r=e.latex?`$$${e.latex}$$`:"",i=e.wrapped||r;i&&(X(i),h.current&&!h.current.closed&&h.current.close(),h.current=null)};return window.addEventListener("message",t),()=>window.removeEventListener("message",t)},[X]),c.useEffect(()=>{const t=U.current;if(t)try{B(t,a)}catch(s){const e=s instanceof Error?s.message:o("widgets.markdown_text_editor.preview_error");t.innerHTML=`<div class="error-message">${e}</div>`}},[a,o]),c.useEffect(()=>{k||y(JSON.stringify({input:a}))},[a,k]),c.useEffect(()=>wt("markdown-text-editor",async({entryId:s,instanceId:e})=>{if(e&&e!==d)return;const r=await V(s);if(!r?.blob)return;const i=await r.blob.text();l(i),y(JSON.stringify({input:i})),window.dispatchEvent(new CustomEvent("widget-title-update",{detail:{instanceId:d,title:r.name}})),R(r.name),$(r.parentId),K(r.id),window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:d,widgetId:"markdown-text-editor",isDirty:!1}}))}),[]);const lt=c.useMemo(()=>JSON.stringify({input:a}),[a]),P=k!==""&&lt!==k;return c.useEffect(()=>{window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:d,widgetId:"markdown-text-editor",isDirty:P}}))},[P,d]),c.useEffect(()=>{const t=s=>{const e=s;e.detail?.instanceId===d&&(e.detail?.widgetId&&e.detail.widgetId!=="markdown-text-editor"||A())};return window.addEventListener("widget-save-request",t),()=>window.removeEventListener("widget-save-request",t)},[A,d]),c.useEffect(()=>()=>{window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:d,widgetId:"markdown-text-editor",isDirty:!1}}))},[d]),b?n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:`markdown-text-editor-widget view-${I}`,children:[n.jsx(mt,{children:n.jsxs("div",{className:"markdown-toolbar",children:[n.jsxs("div",{className:"markdown-toolbar-group",children:[n.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.bold"),onClick:()=>S("**","**",o("widgets.markdown_text_editor.placeholders.text")),children:n.jsx(Et,{size:16})}),n.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.italic"),onClick:()=>S("*","*",o("widgets.markdown_text_editor.placeholders.text")),children:n.jsx(Ct,{size:16})}),n.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.strike"),onClick:()=>S("~~","~~",o("widgets.markdown_text_editor.placeholders.text")),children:n.jsx(It,{size:16})}),n.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.h1"),onClick:()=>q(1),children:n.jsx($t,{size:16})}),n.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.h2"),onClick:()=>q(2),children:n.jsx(St,{size:16})}),n.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.h3"),onClick:()=>q(3),children:n.jsx(Nt,{size:16})}),n.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.bullet_list"),onClick:()=>W("- "),children:n.jsx(Tt,{size:16})}),n.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.ordered_list"),onClick:()=>W("1. "),children:n.jsx(zt,{size:16})}),n.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.quote"),onClick:()=>W("> "),children:n.jsx(Bt,{size:16})}),n.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.inline_code"),onClick:()=>S("`","`",o("widgets.markdown_text_editor.placeholders.code")),children:n.jsx(Ot,{size:16})}),n.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.code_block"),onClick:st,children:n.jsx(Rt,{size:16})}),n.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.link"),onClick:ot,children:n.jsx(Dt,{size:16})})]}),n.jsxs("div",{className:"markdown-toolbar-group",children:[w&&n.jsx("span",{className:"feedback-message",children:w}),n.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.view_split"),onClick:()=>O("split"),className:I==="split"?"is-active":"",children:n.jsx(Wt,{size:16})}),n.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.view_editor"),onClick:()=>O("editor"),className:I==="editor"?"is-active":"",children:n.jsx(Lt,{size:16})}),n.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.view_preview"),onClick:()=>O("preview"),className:I==="preview"?"is-active":"",children:n.jsx(pt,{size:16})}),n.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.formula"),onClick:ct,children:n.jsx(xt,{size:16})}),n.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.copy_source"),onClick:it,children:n.jsx(Mt,{size:16})}),n.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.copy_html"),onClick:rt,children:n.jsx(At,{size:16})}),n.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.open_file"),onClick:at,children:n.jsx(ht,{size:16})}),n.jsx("button",{type:"button",title:o("actions.save"),onClick:A,className:"save-indicator-button",children:n.jsxs("span",{className:"save-indicator-icon",children:[n.jsx(_t,{size:16}),P&&n.jsx("span",{className:"save-indicator-dot","aria-hidden":"true"})]})}),n.jsx("button",{type:"button",title:o("actions.save_as"),onClick:G,children:n.jsx(bt,{size:16})}),n.jsx("button",{type:"button",title:o("widgets.markdown_text_editor.toolbar.export_pdf"),onClick:dt,children:n.jsx(kt,{size:16})})]})]})}),n.jsxs("div",{className:"markdown-body",children:[n.jsxs("div",{className:"markdown-pane markdown-editor-pane",children:[n.jsx("div",{className:"markdown-pane-header",children:o("widgets.markdown_text_editor.editor_title")}),n.jsx("textarea",{ref:m,value:a,onChange:t=>l(t.target.value),spellCheck:!0,className:"editor-textarea"})]}),n.jsxs("div",{className:"markdown-pane markdown-preview-pane",children:[n.jsx("div",{className:"markdown-pane-header",children:o("widgets.markdown_text_editor.preview_title")}),n.jsx("div",{className:"preview-pane prose",ref:U})]})]})]}),n.jsx("div",{id:"markdown-text-editor-print",ref:H,className:"prose"})]}):n.jsx("div",{className:"flex items-center justify-center h-full",children:o("loading")})};export{Zt as MarkdownTextEditorWidget,ne as widgetConfig};
