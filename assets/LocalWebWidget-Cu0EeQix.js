import{u as _e,r as w,j as o,W as Ne,F as We,ae as ke,T as Pe,ac as Ce,h as Ae,ai as Ie,N as Q}from"./index-CmQIKd-y.js";import{aj as tt}from"./index-CmQIKd-y.js";import{r as Le}from"./openDialog-H-OCpcqq.js";import{a as Re,C as Be}from"./chevron-right-BfHMy29C.js";import{C as Oe}from"./cloud-upload-B5iaqmeW.js";const Ue="escritorio-digital-sites",$e=1,L="sites",A="files",ue="active-profile-name",ie="active-profile-change",we="Escritorio Principal";let Z=null,q=null;const K=()=>(Z||(Z=new Promise((e,s)=>{const n=window.indexedDB.open(Ue,$e);n.onupgradeneeded=()=>{const r=n.result;r.objectStoreNames.contains(L)||r.createObjectStore(L,{keyPath:"id"}),r.objectStoreNames.contains(A)||r.createObjectStore(A,{keyPath:"key"}).createIndex("siteId","siteId",{unique:!1})},n.onsuccess=()=>e(n.result),n.onerror=()=>s(n.error)})),Z),ce=()=>{const e=window.localStorage.getItem(ue);if(!e)return we;try{const s=JSON.parse(e);return typeof s=="string"&&s.trim()?s:e}catch{return e}},te=async(e,s,n)=>{const r=await K();return new Promise((d,c)=>{const m=r.transaction(e,s).objectStore(e),_=n(m);_.onsuccess=()=>d(_.result),_.onerror=()=>c(_.error)})},ze=async(e,s)=>{const n=s.filter(r=>!r.profileName);n.length!==0&&await te(L,"readwrite",r=>(n.forEach(d=>{r.put({...d,profileName:e})}),r.getAll()))},Fe=async e=>{const n=await te(L,"readonly",r=>r.getAll())??[];return n.some(r=>!r.profileName)?(await ze(e,n),n.map(r=>({...r,profileName:r.profileName??e})).filter(r=>r.profileName===e)):n.filter(r=>r.profileName===e)},D=async e=>{await te(L,"readwrite",s=>s.put(e))},Te=async e=>{const s=await K();await new Promise((n,r)=>{const d=s.transaction([L,A],"readwrite");d.objectStore(L).delete(e);const c=d.objectStore(A),m=c.index("siteId").getAllKeys(IDBKeyRange.only(e));m.onsuccess=()=>{m.result.forEach(R=>c.delete(R))},d.oncomplete=()=>n(),d.onerror=()=>r(d.error)})},Me=async e=>{const s=await K();return new Promise((n,r)=>{const m=s.transaction(A,"readonly").objectStore(A).index("siteId").getAll(IDBKeyRange.only(e));m.onsuccess=()=>n(m.result??[]),m.onerror=()=>r(m.error)})},le=async e=>{if(e.length===0)return;const s=await K();await new Promise((n,r)=>{const d=s.transaction(A,"readwrite"),c=d.objectStore(A);e.forEach(l=>c.put(l)),d.oncomplete=()=>n(),d.onerror=()=>r(d.error)})},de=e=>{const s=e.toLowerCase();return s.endsWith(".html")||s.endsWith(".htm")?"text/html":s.endsWith(".css")?"text/css":s.endsWith(".js")?"text/javascript":s.endsWith(".json")?"application/json":s.endsWith(".svg")?"image/svg+xml":s.endsWith(".png")?"image/png":s.endsWith(".jpg")||s.endsWith(".jpeg")?"image/jpeg":s.endsWith(".webp")?"image/webp":s.endsWith(".gif")?"image/gif":s.endsWith(".woff")?"font/woff":s.endsWith(".woff2")?"font/woff2":s.endsWith(".ttf")?"font/ttf":s.endsWith(".otf")?"font/otf":s.endsWith(".ico")?"image/x-icon":"application/octet-stream"},N=e=>e.replace(/\\/g,"/").replace(/^\.?\//,""),ee=(e,s)=>{if(s.startsWith("/"))return N(s.slice(1));const n=N(e).split("/");n.pop();const r=s.split("/"),d=[...n,...r],c=[];return d.forEach(l=>{!l||l==="."||(l===".."?c.pop():c.push(l))}),c.join("/")},X=e=>{const s=e.map(l=>N(l)),n=s.map(l=>l.toLowerCase()),r=n.indexOf("index.html");if(r!==-1)return s[r];const d=n.indexOf("index.htm");if(d!==-1)return s[d];const c=n.findIndex(l=>l.endsWith(".html")||l.endsWith(".htm"));return c!==-1?s[c]:s[0]??""},qe=e=>N(e).split("/").map(n=>encodeURIComponent(n)).join("/"),De=(e,s)=>{const n=qe(s);return Q(`local-web/site/${e}/${n}`)},Ve=async()=>"serviceWorker"in navigator?q||(q=(async()=>{try{const e=await navigator.serviceWorker.register(Q("local-web-sw.js"),{scope:Q("local-web/")}),s=e.installing||e.waiting||e.active;return s?(s.state==="activated"||await new Promise(n=>{const r=()=>{s.state==="activated"&&(s.removeEventListener("statechange",r),n())};s.addEventListener("statechange",r)}),!0):!1}catch{return!1}})(),q):!1,me=(e,s,n)=>e.replace(/url\(([^)]+)\)/g,(r,d)=>{const c=String(d).trim().replace(/^['"]|['"]$/g,"");if(c.startsWith("data:")||c.startsWith("http:")||c.startsWith("https:")||c.startsWith("blob:")||c.startsWith("#"))return r;const l=ee(s,c),m=n.get(l);return m?`url("${m}")`:r}),Ke=(e,s,n,r)=>{const c=new DOMParser().parseFromString(e,"text/html"),l=(g,W)=>{Array.from(c.querySelectorAll(g)).forEach(S=>{const b=S.getAttribute(W);if(!b||b.startsWith("http:")||b.startsWith("https:")||b.startsWith("data:")||b.startsWith("blob:")||b.startsWith("#")||b.startsWith("mailto:"))return;const j=ee(s,b),x=(W==="href"?r.get(j):null)||n.get(j);x&&S.setAttribute(W,x)})},m=g=>g.split(",").map(S=>S.trim()).filter(Boolean).map(S=>{const b=S.split(/\s+/),j=b[0];if(j.startsWith("http:")||j.startsWith("https:")||j.startsWith("data:")||j.startsWith("blob:")||j.startsWith("#")||j.startsWith("mailto:"))return S;const x=ee(s,j),k=n.get(x);return k?(b[0]=k,b.join(" ")):S}).join(", ");return l("img[src]","src"),l("script[src]","src"),l("link[href]","href"),l("source[src]","src"),l("video[src]","src"),l("audio[src]","src"),l("iframe[src]","src"),l("a[href]","href"),l("form[action]","action"),Array.from(c.querySelectorAll("img[srcset], source[srcset]")).forEach(g=>{const W=g.getAttribute("srcset");W&&g.setAttribute("srcset",m(W))}),Array.from(c.querySelectorAll("style")).forEach(g=>{g.textContent&&(g.textContent=me(g.textContent,s,n))}),`<!DOCTYPE html>${c.documentElement.outerHTML}`},V=e=>{if(!Number.isFinite(e))return"0 B";if(e<1024)return`${e} B`;const s=e/1024;if(s<1024)return`${s.toFixed(1)} KB`;const n=s/1024;return n<1024?`${n.toFixed(1)} MB`:`${(n/1024).toFixed(2)} GB`},He=async()=>{if(!navigator.storage||!navigator.storage.estimate)return{usage:null,quota:null};const e=await navigator.storage.estimate();return{usage:typeof e.usage=="number"?e.usage:null,quota:typeof e.quota=="number"?e.quota:null}},Xe=()=>{const{t:e}=_e(),[s,n]=w.useState([]),[r,d]=w.useState(null),[c,l]=w.useState(()=>ce()),[m,_]=w.useState(null),[R,g]=w.useState(""),[W,$]=w.useState(null),[S,b]=w.useState(""),[j,x]=w.useState(""),[k,fe]=w.useState({usage:null,quota:null}),[z,he]=w.useState(!1),H=w.useRef(null),I=w.useRef([]),F=w.useRef(!1),O=async t=>{const a=await Fe(t);a.sort((i,u)=>u.updatedAt-i.updatedAt),n(a)},U=async()=>{const t=await He();fe(t)},Y=()=>{window.dispatchEvent(new Event("storage-usage-changed"))};w.useEffect(()=>{const t=H.current;t&&(t.webkitdirectory=!0,t.setAttribute("webkitdirectory",""),t.setAttribute("directory",""))},[]),w.useEffect(()=>{const t=i=>{const u=i.detail;l(u?.name||ce())},a=i=>{if(i.key===ue){if(!i.newValue){l(we);return}try{const u=JSON.parse(i.newValue);l(typeof u=="string"&&u.trim()?u:i.newValue)}catch{l(i.newValue)}}};return window.addEventListener(ie,t),window.addEventListener("storage",a),()=>{window.removeEventListener(ie,t),window.removeEventListener("storage",a)}},[]),w.useEffect(()=>{O(c),U(),G()},[c]),w.useEffect(()=>{const t=()=>{O(c),U()};return window.addEventListener("local-web-data-changed",t),()=>{window.removeEventListener("local-web-data-changed",t)}},[c]),w.useEffect(()=>()=>{I.current.forEach(t=>URL.revokeObjectURL(t)),I.current=[]},[]);const pe=w.useMemo(()=>{const{usage:t,quota:a}=k;if(t!=null&&a!=null){const i=Math.min(100,Math.round(t/a*100));return e("widgets.local_web.storage_usage",{used:V(t),total:V(a),percent:i})}return t!=null?e("widgets.local_web.storage_used",{used:V(t)}):e("widgets.local_web.storage_unknown")},[k,e]),be=w.useMemo(()=>{const{usage:t,quota:a}=k;if(t==null||a==null)return"local-web-storage-neutral";const i=t/a;return i<.7?"local-web-storage-ok":i<.85?"local-web-storage-warn":"local-web-storage-danger"},[k]),se=w.useMemo(()=>{const{usage:t,quota:a}=k;return t==null||a==null?null:Math.min(100,Math.max(0,Math.round(t/a*100)))},[k]),ne=()=>{I.current.forEach(t=>URL.revokeObjectURL(t)),I.current=[]},G=()=>{d(null),_(null),g(""),ne()},ge=()=>{if(!m)return;const t=window.screen.width,a=window.screen.height,i=window.open("","_blank",`popup=1,width=${t},height=${a},left=0,top=0`);if(!i)return;const u=R.replace(/</g,"&lt;").replace(/>/g,"&gt;");i.document.write(`<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>${u}</title>
    <style>
      html, body { margin: 0; padding: 0; height: 100%; }
      body { display: flex; flex-direction: column; font-family: sans-serif; }
      header { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: #f5f5f5; border-bottom: 1px solid #e0e0e0; transition: opacity 0.3s; }
      header.hidden { display: none; }
      button { border: 1px solid #ccc; background: #fff; padding: 6px 10px; border-radius: 6px; cursor: pointer; }
      iframe { flex: 1; border: 0; width: 100%; }
    </style>
  </head>
  <body>
    <header>
      <span>${u}</span>
      <div>
        <button id="fullscreen">${e("widgets.local_web.open_fullscreen_button")}</button>
        <button id="close">${e("widgets.local_web.close_window_button")}</button>
      </div>
    </header>
    <iframe src="${m}" title="${u}"></iframe>
    <script>
      const fullBtn = document.getElementById('fullscreen');
      const closeBtn = document.getElementById('close');
      const header = document.querySelector('header');

      fullBtn.addEventListener('click', () => {
        const root = document.documentElement;
        if (root.requestFullscreen) root.requestFullscreen();
      });

      closeBtn.addEventListener('click', () => window.close());

      document.addEventListener('fullscreenchange', () => {
        if (document.fullscreenElement) {
          header.classList.add('hidden');
        } else {
          header.classList.remove('hidden');
        }
      });
    <\/script>
  </body>
</html>`),i.document.close(),i.focus()},re=async t=>{if(!window.confirm(e("widgets.local_web.confirm_extract",{name:t.name})))return;x(e("widgets.local_web.importing"));const i=await t.arrayBuffer(),u=Ie(new Uint8Array(i)),f=[];if(Object.keys(u).forEach(h=>{if(h.endsWith("/")||h.startsWith("__MACOSX/"))return;const B=N(h),T=u[h],p=de(B),E=new Blob([T],{type:p});f.push({key:"",siteId:"",path:B,blob:E,size:E.size,type:p})}),f.length===0){x(e("widgets.local_web.import_empty"));return}const y=crypto.randomUUID(),P=Date.now(),v=X(f.map(h=>h.path)),C={id:y,name:t.name.replace(/\.zip$/i,""),profileName:c,indexPath:v,createdAt:P,updatedAt:P,fileCount:f.length,totalBytes:f.reduce((h,B)=>h+B.size,0)};f.forEach(h=>{h.siteId=y,h.key=`${y}::${h.path}`}),await D(C),await le(f),x(e("widgets.local_web.import_done")),await O(c),await U(),Y()},xe=async t=>{if(!t.length)return;x(e("widgets.local_web.importing"));const a=crypto.randomUUID(),i=Date.now(),u=[];Array.from(t).forEach(v=>{const C=N(v.webkitRelativePath||v.name),h=v.slice(0,v.size,v.type||de(C));u.push({key:`${a}::${C}`,siteId:a,path:C,blob:h,size:h.size,type:h.type})});const f=t[0].webkitRelativePath?.split("/")[0]||t[0].name,y=X(u.map(v=>v.path)),P={id:a,name:f,profileName:c,indexPath:y,createdAt:i,updatedAt:i,fileCount:u.length,totalBytes:u.reduce((v,C)=>v+C.size,0)};await D(P),await le(u),x(e("widgets.local_web.import_done")),await O(c),await U(),Y()},ye=async t=>{x(e("widgets.local_web.loading"));const a=await Me(t.id),i=t.indexPath||X(a.map(p=>p.path));if(!i){x(e("widgets.local_web.missing_index"));return}if(!t.indexPath||t.indexPath!==i){const p={...t,indexPath:i};await D(p),n(E=>E.map(M=>M.id===t.id?p:M))}if(ne(),await Ve()){g(t.name),_(De(t.id,i)),d(t.id),x("");return}const f=new Map;a.forEach(p=>f.set(N(p.path),p));const y=new Map;a.forEach(p=>{const E=URL.createObjectURL(p.blob);I.current.push(E),y.set(N(p.path),E)});const P=new Map;for(const p of a.filter(E=>E.path.toLowerCase().endsWith(".css")))try{const E=await p.blob.text(),M=me(E,p.path,y),Ee=new Blob([M],{type:"text/css"}),ae=URL.createObjectURL(Ee);I.current.push(ae),P.set(N(p.path),ae)}catch{}const v=f.get(N(i));if(!v){x(e("widgets.local_web.missing_index"));return}const C=await v.blob.text(),h=Ke(C,i,y,P),B=new Blob([h],{type:"text/html"}),T=URL.createObjectURL(B);I.current.push(T),g(t.name),_(T),d(t.id),x("")},J=()=>{$(null),b("")},oe=async t=>{const a=S.trim();if(!a){alert(e("widgets.local_web.rename_invalid"));return}if(a===t.name){J();return}const i={...t,name:a,updatedAt:Date.now()};await D(i),n(u=>{const f=u.map(y=>y.id===t.id?i:y);return f.sort((y,P)=>P.updatedAt-y.updatedAt),f}),r===t.id&&g(a),J()},ve=async()=>{const t=await Le({accept:".zip"});if(!t)return;if(t.source==="local"){const[f]=t.files;f&&await re(f);return}const[a]=t.entryIds;if(!a)return;const i=await Ae(a);if(!i?.blob)return;const u=new File([i.blob],i.name,{type:i.mime||i.blob.type});await re(u)},je=async t=>{t.target.files&&(await xe(t.target.files),t.target.value="")},Se=async t=>{window.confirm(e("widgets.local_web.confirm_delete"))&&(r===t&&G(),await Te(t),await O(c),await U(),Y())};return o.jsxs("div",{className:"local-web-widget",children:[o.jsx(Ne,{children:o.jsxs("div",{className:"local-web-header",children:[o.jsxs("div",{className:"local-web-title",children:[o.jsx(We,{size:18}),o.jsx("span",{children:e("widgets.local_web.title")})]}),o.jsx("div",{className:"local-web-description",children:e("widgets.local_web.description")}),o.jsxs("div",{className:"local-web-actions",children:[o.jsxs("button",{className:"local-web-button local-web-button-secondary",onClick:()=>he(t=>!t),children:[z?o.jsx(Re,{size:16}):o.jsx(Be,{size:16}),e(z?"widgets.local_web.expand_list":"widgets.local_web.collapse_list")]}),o.jsxs("button",{className:"local-web-button",onClick:ve,children:[o.jsx(Oe,{size:16}),e("widgets.local_web.import_zip")]}),o.jsx("button",{className:"local-web-button",onClick:()=>H.current?.click(),children:e("widgets.local_web.import_folder")})]})]})}),o.jsxs("div",{className:`local-web-storage ${be}`,children:[o.jsx("div",{className:"local-web-storage-text",children:pe}),se!==null&&o.jsx("div",{className:"local-web-storage-bar",children:o.jsx("div",{className:"local-web-storage-bar-fill",style:{width:`${se}%`}})})]}),o.jsxs("div",{className:`local-web-body${z?" local-web-body-collapsed":""}`,children:[o.jsxs("div",{className:`local-web-list${z?" local-web-list-collapsed":""}`,children:[j&&o.jsx("div",{className:"local-web-status",children:j}),s.length===0&&o.jsx("div",{className:"local-web-empty",children:e("widgets.local_web.empty_state")}),s.map(t=>o.jsxs("div",{className:"local-web-site",children:[o.jsxs("div",{className:"local-web-site-info",children:[W===t.id?o.jsx("input",{type:"text",value:S,onChange:a=>b(a.target.value),onBlur:()=>{if(F.current){F.current=!1;return}oe(t)},onKeyDown:a=>{a.key==="Enter"&&(F.current=!0,oe(t)),a.key==="Escape"&&(F.current=!0,J())},placeholder:e("widgets.local_web.rename_placeholder"),className:"local-web-site-name-input",autoFocus:!0}):o.jsx("div",{className:"local-web-site-name local-web-site-name-editable",onDoubleClick:()=>{$(t.id),b(t.name)},children:t.name}),o.jsx("div",{className:"local-web-site-meta",children:e("widgets.local_web.site_meta",{files:t.fileCount,size:V(t.totalBytes)})})]}),o.jsxs("div",{className:"local-web-site-actions",children:[o.jsx("button",{className:"local-web-icon-button",onClick:()=>ye(t),children:o.jsx(ke,{size:16})}),o.jsx("button",{className:"local-web-icon-button local-web-delete",onClick:()=>Se(t.id),children:o.jsx(Pe,{size:16})})]})]},t.id))]}),o.jsx("div",{className:"local-web-preview",children:m?o.jsxs(o.Fragment,{children:[o.jsxs("div",{className:"local-web-preview-header",children:[o.jsx("span",{children:R}),o.jsxs("div",{className:"local-web-preview-actions",children:[o.jsxs("button",{className:"local-web-button local-web-button-secondary",onClick:ge,children:[o.jsx(Ce,{size:14}),e("widgets.local_web.open_fullscreen_window")]}),o.jsx("button",{className:"local-web-button local-web-button-secondary",onClick:G,children:e("widgets.local_web.close_preview")})]})]}),o.jsx("iframe",{className:"local-web-iframe",src:m,title:R,sandbox:"allow-scripts allow-same-origin allow-forms"})]}):o.jsx("div",{className:"local-web-preview-placeholder",children:e("widgets.local_web.preview_placeholder")})})]}),o.jsx("input",{ref:H,type:"file",className:"hidden",onChange:je})]})};export{Xe as LocalWebWidget,tt as widgetConfig};
