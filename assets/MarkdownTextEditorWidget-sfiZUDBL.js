import{c as k,u as ot,r as c,s as st,j as e,a5 as it,F as rt,V as at,g as J}from"./index-anQAYAUl.js";import{a6 as Qt}from"./index-anQAYAUl.js";import{d as dt}from"./marked.esm-IrHqQMcX.js";import{k as ct}from"./katex.min-2TduxwG8.js";import{r as lt,s as ut,d as mt}from"./saveDialog-C3Mvo_aI.js";import{r as wt}from"./openDialog-H-OCpcqq.js";import{B as xt,I as pt,S as ht,H as kt,a as _t,b as gt,L as ft,c as bt,T as yt}from"./text-BB_mSXt5.js";import{C as vt}from"./code-D8BYTW28.js";import{E as jt}from"./eye-8f13BcYT.js";import{S as $t}from"./save-CIe-Yn12.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Et=[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}]],Ct=k("clipboard",Et);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const St=[["path",{d:"m18 16 4-4-4-4",key:"1inbqp"}],["path",{d:"m6 8-4 4 4 4",key:"15zrgr"}],["path",{d:"m14.5 4-5 16",key:"e7oirm"}]],zt=k("code-xml",St);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Nt=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M12 3v18",key:"108xh3"}]],It=k("columns-2",Nt);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lt=[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]],Mt=k("link-2",Lt);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ot=[["path",{d:"M16 3a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2 1 1 0 0 1 1 1v1a2 2 0 0 1-2 2 1 1 0 0 0-1 1v2a1 1 0 0 0 1 1 6 6 0 0 0 6-6V5a2 2 0 0 0-2-2z",key:"rib7q0"}],["path",{d:"M5 3a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2 1 1 0 0 1 1 1v1a2 2 0 0 1-2 2 1 1 0 0 0-1 1v2a1 1 0 0 0 1 1 6 6 0 0 0 6-6V5a2 2 0 0 0-2-2z",key:"1ymkrd"}]],Tt=k("quote",Ot);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ft=[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]],Rt=k("zoom-in",Ft);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qt=[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]],Ht=k("zoom-out",qt),U="https://edicuatex.github.io";function Z(j,s){const b=[],_=(r,d)=>{const $=ct.renderToString(r.trim(),{throwOnError:!1,displayMode:d}),y=`%%MATH_${b.length}%%`;return b.push({token:y,html:$}),y};let m=s;m=m.replace(/\\\[((?:.|\n)+?)\\\]/g,(r,d)=>_(d,!0)),m=m.replace(/\$\$([\s\S]+?)\$\$/g,(r,d)=>_(d,!0)),m=m.replace(/\\\((.+?)\\\)/g,(r,d)=>_(d,!1)),m=m.replace(/\$([\s\S]+?)\$/g,(r,d)=>_(d,!1));let w=dt.parse(m);b.forEach(({token:r,html:d})=>{w=w.replace(r,d)}),j.innerHTML=w}const Xt=({instanceId:j})=>{const{t:s,i18n:b,ready:_}=ot(),m=c.useRef(j??`markdown-text-editor-${Date.now()}-${Math.random().toString(16).slice(2)}`),w=j??m.current,[r,d]=c.useState(s("widgets.markdown_text_editor.sample_content")),[$,y]=c.useState(""),[v,E]=c.useState(""),[C,O]=c.useState("split"),[S,X]=c.useState(1),u=c.useRef(null),W=c.useRef(null),T=c.useRef(null),p=c.useRef(null),G=c.useMemo(()=>{const t=new URL(`${U}/index.html`);return t.searchParams.set("pm","1"),t.searchParams.set("origin",window.location.origin),t},[]);c.useEffect(()=>{const t=s("widgets.markdown_text_editor.sample_content");t!=="widgets.markdown_text_editor.sample_content"&&d(t)},[s,b.language]),c.useEffect(()=>{const t=T.current;if(t)return document.body.appendChild(t),()=>{t.parentNode&&t.parentNode.removeChild(t)}},[]);const F=t=>{y(t),setTimeout(()=>y(""),1800)},R=t=>{const n=Math.min(2.5,Math.max(.75,t));X(n)},g=(t,n)=>{const o=u.current;o&&requestAnimationFrame(()=>{o.focus(),o.setSelectionRange(t,n)})},z=(t,n,o)=>{const a=u.current;if(!a)return;const i=a.selectionStart,l=a.selectionEnd,h=r.slice(i,l)||o,f=`${r.slice(0,i)}${t}${h}${n}${r.slice(l)}`;d(f),g(i+t.length,i+t.length+h.length)},q=t=>{const n=u.current;if(!n)return;const o=n.selectionStart,a=n.selectionEnd,i=r,l=i.lastIndexOf(`
`,o-1)+1,x=i.indexOf(`
`,a),h=x===-1?i.length:x,P=i.slice(l,h).split(`
`),N=P.every(M=>M.startsWith(t)),I=P.map(M=>N?M.slice(t.length):`${t}${M}`).join(`
`),L=`${i.slice(0,l)}${I}${i.slice(h)}`;d(L);const D=l+I.length;g(D,D)},H=t=>{const n=`${"#".repeat(t)} `,o=u.current;if(!o)return;const a=o.selectionStart,i=r,l=i.lastIndexOf(`
`,a-1)+1,x=i.indexOf(`
`,a),h=x===-1?i.length:x,f=i.slice(l,h),N=f.startsWith(n)?f.slice(n.length):`${n}${f}`,I=`${i.slice(0,l)}${N}${i.slice(h)}`;d(I);const L=l+N.length;g(L,L)},K=()=>{const t=u.current;if(!t)return;const n=t.selectionStart,o=t.selectionEnd,a=r.slice(n,o)||s("widgets.markdown_text_editor.placeholders.code"),i="```\n",x=`${r.slice(0,n)}${i}${a}
\`\`\`${r.slice(o)}`;d(x),g(n+i.length,n+i.length+a.length)},Q=()=>{const t=u.current;if(!t)return;const n=t.selectionStart,o=t.selectionEnd,a=r.slice(n,o)||s("widgets.markdown_text_editor.placeholders.link_text"),i=window.prompt(s("widgets.markdown_text_editor.prompts.link_url"));if(!i)return;const l=`[${a}](${i})`,x=`${r.slice(0,n)}${l}${r.slice(o)}`;d(x),g(n+1,n+1+a.length)},A=c.useCallback(t=>{const n=u.current;if(!n)return;const o=n.selectionStart,a=n.selectionEnd;d(i=>`${i.slice(0,o)}${t}${i.slice(a)}`),g(o+t.length,o+t.length)},[]),Y=()=>{navigator.clipboard.writeText(r).then(()=>F(s("widgets.markdown_text_editor.source_copied"))).catch(()=>F(s("widgets.markdown_text_editor.copy_failed")))},V=async()=>{const t=new Blob([r],{type:"text/markdown;charset=utf-8"}),n=s("widgets.markdown_text_editor.default_filename"),o=await lt(n);if(!o)return;o?.destination==="file-manager"?await ut({blob:t,filename:o.filename,sourceWidgetId:"markdown-text-editor",sourceWidgetTitleKey:"widgets.markdown_text_editor.title",parentId:o.parentId}):o?.destination==="download"&&mt(t,o.filename);const a=JSON.stringify({input:r});E(a),window.dispatchEvent(new CustomEvent("widget-save-complete",{detail:{instanceId:w,widgetId:"markdown-text-editor"}}))},B=async t=>{const n=await t.text();d(n),E(JSON.stringify({input:n}))},tt=async()=>{const t=await wt({accept:".md,.txt"});if(!t)return;if(t.source==="local"){const[i]=t.files;i&&await B(i);return}const[n]=t.entryIds;if(!n)return;const o=await J(n);if(!o?.blob)return;const a=new File([o.blob],o.name,{type:o.mime||o.blob.type});await B(a)},et=async()=>{const t=T.current;if(!t)return;Z(t,r);try{await document.fonts?.ready}catch{}await new Promise(o=>requestAnimationFrame(()=>o()));const n=()=>{t.innerHTML="",window.removeEventListener("afterprint",n)};window.addEventListener("afterprint",n),window.print()},nt=()=>{const t=u.current?u.current.value.slice(u.current.selectionStart,u.current.selectionEnd).trim():"",n=new URL(G.toString());if(t&&n.searchParams.set("sel",t),p.current&&!p.current.closed){p.current.focus();return}const o=window.open(n.toString(),"edicuatex","width=1100,height=800,menubar=no,toolbar=no,location=no,status=no");if(!o){F(s("widgets.markdown_text_editor.popup_blocked"));return}p.current=o};return c.useEffect(()=>{const t=n=>{if(n.origin!==U||!n.data||n.data.type!=="edicuatex:result")return;const o=n.data,a=o.latex?`$$${o.latex}$$`:"",i=o.wrapped||a;i&&(A(i),p.current&&!p.current.closed&&p.current.close(),p.current=null)};return window.addEventListener("message",t),()=>window.removeEventListener("message",t)},[A]),c.useEffect(()=>{const t=W.current;if(t)try{Z(t,r)}catch(n){const o=n instanceof Error?n.message:s("widgets.markdown_text_editor.preview_error");t.innerHTML=`<div class="error-message">${o}</div>`}},[r,s]),c.useEffect(()=>{v||E(JSON.stringify({input:r}))},[r,v]),c.useEffect(()=>st("markdown-text-editor",async({entryId:n})=>{const o=await J(n);if(!o?.blob)return;const a=await o.blob.text();d(a),E(JSON.stringify({input:a}))}),[]),c.useEffect(()=>{const t=JSON.stringify({input:r}),n=v!==""&&t!==v;window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:w,widgetId:"markdown-text-editor",isDirty:n}}))},[r,v,w]),c.useEffect(()=>{const t=n=>{const o=n;o.detail?.instanceId===w&&(o.detail?.widgetId&&o.detail.widgetId!=="markdown-text-editor"||V())};return window.addEventListener("widget-save-request",t),()=>window.removeEventListener("widget-save-request",t)},[V,w]),c.useEffect(()=>()=>{window.dispatchEvent(new CustomEvent("widget-dirty-state",{detail:{instanceId:w,widgetId:"markdown-text-editor",isDirty:!1}}))},[w]),_?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`markdown-text-editor-widget view-${C}`,style:{"--md-zoom":S},children:[e.jsxs("div",{className:"markdown-toolbar",children:[e.jsxs("div",{className:"markdown-toolbar-group",children:[e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.bold"),onClick:()=>z("**","**",s("widgets.markdown_text_editor.placeholders.text")),children:e.jsx(xt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.italic"),onClick:()=>z("*","*",s("widgets.markdown_text_editor.placeholders.text")),children:e.jsx(pt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.strike"),onClick:()=>z("~~","~~",s("widgets.markdown_text_editor.placeholders.text")),children:e.jsx(ht,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.h1"),onClick:()=>H(1),children:e.jsx(kt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.h2"),onClick:()=>H(2),children:e.jsx(_t,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.h3"),onClick:()=>H(3),children:e.jsx(gt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.bullet_list"),onClick:()=>q("- "),children:e.jsx(ft,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.ordered_list"),onClick:()=>q("1. "),children:e.jsx(bt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.quote"),onClick:()=>q("> "),children:e.jsx(Tt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.inline_code"),onClick:()=>z("`","`",s("widgets.markdown_text_editor.placeholders.code")),children:e.jsx(vt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.code_block"),onClick:K,children:e.jsx(zt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.link"),onClick:Q,children:e.jsx(Mt,{size:16})})]}),e.jsxs("div",{className:"markdown-toolbar-group",children:[$&&e.jsx("span",{className:"feedback-message",children:$}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.view_split"),onClick:()=>O("split"),className:C==="split"?"is-active":"",children:e.jsx(It,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.view_editor"),onClick:()=>O("editor"),className:C==="editor"?"is-active":"",children:e.jsx(yt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.view_preview"),onClick:()=>O("preview"),className:C==="preview"?"is-active":"",children:e.jsx(jt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.zoom_out"),onClick:()=>R(S-.1),children:e.jsx(Ht,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.zoom_in"),onClick:()=>R(S+.1),children:e.jsx(Rt,{size:16})}),e.jsxs("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.zoom_reset"),onClick:()=>R(1),className:"zoom-reset",children:[Math.round(S*100),"%"]}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.formula"),onClick:nt,children:e.jsx(it,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.copy_source"),onClick:Y,children:e.jsx(Ct,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.open_file"),onClick:tt,children:e.jsx(rt,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.save_file"),onClick:V,children:e.jsx($t,{size:16})}),e.jsx("button",{type:"button",title:s("widgets.markdown_text_editor.toolbar.export_pdf"),onClick:et,children:e.jsx(at,{size:16})})]})]}),e.jsxs("div",{className:"markdown-body",children:[e.jsxs("div",{className:"markdown-pane markdown-editor-pane",children:[e.jsx("div",{className:"markdown-pane-header",children:s("widgets.markdown_text_editor.editor_title")}),e.jsx("textarea",{ref:u,value:r,onChange:t=>d(t.target.value),spellCheck:!0,className:"editor-textarea"})]}),e.jsxs("div",{className:"markdown-pane markdown-preview-pane",children:[e.jsx("div",{className:"markdown-pane-header",children:s("widgets.markdown_text_editor.preview_title")}),e.jsx("div",{className:"preview-pane prose",ref:W})]})]})]}),e.jsx("div",{id:"markdown-text-editor-print",ref:T,className:"prose"})]}):e.jsx("div",{className:"flex items-center justify-center h-full",children:s("loading")})};export{Xt as MarkdownTextEditorWidget,Qt as widgetConfig};
